<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup - ⚡Lunatic BLOG⚡</title><meta name=author content="Lunatic"><meta name=description content="这两天打了 2024 DubheCTF 后突然感觉自己之前学的东西只不过是皮毛中的皮毛
感觉还得是靠打这些难度比较高的比赛来督促自己学习新东西
"><meta name=keywords content='CTF,Misc,Writeup'><meta itemprop=name content="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup"><meta itemprop=description content="这两天打了 2024 DubheCTF 后突然感觉自己之前学的东西只不过是皮毛中的皮毛
感觉还得是靠打这些难度比较高的比赛来督促自己学习新东西"><meta itemprop=datePublished content="2024-03-19T16:58:01+08:00"><meta itemprop=dateModified content="2024-03-19T16:58:01+08:00"><meta itemprop=wordCount content="607"><meta itemprop=keywords content="CTF,Misc,Writeup"><meta property="og:url" content="https://goodlunatic.github.io/posts/10f4f96/"><meta property="og:site_name" content="⚡Lunatic BLOG⚡"><meta property="og:title" content="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup"><meta property="og:description" content="这两天打了 2024 DubheCTF 后突然感觉自己之前学的东西只不过是皮毛中的皮毛
感觉还得是靠打这些难度比较高的比赛来督促自己学习新东西"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-19T16:58:01+08:00"><meta property="article:modified_time" content="2024-03-19T16:58:01+08:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Misc"><meta property="article:tag" content="Writeup"><meta name=twitter:card content="summary"><meta name=twitter:title content="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup"><meta name=twitter:description content="这两天打了 2024 DubheCTF 后突然感觉自己之前学的东西只不过是皮毛中的皮毛
感觉还得是靠打这些难度比较高的比赛来督促自己学习新东西"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://goodlunatic.github.io/posts/10f4f96/ title="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup - ⚡Lunatic BLOG⚡"><link rel=prev type=text/html href=https://goodlunatic.github.io/posts/aa61ddd/ title="2024 VCTF Misc Writeup"><link rel=next type=text/html href=https://goodlunatic.github.io/posts/bd957c3/ title="2024 长城杯信息安全铁人三项赛 Misc Writeup"><link rel=alternate type=text/markdown href=https://goodlunatic.github.io/posts/10f4f96/index.md title="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup - ⚡Lunatic BLOG⚡"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/goodlunatic.github.io\/posts\/10f4f96\/"},"genre":"posts","keywords":"CTF, Misc, Writeup","wordcount":607,"url":"https:\/\/goodlunatic.github.io\/posts\/10f4f96\/","datePublished":"2024-03-19T16:58:01+08:00","dateModified":"2024-03-19T16:58:01+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Lunatic"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> Friends</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> Friends</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=Collections></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://goodlunatic.github.io title=Author target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png alt=Lunatic height=16 width=16>&nbsp;Lunatic</a></span><span class=post-included-in>&nbsp;included in <a href=/categories/writeup/ class=post-category title="Category - Writeup"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Writeup</a></span></div><div class=post-meta-line><span title="published on 2024-03-19 16:58:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-03-19>2024-03-19</time></span>&nbsp;<span title="607 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>About 700 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>3 minutes</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup"><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#题目名称-cipher>题目名称 Cipher</a></li><li><a href=#题目名称-authenticated-mess--unauthenticated-less>题目名称 authenticated mess & unauthenticated less</a></li></ul></nav></div></div><div class=content id=content><p><strong>这两天打了 2024 DubheCTF 后突然感觉自己之前学的东西只不过是皮毛中的皮毛</strong></p><p><strong>感觉还得是靠打这些难度比较高的比赛来督促自己学习新东西</strong></p><h2 class=heading-element id=题目名称-cipher><span>题目名称 Cipher</span>
<a href=#%e9%a2%98%e7%9b%ae%e5%90%8d%e7%a7%b0-cipher class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p><strong>从这道题入手，由浅入深学习一下Windows自带的 Cipher 加密（EFS加密算法）</strong></p><p><strong>用磁盘精灵打开vhd文件，在public目录下看到一个加密的flag.jpg</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702165941080.png alt=/posts/10f4f96/imgs/image-20240702165941080.png height=1600 width=2560></p><p><strong>直接装载到本地，可以发现还是加密的，根据题目名字 cipher 得知应该是用windows自带的 cipher 加密了</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702165948532.png alt=/posts/10f4f96/imgs/image-20240702165948532.png height=988 width=1143></p><p><strong>赛后根据参考链接：</strong></p><p><a href=https://support.microsoft.com/zh-cn/topic/cipher-exe-%e5%ae%89%e5%85%a8%e5%b7%a5%e5%85%b7-%e7%94%a8%e4%ba%8e%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f-56c85edd-85cf-ac07-f2f7-ca2d35dab7e4 target=_blank rel="external nofollow noopener noreferrer">https://support.microsoft.com/zh-cn/topic/cipher-exe-%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7-%E7%94%A8%E4%BA%8E%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-56c85edd-85cf-ac07-f2f7-ca2d35dab7e4</a></p><p><strong>得知cipher用的是EFS加密</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702165959549.png alt=/posts/10f4f96/imgs/image-20240702165959549.png height=1222 width=1572></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170107939.png alt=/posts/10f4f96/imgs/image-20240702170107939.png height=422 width=1537></p><p><strong>根据参考链接：</strong></p><p><a href=https://cloud.tencent.com/developer/article/1549305 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1549305</a></p><p>我们现在很容易可以知道，题目的考点就是要我们找私钥和主密钥了</p><p>从详细信息中可以知道该文件的所有者是mark，所以之后的步骤就需要把目光聚焦到用户mark的目录下了</p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170118054.png alt=/posts/10f4f96/imgs/image-20240702170118054.png height=1013 width=1519></p><p><strong>对照着参考链接：</strong>
<a href=https://blog.csdn.net/shuaicenglou3032/article/details/131184510 target=_blank rel="external nofollow noopener noreferrer">https://blog.csdn.net/shuaicenglou3032/article/details/131184510</a></p><p><strong>在 E:\Users\mark\AppData\Roaming\Microsoft 路径下成功找到这两个密钥</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170125868.png alt=/posts/10f4f96/imgs/image-20240702170125868.png height=815 width=1346></p><p><strong>赛后看了别的师傅的writeup，知道了用户的powershell历史记录会在这个路径下</strong></p><p><strong>\Users\test\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</strong></p><p><strong>在test用户的目录中找到了各个用户的密码，知道mark用户的密码是superman</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170134461.png alt=/posts/10f4f96/imgs/image-20240702170134461.png height=821 width=1054></p><p><strong>如果有 Advanced efs data recovery 这个工具的破解版的话，这道题到这里就结束了</strong></p><p><strong>直接用这个工具扫描磁盘获取两个密钥和加密文件，然后输入mark用户的密码 superman 即可解密得到flag</strong></p><p><strong>这里贴一张山海关的大佬成功解密的图片</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170141937.png alt=/posts/10f4f96/imgs/image-20240702170141937.png height=566 width=1307></p><p><strong>然而因为这个软件我全网都没有找到能用的破解版，官网的试用版只能解密部分内容</strong></p><p><strong>因此接下来我要深入分析一下手搓解密EFS的方法</strong>
<strong>参考链接如下(只能说Lilac的Misc手太强了。。。)：</strong></p><p><a href=https://lilachit.notion.site/Lilac-2024DubheCTF-wp-caa603fa40ba4699982a13ddf062906a#1b970b22b5e04cb98a5e02cb2f688a4a target=_blank rel="external nofollow noopener noreferrer">https://lilachit.notion.site/Lilac-2024DubheCTF-wp-caa603fa40ba4699982a13ddf062906a#1b970b22b5e04cb98a5e02cb2f688a4a</a></p><p><strong>首先，假设我们之前不知道test用户的powershell历史记录中有各个用户的密码</strong>
<strong>因此这里我们就需要先用 DPAPImk2john.py+John the Ripper 去爆破出mark用户的密码</strong></p><p>DPAPI是Windows操作系统中的一种加密功能，用于保护用户敏感数据，例如用户的登录密码、浏览器保存的密码等。DPAPImk2john.py脚本可以提取这些被DPAPI加密的凭据，并将其转换为John the Ripper密码破解工具所支持的格式，以便进行密码破解或分析操作。</p><p><strong>先用DPAPImk2john.py脚本获取DPAPI的Hash值</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170153372.png alt=/posts/10f4f96/imgs/image-20240702170153372.png height=421 width=1734></p><p><strong>然后将hash.txt拉到 kali 或者直接在 Windows 中用 john 根据 rockyou.txt 字典进行爆破</strong></p><p><strong>爆破完即可得到密码是 superman</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170200258.png alt=/posts/10f4f96/imgs/image-20240702170200258.png height=438 width=1353></p><p><strong>得到 mark 的密码后，就可以使用 Mimikatz 爆破 Masterkeys 了</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170208521.png alt=/posts/10f4f96/imgs/image-20240702170208521.png height=1173 width=2541></p>masterkey<p>with password: superman (normal user)</p><p>key : 168f6183d9d7d4aeb3b21aed8d683d1593997723050ec47619c6b9650fd54e49ef0c31707f22e1b189bb65a0b5a96061fa95f0415b3fa8429598f94a52a80756</p><p>sha1: f354189efecfb4629ae66ae862ad4fa0ae1fdaa3</p><p><strong>本人目前水平有限，这里就先贴一份Lilac大佬写的脚本吧，脚本解密完即可得到flag</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.hazmat.primitives</span> <span class=kn>import</span> <span class=n>serialization</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.hazmat.primitives.asymmetric</span> <span class=kn>import</span> <span class=n>padding</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.hazmat.primitives.ciphers</span> <span class=kn>import</span> <span class=n>Cipher</span><span class=p>,</span> <span class=n>algorithms</span><span class=p>,</span> <span class=n>modes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;private.pem&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>key_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>serialization</span><span class=o>.</span><span class=n>load_pem_private_key</span><span class=p>(</span><span class=n>key_file</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span> <span class=n>password</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;$EFS&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>EFS_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>efs</span> <span class=o>=</span> <span class=n>EFS_file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>typedef struct
</span></span></span><span class=line><span class=cl><span class=s1>{
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		AttributeLength;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		State;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		Version;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		CryptoAPIVersion;
</span></span></span><span class=line><span class=cl><span class=s1>	BYTE		Checksum[16];
</span></span></span><span class=line><span class=cl><span class=s1>	BYTE		ChecksumDDF[16];
</span></span></span><span class=line><span class=cl><span class=s1>	BYTE		ChecksumDRF[16];
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		OffsetToDDF;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		OffsetToDRF;
</span></span></span><span class=line><span class=cl><span class=s1>} MFT_RECORD_ATTRIBUTE_EFS_HEADER, * PMFT_RECORD_ATTRIBUTE_EFS_HEADER;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>OffsetToDDF</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>efs</span><span class=p>[</span><span class=mh>0x40</span><span class=p>:</span><span class=mh>0x44</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;OffsetToDDF: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>OffsetToDDF</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>typedef struct {
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		Count;
</span></span></span><span class=line><span class=cl><span class=s1>} MFT_RECORD_ATTRIBUTE_EFS_ARRAY_HEADER, * PMFT_RECORD_ATTRIBUTE_EFS_ARRAY_HEADER;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Count</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>efs</span><span class=p>[</span><span class=n>OffsetToDDF</span><span class=p>:</span><span class=n>OffsetToDDF</span><span class=o>+</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Count: </span><span class=si>{</span><span class=n>Count</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>Count</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;Count != 1 unsupported for now&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>typedef struct {
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		Length;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		CredentialHeaderOffset;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		FEKSize;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD		FEKOffset;
</span></span></span><span class=line><span class=cl><span class=s1>} MFT_RECORD_ATTRIBUTE_EFS_DATA_DECRYPTION_ENTRY_HEADER, * PMFT_RECORD_ATTRIBUTE_EFS_DATA_DECRYPTION_ENTRY_HEADER;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>entry_header</span> <span class=o>=</span> <span class=n>efs</span><span class=p>[</span><span class=n>OffsetToDDF</span><span class=o>+</span><span class=mi>4</span><span class=p>:</span><span class=n>OffsetToDDF</span><span class=o>+</span><span class=mi>4</span><span class=o>+</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Length</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>entry_header</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Length: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>Length</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CredentialHeaderOffset</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>entry_header</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;CredentialHeaderOffset: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>CredentialHeaderOffset</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>FEKSize</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>entry_header</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;FEKSize: </span><span class=si>{</span><span class=n>FEKSize</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>FEKOffset</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>entry_header</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=mi>16</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>OffsetToDDF</span> <span class=o>+</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;FEKOffset: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>FEKOffset</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>encrypted_fek</span> <span class=o>=</span> <span class=n>efs</span><span class=p>[</span><span class=n>FEKOffset</span><span class=p>:</span><span class=n>FEKOffset</span><span class=o>+</span><span class=n>FEKSize</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>decrypted_fek</span> <span class=o>=</span> <span class=n>private_key</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_fek</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=n>padding</span><span class=o>.</span><span class=n>PKCS1v15</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>typedef struct {
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD	KeyLength;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD	Entropy;
</span></span></span><span class=line><span class=cl><span class=s1>	ALG_ID	Algorithm;
</span></span></span><span class=line><span class=cl><span class=s1>	DWORD	Reserved;
</span></span></span><span class=line><span class=cl><span class=s1>	BYTE	Key[1];
</span></span></span><span class=line><span class=cl><span class=s1>} EFS_FEK, * PEFS_FEK;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>KeyLength</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>decrypted_fek</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;KeyLength: </span><span class=si>{</span><span class=n>KeyLength</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Algorithm</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>decrypted_fek</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Algorithm: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>Algorithm</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>decrypted_fek</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>16</span><span class=o>+</span><span class=n>KeyLength</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=mi>16</span> <span class=o>+</span> <span class=n>KeyLength</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>decrypted_fek</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_block</span><span class=p>(</span><span class=n>data_block</span><span class=p>,</span> <span class=n>fek_key</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>cluster_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\0</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>offset</span> <span class=o>=</span> <span class=n>index</span> <span class=o>*</span> <span class=n>cluster_size</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>iv</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>iv</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>16</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=n>algorithms</span><span class=o>.</span><span class=n>AES</span><span class=p>(</span><span class=n>fek_key</span><span class=p>),</span> <span class=n>modes</span><span class=o>.</span><span class=n>CBC</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>iv</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>decryptor</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decryptor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decryptor</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>data_block</span><span class=p>)</span> <span class=o>+</span> <span class=n>decryptor</span><span class=o>.</span><span class=n>finalize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_file</span><span class=p>(</span><span class=n>input_file_path</span><span class=p>,</span> <span class=n>output_file_path</span><span class=p>,</span> <span class=n>fek_key</span><span class=p>,</span> <span class=n>cluster_size</span><span class=o>=</span><span class=mi>4096</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>input_file_path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>input_file</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file_path</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>output_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>index_block</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data_block</span> <span class=o>=</span> <span class=n>input_file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>cluster_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>data_block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=n>decrypted_data</span> <span class=o>=</span> <span class=n>decrypt_block</span><span class=p>(</span><span class=n>data_block</span><span class=p>,</span> <span class=n>fek_key</span><span class=p>,</span> <span class=n>index_block</span><span class=p>,</span> <span class=n>cluster_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>output_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>decrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>index_block</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>decrypt_file</span><span class=p>(</span><span class=s1>&#39;flag.jpg.enc&#39;</span><span class=p>,</span> <span class=s1>&#39;flag.jpg&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>终于找到能用的盗版软件了！附上最后成功得到 flag 的截图</strong></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20240702170245129.png alt=/posts/10f4f96/imgs/image-20240702170245129.png height=1026 width=1259></p><p>贴一个破解版软件的下载链接：https://www.anxz.com/down/69148.html</p><h2 class=heading-element id=题目名称-authenticated-mess--unauthenticated-less><span>题目名称 authenticated mess & unauthenticated less</span>
<a href=#%e9%a2%98%e7%9b%ae%e5%90%8d%e7%a7%b0-authenticated-mess--unauthenticated-less class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>从这道题来浅浅学一下 VMessAEAD 的加密方式</p><p>题目给了一个 pcapng 的流量包文件，一开始以为是和 2022强网杯-谍影重重一样的 VMessMD5 加密的流量分析，需要爆破时间戳</p><p>赛后看了题解才发现不是，这道题是 VMessAEAD 的加密方式（也是现在版本的 v2ray-core 强制的加密方式）</p><p>用wireshark翻流量可以得到一个 v2ray 的 json 配置文件，也是从这里确定了是VMess流量分析</p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20241018140800820.png alt=/posts/10f4f96/imgs/image-20241018140800820.png height=1058 width=1317></p><p>赛后看了出题人的题解后，发现出题人已经写了一个专门用来解析 VMessAEAD 的 Python 库</p><p>Python 库的开源地址：https://github.com/mnixry/vmess-aead-python</p><p>这里就直接用出题人写好的库进行解析了</p><p>Tips：调用这个库需要使用 Python3.10 以上的版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>vmess_aead.encoding</span> <span class=kn>import</span> <span class=n>VMessBodyEncoder</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>vmess_aead.headers.request</span> <span class=kn>import</span> <span class=n>VMessAEADRequestPacketHeader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>vmess_aead.utils.reader</span> <span class=kn>import</span> <span class=n>BytesReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=s2>&#34;a49502ee07ffdd20f11597e961f7768b41be7bc32030107fc81f235f72ff1b294d074ade94281242412b4c19123b15250ac3d5ad9524df9acd0ee5f6dcca7b0c2849b2f4df20190dd084c01c3f6e2834dd87cb8e97fa178b2ec454755f89d9b735ae6dab9c7989cf4154f7eae53774d9d6cdb55d0a76fdaf21e08bae26e49cbb3c56d11a3fe540454bfbae06305460301caca4109df3335b0c3646b6e2d856a927f9298b87da3a7cf3cffcca6c27259fc055faa9f3155cc95f698bb37436008783b6cd03d38a8e109f78a48c860b600fcbe825cd6c6a5be2c95fce121df574c70fe62e4f24e28de5983db6c3c0192d72ec785b6d58c4b8301c4f70eab683&#34;</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>reader</span> <span class=o>=</span> <span class=n>BytesReader</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>user_id</span> <span class=o>=</span> <span class=n>uuid</span><span class=o>.</span><span class=n>UUID</span><span class=p>(</span><span class=s2>&#34;f3a5cae3-6bd2-40d1-b13b-2cc3d87af2c7&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>header</span> <span class=o>=</span> <span class=n>VMessAEADRequestPacketHeader</span><span class=o>.</span><span class=n>from_packet</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>encoder</span> <span class=o>=</span> <span class=n>VMessBodyEncoder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>body_key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>body_iv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>security</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>command</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>body</span> <span class=o>=</span> <span class=n>encoder</span><span class=o>.</span><span class=n>decode_once</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>body</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>解析了流量中的数据后可以得到一个图片的地址：</p><p><a href=https://p.sda1.dev/16/11c111ee40a928d5d751dd5869414093/__p0.png target=_blank rel="external nofollow noopener noreferrer">https://p.sda1.dev/16/11c111ee40a928d5d751dd5869414093/__p0.png</a></p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20241018140830066.png alt=/posts/10f4f96/imgs/image-20241018140830066.png height=369 width=1889></p><p>用 zsteg 一扫发现图片末尾有一个压缩包，用 foremost 提取出来后发现需要密码</p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20241018140839709.png alt=/posts/10f4f96/imgs/image-20241018140839709.png height=1615 width=2564></p><p>这里可以去 saucenao 搜这个图片得到密码 116921220</p><p>Tips：这个纯数字密码因为是9位，所以用弱密码爆破的可行性不高，需要爆破好久</p><p>之前某个比赛也遇到过这种，解密的密钥需要去 pixiv 上获取【可恶的二次元】</p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20241018140855956.png alt=/posts/10f4f96/imgs/image-20241018140855956.png height=509 width=1920></p><p>解压压缩包后得到一个项目的源码</p><p>后面的考点就主要是 Web 方向的了—— EdTunnel，Wrangler 和 SSRF</p><p>先查看 docker-compose.yml 发现存在一个 edtunnel 服务</p><p><img loading=lazy src=/posts/10f4f96/imgs/image-20241018140906583.png alt=/posts/10f4f96/imgs/image-20241018140906583.png height=1319 width=2546></p><p>这个服务的相关内容来自：https://github.com/3Kmfi6HP/EDtunnel</p><p>出题人只对 UUID 和默认路由进行了更改</p><p>edtunnel 是一个开源的轻量级反向隧道工具，用于穿越防火墙和网络限制，建立安全的网络连接。</p><p>它提供了一种简单的方式，允许用户在两个网络之间建立加密的隧道连接。</p><p>赛后看了参考的wp知道了 EdTunnel 是通过 Wrangler 本地的开发模式部署的</p><p>然后 Wrangler 有一个 SSRF 的漏洞 CVE-2023-7080</p><p>后续就是用 v2ray 使用 exp-config.json 将端口暴露到本地</p><p>然后用浏览器连接到这个端口，在 内存快照 中可以打出堆快照，flag就藏在这里</p><p><strong>参考链接：</strong></p><ul><li><a href="https://github.com/mix-archive/MessyStack?tab=readme-ov-file" target=_blank rel="external nofollow noopener noreferrer">https://github.com/mix-archive/MessyStack?tab=readme-ov-file</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Updated on 2024-03-19 16:58:01">Updated on 2024-03-19&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/10f4f96/index.md title="Read Markdown" class=link-to-markdown>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=twitter data-url=https://goodlunatic.github.io/posts/10f4f96/ data-title="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup" data-hashtags=CTF,Misc,Writeup><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://goodlunatic.github.io/posts/10f4f96/ data-hashtag=CTF><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://goodlunatic.github.io/posts/10f4f96/ data-title="2024 XCTF国际网络攻防联赛-DubheCTF分站赛 Misc Writeup"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/ctf/ class=post-tag title="Tags - CTF">CTF</a><a href=/tags/misc/ class=post-tag title="Tags - Misc">Misc</a><a href=/tags/writeup/ class=post-tag title="Tags - Writeup">Writeup</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/aa61ddd/ class=post-nav-item rel=prev title="2024 VCTF Misc Writeup"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>2024 VCTF Misc Writeup</a><a href=/posts/bd957c3/ class=post-nav-item rel=next title="2024 长城杯信息安全铁人三项赛 Misc Writeup">2024 长城杯信息安全铁人三项赛 Misc Writeup<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label=Contents><h2 class=toc-title>Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.1">Hugo</a> | Theme - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.0-alpha.2-20251023040336-063af2cd">FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://goodlunatic.github.io target=_blank rel="external nofollow noopener noreferrer">Lunatic</a></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title='Total visitors'><i class="fa-regular fa-user fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title='Total visits'><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><div id=mask></div><noscript><div class=noscript-warning>This website works best with JavaScript enabled.</div></noscript></div><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=https://vercount.one/js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script src=/posts/10f4f96/config/page.js defer></script><script src=/js/theme.min.js defer></script></body></html>